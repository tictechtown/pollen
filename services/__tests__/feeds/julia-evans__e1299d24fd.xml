<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Julia Evans]]></title>
  <link href="https://jvns.ca/atom.xml" rel="self"/>
  <link href="https://jvns.ca"/>
  <updated>2025-11-05T00:00:00+00:00</updated>
  <id>http://jvns.ca</id>
  <author>
      <name>Julia Evans</name>
  </author>
  <generator uri="http://gohugo.io/">Hugo</generator>

  
  <entry>
    <title type="html"><![CDATA[Notes on switching to Helix from vim]]></title>
    <link href="https://jvns.ca/blog/2025/10/10/notes-on-switching-to-helix-from-vim/"/>
    <updated>2025-10-10T00:00:00+00:00</updated>
    <id>https://jvns.ca/blog/2025/10/10/notes-on-switching-to-helix-from-vim/</id>
    <content type="html"><![CDATA[<p>Hello! Earlier this summer I was talking to a friend about how much I
<a href="https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/">love using fish</a>, and
how I love that I don&rsquo;t have to configure it. They said that they feel the same
way about the <a href="https://helix-editor.com/">helix</a> text editor, and so I decided
to give it a try.</p>
<p>I&rsquo;ve been using it for 3 months now and here are a few notes.</p>
<h3 id="why-helix-language-servers">why helix: language servers</h3>
<p>I think what motivated me to try Helix is that I&rsquo;ve been trying to get a working
language server setup (so I can do things like &ldquo;go to definition&rdquo;) and getting
a setup that feels good in Vim or Neovim just felt like too much work.</p>
<p>After using Vim/Neovim for 20 years, I&rsquo;ve tried both &ldquo;build my own custom
configuration from scratch&rdquo; and &ldquo;use someone else&rsquo;s pre-buld configuration
system&rdquo; and even though I love Vim I was excited about having things just work
without having to work on my configuration at all.</p>
<p>Helix comes with built in language server support, and it feels nice
to be able to do things like &ldquo;rename this symbol&rdquo; in any language.</p>
<h3 id="the-search-is-great">the search is great</h3>
<p>One of my favourite things about Helix is the search! If I&rsquo;m searching all the
files in my repository for a string, it lets me scroll through the potential
matching files and see the full context of the match, like this:</p>
<img src="/images/helix-search.png">
<p>For comparison, here&rsquo;s what the vim ripgrep plugin I&rsquo;ve been using looks like:</p>
<img src="/images/vim-ripgrep.png">
<p>There&rsquo;s no context for what else is around that line.</p>
<h3 id="the-quick-reference-is-nice">the quick reference is nice</h3>
<p>One thing I like about Helix is that when I press <code>g</code>, I get a little help popup
telling me places I can go. I really appreciate this because I don&rsquo;t often use
the &ldquo;go to definition&rdquo; or &ldquo;go to reference&rdquo; feature and I often forget the
keyboard shortcut.</p>
<img src="/images/goto.png" width="300px">
<h3 id="some-vim-helix-translations">some vim -&gt; helix translations</h3>
<ul>
<li>Helix doesn&rsquo;t have marks like <code>ma</code>, <code>'a</code>, instead I&rsquo;ve been using <code>Ctrl+O</code> and
<code>Ctrl+I</code> to go back (or forward) to the last cursor location</li>
<li>I think Helix does have macros, but I&rsquo;ve been using multiple cursors in every
case that I would have previously used a macro. I like multiple cursors a lot
more than writing macros all the time. If I want to batch change something in
the document, my workflow is to press <code>%</code> (to highlight everything), then <code>s</code>
to select (with a regex) the things I want to change, then I can just edit
all of them as needed.</li>
<li>Helix doesn&rsquo;t have neovim-style tabs, instead it has a nice buffer switcher (<code>&lt;space&gt;b</code>)
I can use to switch to the buffer I want. There&rsquo;s a
<a href="https://github.com/helix-editor/helix/pull/7109">pull request here</a> to implement neovim-style tabs.
There&rsquo;s also a setting <code>bufferline=&quot;multiple&quot;</code> which can act a bit like tabs
with <code>gp</code>, <code>gn</code> for prev/next &ldquo;tab&rdquo; and <code>:bc</code> to close a &ldquo;tab&rdquo;.</li>
</ul>
<h3 id="some-helix-annoyances">some helix annoyances</h3>
<p>Here&rsquo;s everything that&rsquo;s annoyed me about Helix so far.</p>
<ul>
<li>I like the way Helix&rsquo;s <code>:reflow</code> works much less than how
vim reflows text with <code>gq</code>. It doesn&rsquo;t work as well with lists. (<a href="https://github.com/helix-editor/helix/issues/3332">github issue</a>)</li>
<li>If I&rsquo;m making a Markdown list, pressing &ldquo;enter&rdquo; at the end of a list item
won&rsquo;t continue the list. There&rsquo;s a <a href="https://github.com/helix-editor/helix/wiki/Recipes#continue-markdown-lists--quotes">partial workaround</a>
for bulleted lists but I don&rsquo;t know one for numbered lists.</li>
<li>No persistent undo yet: in vim I could use an
<a href="https://vimdoc.sourceforge.net/htmldoc/options.html#'undofile'">undofile</a> so
that I could undo changes even after quitting. Helix doesn&rsquo;t have that feature yet.
(<a href="https://github.com/helix-editor/helix/pull/9154">github PR</a>)</li>
<li>Helix doesn&rsquo;t autoreload files after they change on disk, I have to run
<code>:reload-all</code> (<code>:ra&lt;tab&gt;</code>) to manually reload them. Not a big deal.</li>
<li>Sometimes it crashes, maybe every week or so. I think it might be
<a href="https://github.com/helix-editor/helix/issues/12582">this issue</a>.</li>
</ul>
<p>The &ldquo;markdown list&rdquo; and reflowing issues come up a lot for me because I spend
a lot of time editing Markdown lists, but I keep using Helix anyway so I guess
they can&rsquo;t be making me that mad.</p>
<h3 id="switching-was-easier-than-i-thought">switching was easier than I thought</h3>
<p>I was worried that relearning 20 years of Vim muscle memory would be really hard.</p>
<p>It turned out to be easier than I expected, I started using Helix on a
vacation for a little low-stakes coding project I was doing on the side and
after a week or two it didn&rsquo;t feel so disorienting anymore. I think it might be
hard to switch back and forth between Vim and Helix, but I haven&rsquo;t needed to use
Vim recently so I don&rsquo;t know if that&rsquo;ll ever become an issue for me.</p>
<p>The first time I tried Helix I tried to force it to use keybindings that were
more similar to Vim and that did not work for me. Just learning the &ldquo;Helix way&rdquo;
was a lot easier.</p>
<p>There are still some things that throw me off: for example <code>w</code> in vim and <code>w</code> in
Helix don&rsquo;t have the same idea of what a &ldquo;word&rdquo; is (the Helix one includes the
space after the word, the Vim one doesn&rsquo;t).</p>
<h3 id="using-a-terminal-based-text-editor">using a terminal-based text editor</h3>
<p>For many years I&rsquo;d mostly been using a GUI version of vim/neovim, so switching
to actually using an editor in the terminal was a bit of an adjustment.</p>
<p>I ended up deciding on:</p>
<ol>
<li>Every project gets its own terminal window, and all of the tabs in that
window (mostly) have the same working directory</li>
<li>I make my Helix tab the first tab in the terminal window</li>
</ol>
<p>It works pretty well, I might actually like it better than my previous workflow.</p>
<h3 id="my-configuration">my configuration</h3>
<p>I appreciate that my configuration is really simple, compared to my neovim
configuration which is hundreds of lines. It&rsquo;s mostly just 4 keyboard
shortcuts.</p>
<pre><code>theme = &quot;solarized_light&quot;
[editor]
# Sync clipboard with system clipboard
default-yank-register = &quot;+&quot;

[keys.normal]
# I didn't like that Ctrl+C was the default &quot;toggle comments&quot; shortcut
&quot;#&quot; = &quot;toggle_comments&quot;

# I didn't feel like learning a different way
# to go to the beginning/end of a line so
# I remapped ^ and $
&quot;^&quot; = &quot;goto_first_nonwhitespace&quot;
&quot;$&quot; = &quot;goto_line_end&quot;

[keys.select]
&quot;^&quot; = &quot;goto_first_nonwhitespace&quot;
&quot;$&quot; = &quot;goto_line_end&quot;

[keys.normal.space]
# I write a lot of text so I need to constantly reflow,
# and missed vim's `gq` shortcut
l = &quot;:reflow&quot;
</code></pre>
<p>There&rsquo;s a separate <code>languages.toml</code> configuration where I set some language
preferences, like turning off autoformatting.
For example, here&rsquo;s my Python configuration:</p>
<pre><code>[[language]]
name = &quot;python&quot;
formatter = { command = &quot;black&quot;, args = [&quot;--stdin-filename&quot;, &quot;%{buffer_name}&quot;, &quot;-&quot;] }
language-servers = [&quot;pyright&quot;]
auto-format = false
</code></pre>
<h3 id="we-ll-see-how-it-goes">we&rsquo;ll see how it goes</h3>
<p>Three months is not that long, and it&rsquo;s possible that I&rsquo;ll decide to go back
to Vim at some point. For example, I wrote a <a href="https://jvns.ca/blog/2023/02/28/some-notes-on-using-nix/">post about switching to
nix</a> a while back but
after maybe 8 months I switched back to Homebrew (though I&rsquo;m still using NixOS
to manage one little server, and I&rsquo;m still satisfied with that).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New zine: The Secret Rules of the Terminal]]></title>
    <link href="https://jvns.ca/blog/2025/06/24/new-zine--the-secret-rules-of-the-terminal/"/>
    <updated>2025-06-26T00:00:00+00:00</updated>
    <id>https://jvns.ca/blog/2025/06/24/new-zine--the-secret-rules-of-the-terminal/</id>
    <content type="html"><![CDATA[<p>Hello! After many months of writing deep dive blog posts about the terminal, on
Tuesday I released a new zine called &ldquo;The Secret Rules of the Terminal&rdquo;!</p>
<p>You can get it for $12 here:
<a href="https://wizardzines.com/zines/terminal">https://wizardzines.com/zines/terminal</a>, or get
an <a href="https://wizardzines.com/zines/all-the-zines/">15-pack of all my zines here</a>.</p>
<p>Here&rsquo;s the cover:</p>
<div align="center">
<a href="https://wizardzines.com/zines/terminal">
  <img width="600px" src="https://jvns.ca/images/terminal-cover-small.jpg">
  </a>
</div>
<h3 id="the-table-of-contents">the table of contents</h3>
<p>Here&rsquo;s the table of contents:</p>
<a href="https://wizardzines.com/zines/terminal/toc.png">
  <img width="600px" src="https://jvns.ca/images/terminal-toc-small.png">
</a>
<h3 id="why-the-terminal">why the terminal?</h3>
<p>I&rsquo;ve been using the terminal every day for 20 years but even though I&rsquo;m very
confident in the terminal, I&rsquo;ve always had a bit of an uneasy feeling about it.
Usually things work fine, but sometimes something goes wrong and it just feels
like investigating it is impossible, or at least like it would open up a huge
can of worms.</p>
<p>So I started trying to write down a list of weird problems I&rsquo;ve run into in terminal and I realized
that the terminal has a lot of tiny inconsistencies like:</p>
<ul>
<li>sometimes you can use the arrow keys to move around, but sometimes pressing the arrow keys just prints <code>^[[D</code></li>
<li>sometimes you can use the mouse to select text, but sometimes you can&rsquo;t</li>
<li>sometimes your commands get saved to a history when you run them, and sometimes they don&rsquo;t</li>
<li>some shells let you use the up arrow to see the previous command, and some don&rsquo;t</li>
</ul>
<p>If you use the terminal daily for 10 or 20 years, even if you don&rsquo;t understand
exactly <em>why</em> these things happen, you&rsquo;ll probably build an intuition for them.</p>
<p>But having an intuition for them isn&rsquo;t the same as understanding why they
happen. When writing this zine I actually had to do a lot of work to figure out
exactly what was <em>happening</em> in the terminal to be able to talk about how to
reason about it.</p>
<h3 id="the-rules-aren-t-written-down-anywhere">the rules aren&rsquo;t written down anywhere</h3>
<p>It turns out that the &ldquo;rules&rdquo; for how the terminal works (how do
you edit a command you type in? how do you quit a program? how do you fix your
colours?) are extremely hard to fully understand, because &ldquo;the terminal&rdquo; is actually
made of many different pieces of software (your terminal emulator, your
operating system, your shell, the core utilities like <code>grep</code>, and every other random
terminal program you&rsquo;ve installed) which are written by different people with different
ideas about how things should work.</p>
<p>So I wanted to write something that would explain:</p>
<ul>
<li>how the 4 pieces of the terminal (your shell, terminal emulator, programs, and TTY driver) fit together to make everything work</li>
<li>some of the core conventions for how you can expect things in your terminal to work</li>
<li>lots of tips and tricks for how to use terminal programs</li>
</ul>
<h3 id="this-zine-explains-the-most-useful-parts-of-terminal-internals">this zine explains the most useful parts of terminal internals</h3>
<p>Terminal internals are a mess. A lot of it is just the way it is because
someone made a decision in the 80s and now it&rsquo;s impossible to change, and
honestly I don&rsquo;t think learning everything about terminal internals is worth
it.</p>
<p>But some parts are not that hard to understand and can really make your
experience in the terminal better, like:</p>
<ul>
<li>if you understand what <strong>your shell</strong> is responsible for, you can configure your shell (or use a different one!) to access your history more easily, get great tab completion, and so much more</li>
<li>if you understand <strong>escape codes</strong>, it&rsquo;s much less scary when <code>cat</code>ing a binary to stdout messes up your terminal, you can just type <code>reset</code> and move on</li>
<li>if you understand how <strong>colour</strong> works, you can get rid of bad colour contrast in your terminal so you can actually read the text</li>
</ul>
<h3 id="i-learned-a-surprising-amount-writing-this-zine">I learned a surprising amount writing this zine</h3>
<p>When I wrote <a href="https://wizardzines.com/zines/git">How Git Works</a>, I thought I
knew how Git worked, and I was right. But the terminal is different. Even
though I feel totally confident in the terminal and even though I&rsquo;ve used it
every day for 20 years, I had a lot of misunderstandings about how the terminal
works and (unless you&rsquo;re the author of <code>tmux</code> or something) I think there&rsquo;s a
good chance you do too.</p>
<p>A few things I learned that are actually useful to me:</p>
<ul>
<li>I understand the structure of the terminal better and so I feel more
confident debugging weird terminal stuff that happens to me (I was even able
to suggest a <a href="https://github.com/fish-shell/fish-shell/issues/10834">small improvement</a> to fish!). Identifying exactly which piece of software is causing a weird thing to happen in my terminal still isn&rsquo;t <em>easy</em> but I&rsquo;m a lot better at it now.</li>
<li>you can write a shell script to <a href="https://jvns.ca/til/vim-osc52/">copy to your clipboard over SSH</a></li>
<li>how <code>reset</code> works under the hood (it does the equivalent of <code>stty sane; sleep 1; tput reset</code>) – basically I learned that I don&rsquo;t ever need to worry about
remembering <code>stty sane</code> or <code>tput reset</code> and I can just run <code>reset</code> instead</li>
<li>how to look at the invisible escape codes that a program is printing out (run <code>unbuffer program &gt; out; less out</code>)</li>
<li>why the builtin REPLs on my Mac like <code>sqlite3</code> are so annoying to use (they use <code>libedit</code> instead of <code>readline</code>)</li>
</ul>
<h3 id="blog-posts-i-wrote-along-the-way">blog posts I wrote along the way</h3>
<p>As usual these days I wrote a bunch of blog posts about various side quests:</p>
<ul>
<li><a href="https://jvns.ca/blog/2025/02/13/how-to-add-a-directory-to-your-path/">How to add a directory to your PATH</a></li>
<li><a href="https://jvns.ca/blog/2024/11/26/terminal-rules/">&ldquo;rules&rdquo; that terminal problems follow</a></li>
<li><a href="https://jvns.ca/blog/2024/11/29/why-pipes-get-stuck-buffering/">why pipes sometimes get &ldquo;stuck&rdquo;: buffering</a></li>
<li><a href="https://jvns.ca/blog/2025/02/05/some-terminal-frustrations/">some terminal frustrations</a></li>
<li><a href="https://jvns.ca/blog/2024/10/31/ascii-control-characters/">ASCII control characters in my terminal</a> on &ldquo;what&rsquo;s the deal with Ctrl+A, Ctrl+B, Ctrl+C, etc?&rdquo;</li>
<li><a href="https://jvns.ca/blog/2024/07/08/readline/">entering text in the terminal is complicated</a></li>
<li><a href="https://jvns.ca/blog/2025/01/11/getting-a-modern-terminal-setup/">what&rsquo;s involved in getting a &ldquo;modern&rdquo; terminal setup?</a></li>
<li><a href="https://jvns.ca/blog/2024/07/03/reasons-to-use-job-control/">reasons to use your shell&rsquo;s job control</a></li>
<li><a href="https://jvns.ca/blog/2025/03/07/escape-code-standards/">standards for ANSI escape codes</a>, which is really me trying to figure out if I think the <code>terminfo</code> database is serving us well today</li>
</ul>
<h3 id="people-who-helped-with-this-zine">people who helped with this zine</h3>
<p>A long time ago I used to write zines mostly by myself but with every project I get more
and more help. I met with <a href="https://marieflanagan.com">Marie Claire LeBlanc Flanagan</a> every weekday from September to June to work
on this one.</p>
<p>The cover is by Vladimir Kašiković,
Lesley Trites did copy editing,
Simon Tatham (who wrote <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/">PuTTY</a>) did technical review, our
Operations Manager Lee did the transcription as well as a million other
things, and <a href="https://github.com/doy">Jesse Luehrs</a> (who is one of the very few
people I know who actually understands the terminal&rsquo;s cursed inner workings)
had so many incredibly helpful conversations with me about what is going on in
the terminal.</p>
<h3 id="get-the-zine">get the zine</h3>
<p>Here are some links to get the zine again:</p>
<ul>
<li>get <a href="https://wizardzines.com/zines/terminal">The Secret Rules of the Terminal</a></li>
<li>get a <a href="https://wizardzines.com/zines/all-the-zines/">15-pack of all my zines here</a>.</li>
</ul>
<p>As always, you can get either a PDF version to print at home or a print version
shipped to your house. The only caveat is print orders will ship in <strong>August</strong> &ndash; I
need to wait for orders to come in to get an idea of how many I should print
before sending it to the printer.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using `make` to compile C programs (for non-C-programmers)]]></title>
    <link href="https://jvns.ca/blog/2025/06/10/how-to-compile-a-c-program/"/>
    <updated>2025-06-10T00:00:00+00:00</updated>
    <id>https://jvns.ca/blog/2025/06/10/how-to-compile-a-c-program/</id>
    <content type="html"><![CDATA[<p>I have never been a C programmer but every so often I need to compile a C/C++
program from source. This has been kind of a struggle for me: for a
long time, my approach was basically &ldquo;install the dependencies, run <code>make</code>, if
it doesn&rsquo;t work, either try to find a binary someone has compiled or give up&rdquo;.</p>
<p>&ldquo;Hope someone else has compiled it&rdquo; worked pretty well when I was running Linux
but since I&rsquo;ve been using a Mac for the last couple of years I&rsquo;ve been running
into more situations where I have to actually compile programs myself.</p>
<p>So let&rsquo;s talk about what you might have to do to compile a C program! I&rsquo;ll use
a couple of examples of specific C programs I&rsquo;ve compiled and talk about a few
things that can go wrong. Here are three programs we&rsquo;ll be talking about
compiling:</p>
<ul>
<li><a href="https://mj.ucw.cz/sw/paperjam/">paperjam</a></li>
<li><a href="https://www.sqlite.org/download.html">sqlite</a></li>
<li><a href="https://git.causal.agency/src/tree/bin/qf.c">qf</a> (a pager you can run to quickly open files from a search with <code>rg -n THING | qf</code>)</li>
</ul>
<h3 id="step-1-install-a-c-compiler">step 1: install a C compiler</h3>
<p>This is pretty simple: on an Ubuntu system if I don&rsquo;t already have a C compiler I&rsquo;ll install one with:</p>
<pre><code>sudo apt-get install build-essential
</code></pre>
<p>This installs <code>gcc</code>, <code>g++</code>, and <code>make</code>. The situation on a Mac is more
confusing but it&rsquo;s something like &ldquo;install xcode command line tools&rdquo;.</p>
<h3 id="step-2-install-the-program-s-dependencies">step 2: install the program&rsquo;s dependencies</h3>
<p>Unlike some newer programming languages, C doesn&rsquo;t have a dependency manager.
So if a program has any dependencies, you need to hunt them down yourself.
Thankfully because of this, C programmers usually keep their dependencies very
minimal and often the dependencies will be available in whatever package manager you&rsquo;re using.</p>
<p>There&rsquo;s almost always a section explaining how to get the dependencies in the
README, for example in <a href="https://mj.ucw.cz/sw/paperjam/">paperjam</a>&rsquo;s README, it
says:</p>
<blockquote>
<p>To compile PaperJam, you need the headers for the libqpdf and libpaper libraries (usually available as libqpdf-dev and libpaper-dev packages).</p>
</blockquote>
<blockquote>
<p>You may need <code>a2x</code> (found in <a href="http://www.methods.co.nz/asciidoc/a2x.1.html">AsciiDoc</a>) for building manual pages.</p>
</blockquote>
<p>So on a Debian-based system you can install the dependencies like this.</p>
<pre><code>sudo apt install -y libqpdf-dev libpaper-dev
</code></pre>
<p>If a README gives a name for a package (like <code>libqpdf-dev</code>), I&rsquo;d basically
always assume that they mean &ldquo;in a Debian-based Linux distro&rdquo;: if you&rsquo;re on a
Mac <code>brew install libqpdf-dev</code> will not work. I still have not 100% gotten
the hang of developing on a Mac yet so I don&rsquo;t have many tips there yet. I
guess in this case it would be <code>brew install qpdf</code> if you&rsquo;re using Homebrew.</p>
<h3 id="step-3-run-configure-if-needed">step 3: run <code>./configure</code> (if needed)</h3>
<p>Some C programs come with a <code>Makefile</code> and some instead come with a script called
<code>./configure</code>. For example, if you download <a href="https://www.sqlite.org/download.html">sqlite&rsquo;s source code</a>, it has a <code>./configure</code> script in
it instead of a Makefile.</p>
<p>My understanding of this <code>./configure</code> script is:</p>
<ol>
<li>You run it, it prints out a lot of somewhat inscrutable output, and then it
either generates a <code>Makefile</code> or fails because you&rsquo;re missing some
dependency</li>
<li>The <code>./configure</code> script is part of a system called
<a href="https://www.gnu.org/software/automake/manual/html_node/Autotools-Introduction.html">autotools</a>
that I have never needed to learn anything about beyond &ldquo;run it to generate
a <code>Makefile</code>&rdquo;.</li>
</ol>
<p>I think there might be some options you can pass to get the <code>./configure</code>
script to produce a different <code>Makefile</code> but I have never done that.</p>
<h3 id="step-4-run-make">step 4: run <code>make</code></h3>
<p>The next step is to run <code>make</code> to try to build a program. Some notes about
<code>make</code>:</p>
<ul>
<li>Sometimes you can run <code>make -j8</code> to parallelize the build and make it go
faster</li>
<li>It usually prints out a million compiler warnings when compiling the program.
I always just ignore them. I didn&rsquo;t write the software! The compiler warnings
are not my problem.</li>
</ul>
<h3 id="compiler-errors-are-often-dependency-problems">compiler errors are often dependency problems</h3>
<p>Here&rsquo;s an error I got while compiling <code>paperjam</code> on my Mac:</p>
<pre><code>/opt/homebrew/Cellar/qpdf/12.0.0/include/qpdf/InputSource.hh:85:19: error: function definition does not declare parameters
   85 |     qpdf_offset_t last_offset{0};
      |                   ^
</code></pre>
<p>Over the years I&rsquo;ve learned it&rsquo;s usually best not to overthink problems like
this: if it&rsquo;s talking about <code>qpdf</code>, there&rsquo;s a good change it just means that
I&rsquo;ve done something wrong with how I&rsquo;m including the <code>qpdf</code> dependency.</p>
<p>Now let&rsquo;s talk about some ways to get the <code>qpdf</code> dependency included in the right way.</p>
<h3 id="the-world-s-shortest-introduction-to-the-compiler-and-linker">the world&rsquo;s shortest introduction to the compiler and linker</h3>
<p>Before we talk about how to fix dependency problems: building C programs is split into 2
steps:</p>
<ol>
<li><strong>Compiling</strong> the code into <strong>object files</strong> (with <code>gcc</code> or <code>clang</code>)</li>
<li><strong>Linking</strong> those object files into a final binary (with <code>ld</code>)</li>
</ol>
<p>It&rsquo;s important to know this when building a C program because sometimes you
need to pass the right flags to the compiler and linker to tell them where to
find the dependencies for the program you&rsquo;re compiling.</p>
<h3 id="make-uses-environment-variables-to-configure-the-compiler-and-linker"><code>make</code> uses environment variables to configure the compiler and linker</h3>
<p>If I run <code>make</code> on my Mac to install <code>paperjam</code>, I get this error:</p>
<pre><code>c++ -o paperjam paperjam.o pdf-tools.o parse.o cmds.o pdf.o -lqpdf -lpaper
ld: library 'qpdf' not found
</code></pre>
<p>This is not because <code>qpdf</code> is not installed on my system (it actually is!). But
the compiler and linker don&rsquo;t know how to <em>find</em> the <code>qpdf</code> library. To fix this, we need to:</p>
<ul>
<li>pass <code>&quot;-I/opt/homebrew/include&quot;</code> to the compiler (to tell it where to find the header files)</li>
<li>pass <code>&quot;-L/opt/homebrew/lib -liconv&quot;</code> to the linker (to tell it where to find library files and to link in <code>iconv</code>)</li>
</ul>
<p>And we can get <code>make</code> to pass those extra parameters to the compiler and linker using environment variables!
To see how this works: inside <code>paperjam</code>&rsquo;s Makefile you can see a bunch of environment variables, like <code>LDLIBS</code> here:</p>
<pre><code>paperjam: $(OBJS)
	$(LD) -o $@ $^ $(LDLIBS)
</code></pre>
<p>Everything you put into the <code>LDLIBS</code> environment variable gets passed to the
linker (<code>ld</code>) as a command line argument.</p>
<h3 id="secret-environment-variable-cppflags">secret environment variable: <code>CPPFLAGS</code></h3>
<p><code>Makefiles</code> sometimes define their own environment variables that they pass to
the compiler/linker, but <code>make</code> also has a bunch of &ldquo;implicit&rdquo; environment
variables which it will automatically pass to the C compiler and linker. There&rsquo;s a <a href="https://www.gnu.org/software/make/manual/html_node/Implicit-Variables.html#index-CFLAGS0">full list of implicit environment variables here</a>,
but one of them is <code>CPPFLAGS</code>, which gets automatically passed to the C compiler.</p>
<p>(technically it would be more normal to use <code>CXXFLAGS</code> for this, but this
particular <code>Makefile</code> hardcodes <code>CXXFLAGS</code> so setting <code>CPPFLAGS</code> was the only
way I could find to set the compiler flags without editing the <code>Makefile</code>)</p>
<small>
As an aside: it took me a long time to realize how closely tied to C/C++ `make` is -- I used
to think that `make` was just a general build system (and of course you can use it for
anything!) but it has a lot of affordances for building C/C++ programs that it
doesn't have for building any other kind of program.
</small>
<h3 id="two-ways-to-pass-environment-variables-to-make">two ways to pass environment variables to <code>make</code></h3>
<p>I learned thanks to <a href="https://www.owlfolio.org/">@zwol</a> that there are actually two ways to pass environment variables to <code>make</code>:</p>
<ol>
<li><code>CXXFLAGS=xyz make</code> (the usual way)</li>
<li><code>make CXXFLAGS=xyz</code></li>
</ol>
<p>The difference between them is that <code>make CXXFLAGS=xyz</code> will override the
value of <code>CXXFLAGS</code> set in the <code>Makefile</code> but <code>CXXFLAGS=xyz make</code> won&rsquo;t.</p>
<p>I&rsquo;m not sure which way is the norm but I&rsquo;m going to use the first way in this
post.</p>
<h3 id="how-to-use-cppflags-and-ldlibs-to-fix-this-compiler-error">how to use <code>CPPFLAGS</code> and <code>LDLIBS</code> to fix this compiler error</h3>
<p>Now that we&rsquo;ve talked about how <code>CPPFLAGS</code> and <code>LDLIBS</code> get passed to the
compiler and linker, here&rsquo;s the final incantation that I used to get the
program to build successfully!</p>
<pre><code>CPPFLAGS=&quot;-I/opt/homebrew/include&quot; LDLIBS=&quot;-L/opt/homebrew/lib -liconv&quot; make paperjam
</code></pre>
<p>This passes <code>-I/opt/homebrew/include</code> to the compiler and <code>-L/opt/homebrew/lib -liconv</code> to the linker.</p>
<p>Also I don&rsquo;t want to pretend that I &ldquo;magically&rdquo; knew that those were the right
arguments to pass, figuring them out involved a bunch of confused Googling that I
skipped over in this post. I will say that:</p>
<ul>
<li>the <code>-I</code> compiler flag tells the compiler which directory to find header files in, like <code>/opt/homebrew/include/qpdf/QPDF.hh</code></li>
<li>the <code>-L</code> linker flag tells the linker which directory to find libraries in, like <code>/opt/homebrew/lib/libqpdf.a</code></li>
<li>the <code>-l</code> linker flag tells the linker which libraries to link in, like <code>-liconv</code> means &ldquo;link in the <code>iconv</code> library&rdquo;, or <code>-lm</code> means &ldquo;link <code>math</code>&rdquo;</li>
</ul>
<h3 id="tip-how-to-just-build-1-specific-file-make-filename">tip: how to just build 1 specific file: <code>make $FILENAME</code></h3>
<p>Yesterday I discovered this cool tool called
<a href="https://git.causal.agency/src/tree/bin/qf.c">qf</a> which you can use to quickly
open files from the output of <code>ripgrep</code>.</p>
<p><code>qf</code> is in a big directory of various tools, but I only wanted to compile <code>qf</code>.
So I just compiled <code>qf</code>, like this:</p>
<pre><code>make qf
</code></pre>
<p>Basically if you know (or can guess) the output filename of the file you&rsquo;re
trying to build, you can tell <code>make</code> to just build that file by running <code>make $FILENAME</code></p>
<h3 id="tip-you-don-t-need-a-makefile">tip: you don&rsquo;t need a Makefile</h3>
<p>I sometimes write 5-line C programs with no dependencies, and I just learned
that if I have a file called <code>blah.c</code>, I can just compile it like this without creating a <code>Makefile</code>:</p>
<pre><code>make blah
</code></pre>
<p>It gets automaticaly expanded to <code>cc -o blah blah.c</code>, which saves a bit of
typing. I have no idea if I&rsquo;m going to remember this (I might just keep typing
<code>gcc -o blah blah.c</code> anyway) but it seems like a fun trick.</p>
<h3 id="tip-look-at-how-other-packaging-systems-built-the-same-c-program">tip: look at how other packaging systems built the same C program</h3>
<p>If you&rsquo;re having trouble building a C program, maybe other people had problems building it
too! Every Linux distribution has build files for every package that they
build, so even if you can&rsquo;t install packages from that distribution directly,
maybe you can get tips from that Linux distro for how to build the package.
Realizing this (thanks to my friend Dave) was a huge ah-ha moment for me.</p>
<p>For example, <a href="https://github.com/NixOS/nixpkgs/blob/405624e81a9b65378328accb0a11c3e5369e651c/pkgs/by-name/pa/paperjam/package.nix#L35">this line from the nix package for <code>paperjam</code></a> says:</p>
<pre><code>  env.NIX_LDFLAGS = lib.optionalString stdenv.hostPlatform.isDarwin &quot;-liconv&quot;;
</code></pre>
<p>This is basically saying &ldquo;pass the linker flag <code>-liconv</code> to build this on a
Mac&rdquo;, so that&rsquo;s a clue we could use to build it.</p>
<p>That same file also says <code>  env.NIX_CFLAGS_COMPILE = &quot;-DPOINTERHOLDER_TRANSITION=1&quot;;</code>. I&rsquo;m not sure what this means, but when I try
to build the <code>paperjam</code> package I do get an error about something called a
<code>PointerHolder</code>, so I guess that&rsquo;s somehow related to the &ldquo;PointerHolder
transition&rdquo;.</p>
<h3 id="step-5-installing-the-binary">step 5: installing the binary</h3>
<p>Once you&rsquo;ve managed to compile the program, probably you want to install it somewhere!
Some <code>Makefile</code>s have an <code>install</code> target that let you install the tool on your
system with <code>make install</code>. I&rsquo;m always a bit scared of this (where is it going
to put the files? what if I want to uninstall them later?), so if I&rsquo;m compiling
a pretty simple program I&rsquo;ll often just manually copy the binary to install it
instead, like this:</p>
<pre><code>cp qf ~/bin
</code></pre>
<h3 id="step-6-maybe-make-your-own-package">step 6: maybe make your own package!</h3>
<p>Once I figured out how to do all of this, I realized that I could use my new
<code>make</code> knowledge to contribute a <code>paperjam</code> package to Homebrew! Then I could
just <code>brew install paperjam</code> on future systems.</p>
<p>The good thing is that even if the details of how all of the different
packaging systems, they fundamentally all use C compilers and linkers.</p>
<h3 id="it-can-be-useful-to-understand-a-little-about-c-even-if-you-re-not-a-c-programmer">it can be useful to understand a little about C even if you&rsquo;re not a C programmer</h3>
<p>I think all of this is an interesting example of how it can useful to
understand some basics of how C programs work (like &ldquo;they have header files&rdquo;)
even if you&rsquo;re never planning to write a nontrivial C program if your life.</p>
<p>It feels good to have some ability to compile C/C++ programs myself, even
though I&rsquo;m still not totally confident about all of the compiler and linker
flags and I still plan to never learn anything about how autotools works other
than &ldquo;you run <code>./configure</code> to generate the <code>Makefile</code>&rdquo;.</p>
<p>Two things I left out of this post:</p>
<ul>
<li><code>LD_LIBRARY_PATH / DYLD_LIBRARY_PATH</code> (which you use to tell the dynamic
linker at runtime where to find dynamically linked files) because I can&rsquo;t
remember the last time I ran into an <code>LD_LIBRARY_PATH</code> issue and couldn&rsquo;t
find an example.</li>
<li><code>pkg-config</code>, which I think is important but I don&rsquo;t understand yet</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Standards for ANSI escape codes]]></title>
    <link href="https://jvns.ca/blog/2025/03/07/escape-code-standards/"/>
    <updated>2025-03-07T00:00:00+00:00</updated>
    <id>https://jvns.ca/blog/2025/03/07/escape-code-standards/</id>
    <content type="html"><![CDATA[<p>Hello! Today I want to talk about ANSI escape codes.</p>
<p>For a long time I was vaguely aware of ANSI escape codes (&ldquo;that&rsquo;s how you make
text red in the terminal and stuff&rdquo;) but I had no real understanding of where they were
supposed to be defined or whether or not there were standards for them. I just
had a kind of vague &ldquo;there be dragons&rdquo; feeling around them. While learning
about the terminal this year, I&rsquo;ve learned that:</p>
<ol>
<li>ANSI escape codes are responsible for a lot of usability improvements
in the terminal (did you know there&rsquo;s a way to copy to your system clipboard
when SSHed into a remote machine?? It&rsquo;s an escape code called <a href="https://jvns.ca/til/vim-osc52/">OSC 52</a>!)</li>
<li>They aren&rsquo;t completely standardized, and because of that they don&rsquo;t always
work reliably. And because they&rsquo;re also invisible, it&rsquo;s extremely
frustrating to troubleshoot escape code issues.</li>
</ol>
<p>So I wanted to put together a list for myself of some standards that exist
around escape codes, because I want to know if they <em>have</em> to feel unreliable
and frustrating, or if there&rsquo;s a future where we could all rely on them with
more confidence.</p>
<ul>
<li><a href="#what-s-an-escape-code">what&rsquo;s an escape code?</a></li>
<li><a href="#ecma-48">ECMA-48</a></li>
<li><a href="#xterm-control-sequences">xterm control sequences</a></li>
<li><a href="#terminfo">terminfo</a></li>
<li><a href="#should-programs-use-terminfo">should programs use terminfo?</a></li>
<li><a href="#is-there-a-single-common-set-of-escape-codes">is there a &ldquo;single common set&rdquo; of escape codes?</a></li>
<li><a href="#some-reasons-to-use-terminfo">some reasons to use terminfo</a></li>
<li><a href="#some-more-documents-standards">some more documents/standards</a></li>
<li><a href="#why-i-think-this-is-interesting">why I think this is interesting</a></li>
</ul>
<h3 id="what-s-an-escape-code">what&rsquo;s an escape code?</h3>
<p>Have you ever pressed the left arrow key in your terminal and seen <code>^[[D</code>?
That&rsquo;s an escape code! It&rsquo;s called an &ldquo;escape code&rdquo; because the first character
is the &ldquo;escape&rdquo; character, which is usually written as <code>ESC</code>, <code>\x1b</code>, <code>\E</code>,
<code>\033</code>, or <code>^[</code>.</p>
<p>Escape codes are how your terminal emulator communicates various kinds of
information (colours, mouse movement, etc) with programs running in the
terminal. There are two kind of escape codes:</p>
<ol>
<li><strong>input codes</strong> which your terminal emulator sends for keypresses or mouse
movements that don&rsquo;t fit into Unicode. For example &ldquo;left arrow key&rdquo; is
<code>ESC[D</code>, &ldquo;Ctrl+left arrow&rdquo; might be <code>ESC[1;5D</code>, and clicking the mouse might
be something like <code>ESC[M :3</code>.</li>
<li><strong>output codes</strong> which programs can print out to colour text, move the
cursor around, clear the screen, hide the cursor, copy text to the
clipboard, enable mouse reporting, set the window title, etc.</li>
</ol>
<p>Now let&rsquo;s talk about standards!</p>
<h3 id="ecma-48">ECMA-48</h3>
<p>The first standard I found relating to escape codes was
<a href="https://ecma-international.org/wp-content/uploads/ECMA-48_5th_edition_june_1991.pdf">ECMA-48</a>,
which was originally published in 1976.</p>
<p>ECMA-48 does two things:</p>
<ol>
<li>Define some general <em>formats</em> for escape codes (like &ldquo;CSI&rdquo; codes, which are
<code>ESC[</code> + something and &ldquo;OSC&rdquo; codes, which are <code>ESC]</code> + something)</li>
<li>Define some specific escape codes, like how &ldquo;move the cursor to the left&rdquo; is
<code>ESC[D</code>, or &ldquo;turn text red&rdquo; is  <code>ESC[31m</code>. In the spec, the &ldquo;cursor left&rdquo;
one is called <code>CURSOR LEFT</code> and the one for changing colours is called
<code>SELECT GRAPHIC RENDITION</code>.</li>
</ol>
<p>The formats are extensible, so there&rsquo;s room for others to define more escape
codes in the future. Lots of escape codes that are popular today aren&rsquo;t defined
in ECMA-48: for example it&rsquo;s pretty common for terminal applications (like vim,
htop, or tmux) to support using the mouse, but ECMA-48 doesn&rsquo;t define escape
codes for the mouse.</p>
<h3 id="xterm-control-sequences">xterm control sequences</h3>
<p>There are a bunch of escape codes that aren&rsquo;t defined in ECMA-48, for example:</p>
<ul>
<li>enabling mouse reporting (where did you click in your terminal?)</li>
<li>bracketed paste (did you paste that text or type it in?)</li>
<li>OSC 52 (which terminal applications can use to copy text to your system clipboard)</li>
</ul>
<p>I believe (correct me if I&rsquo;m wrong!) that these and some others came from
xterm, are documented in <a href="https://invisible-island.net/xterm/ctlseqs/ctlseqs.html">XTerm Control Sequences</a>, and have
been widely implemented by other terminal emulators.</p>
<p>This list of &ldquo;what xterm supports&rdquo; is not a standard exactly, but xterm is
extremely influential and so it seems like an important document.</p>
<h3 id="terminfo">terminfo</h3>
<p>In the 80s (and to some extent today, but my understanding is that it was MUCH
more dramatic in the 80s) there was a huge amount of variation in what escape
codes terminals actually supported.</p>
<p>To deal with this, there&rsquo;s a database of escape codes for various terminals
called &ldquo;terminfo&rdquo;.</p>
<p>It looks like the standard for terminfo is called <a href="https://publications.opengroup.org/c243-1">X/Open Curses</a>, though you need to create
an account to view that standard for some reason. It defines the database format as well
as a C library interface (&ldquo;curses&rdquo;) for accessing the database.</p>
<p>For example you can run this bash snippet to see every possible escape code for
&ldquo;clear screen&rdquo; for all of the different terminals your system knows about:</p>
<pre><code>for term in $(toe -a | awk '{print $1}')
do
  echo $term
  infocmp -1 -T &quot;$term&quot; 2&gt;/dev/null | grep 'clear=' | sed 's/clear=//g;s/,//g'
done
</code></pre>
<p>On my system (and probably every system I&rsquo;ve ever used?), the terminfo database is managed by ncurses.</p>
<h3 id="should-programs-use-terminfo">should programs use terminfo?</h3>
<p>I think it&rsquo;s interesting that there are two main approaches that applications
take to handling ANSI escape codes:</p>
<ol>
<li>Use the terminfo database to figure out which escape codes to use, depending
on what&rsquo;s in the <code>TERM</code> environment variable. Fish does this, for example.</li>
<li>Identify a &ldquo;single common set&rdquo; of escape codes which works in &ldquo;enough&rdquo;
terminal emulators and just hardcode those.</li>
</ol>
<p>Some examples of programs/libraries that take approach #2 (&ldquo;don&rsquo;t use terminfo&rdquo;) include:</p>
<ul>
<li><a href="https://github.com/mawww/kakoune/commit/c12699d2e9c2806d6ed184032078d0b84a3370bb">kakoune</a></li>
<li><a href="https://github.com/prompt-toolkit/python-prompt-toolkit/blob/165258d2f3ae594b50f16c7b50ffb06627476269/src/prompt_toolkit/input/ansi_escape_sequences.py#L5-L8">python-prompt-toolkit</a></li>
<li><a href="https://github.com/antirez/linenoise">linenoise</a></li>
<li><a href="https://github.com/rockorager/libvaxis">libvaxis</a></li>
<li><a href="https://github.com/chalk/chalk">chalk</a></li>
</ul>
<p>I got curious about why folks might be moving away from terminfo and I found
this very interesting and extremely detailed
<a href="https://twoot.site/@bean/113056942625234032">rant about terminfo from one of the fish maintainers</a>, which argues that:</p>
<blockquote>
<p>[the terminfo authors] have done a lot of work that, at the time, was
extremely important and helpful. My point is that it no longer is.</p>
</blockquote>
<p>I&rsquo;m not going to do it justice so I&rsquo;m not going to summarize it, I think it&rsquo;s
worth reading.</p>
<h3 id="is-there-a-single-common-set-of-escape-codes">is there a &ldquo;single common set&rdquo; of escape codes?</h3>
<p>I was just talking about the idea that you can use a &ldquo;common set&rdquo; of escape
codes that will work for most people. But what is that set? Is there any agreement?</p>
<p>I really do not know the answer to this at all, but from doing some reading it
seems like it&rsquo;s some combination of:</p>
<ul>
<li>The codes that the VT100 supported (though some aren&rsquo;t relevant on modern terminals)</li>
<li>what&rsquo;s in ECMA-48 (which I think also has some things that are no longer relevant)</li>
<li>What xterm supports (though I&rsquo;d guess that not everything in there is actually widely supported enough)</li>
</ul>
<p>and maybe ultimately &ldquo;identify the terminal emulators you think your users are
going to use most frequently and test in those&rdquo;, the same way web developers do
when deciding which CSS features are okay to use</p>
<p>I don&rsquo;t think there are any resources like <a href="https://caniuse.com/">Can I use&hellip;?</a> or
<a href="https://web-platform-dx.github.io/web-features/">Baseline</a> for the terminal
though. (in theory terminfo is supposed to be the &ldquo;caniuse&rdquo; for the terminal
but it seems like it often takes 10+ years to add new terminal features when
people invent them which makes it very limited)</p>
<h3 id="some-reasons-to-use-terminfo">some reasons to use terminfo</h3>
<p>I also asked on Mastodon why people found terminfo valuable in 2025 and got a
few reasons that made sense to me:</p>
<ul>
<li>some people expect to be able to use the <code>TERM</code> environment variable to
control how programs behave (for example with <code>TERM=dumb</code>), and there&rsquo;s
no standard for how that should work in a post-terminfo world</li>
<li>even though there&rsquo;s <em>less</em> variation between terminal emulators than
there was in the 80s, there&rsquo;s far from zero variation: there are graphical
terminals, the Linux framebuffer console, the situation you&rsquo;re in when
connecting to a server via its serial console, Emacs shell mode, and probably
more that I&rsquo;m missing</li>
<li>there is no one standard for what the &ldquo;single common set&rdquo; of escape codes
is, and sometimes programs use escape codes which aren&rsquo;t actually widely
supported enough</li>
</ul>
<h3 id="terminfo-user-agent-detection">terminfo &amp; user agent detection</h3>
<p>The way that ncurses uses the <code>TERM</code> environment variable to decide which
escape codes to use reminds me of how webservers used to sometimes use the
browser user agent to decide which version of a website to serve.</p>
<p>It also seems like it&rsquo;s had some of the same results &ndash; the way iTerm2 reports
itself as being &ldquo;xterm-256color&rdquo; feels similar to how Safari&rsquo;s user agent is
&ldquo;Mozilla/5.0 (Macintosh; Intel Mac OS X 14_7_4) AppleWebKit/605.1.15 (KHTML,
like Gecko) Version/18.3 Safari/605.1.15&rdquo;. In both cases the terminal emulator
/ browser ends up changing its user agent to get around user agent detection
that isn&rsquo;t working well.</p>
<p>On the web we ended up deciding that user agent detection was not a good
practice and to instead focus on standardization so we can serve the same
HTML/CSS to all browsers. I don&rsquo;t know if the same approach is the future in
the terminal though &ndash; I think the terminal landscape today is much more
fragmented than the web ever was as well as being much less well funded.</p>
<h3 id="some-more-documents-standards">some more documents/standards</h3>
<p>A few more documents and standards related to escape codes, in no particular order:</p>
<ul>
<li>the <a href="https://man7.org/linux/man-pages/man4/console_codes.4.html">Linux console_codes man page</a> documents
escape codes that Linux supports</li>
<li>how the <a href="https://vt100.net/docs/vt100-ug/chapter3.html">VT 100</a> handles escape codes &amp; control sequences</li>
<li>the <a href="https://sw.kovidgoyal.net/kitty/keyboard-protocol/">kitty keyboard protocol</a></li>
<li><a href="https://gist.github.com/egmontkob/eb114294efbcd5adb1944c9f3cb5feda">OSC 8</a> for links in the terminal (and notes on <a href="https://github.com/Alhadis/OSC8-Adoption?tab=readme-ov-file">adoption</a>)</li>
<li>A <a href="https://github.com/tmux/tmux/blob/882fb4d295deb3e4b803eb444915763305114e4f/tools/ansicode.txt">summary of ANSI standards from tmux</a></li>
<li>this <a href="https://iterm2.com/feature-reporting/">terminal features reporting specification from iTerm</a></li>
<li>sixel graphics</li>
</ul>
<h3 id="why-i-think-this-is-interesting">why I think this is interesting</h3>
<p>I sometimes see people saying that the unix terminal is &ldquo;outdated&rdquo;, and since I
love the terminal so much I&rsquo;m always curious about what incremental changes
might make it feel less &ldquo;outdated&rdquo;.</p>
<p>Maybe if we had a clearer standards landscape (like we do on the web!) it would
be easier for terminal emulator developers to build new features and for
authors of terminal applications to more confidently adopt those features so
that we can all benefit from them and have a richer experience in the terminal.</p>
<p>Obviously standardizing ANSI escape codes is not easy (ECMA-48 was first
published almost 50 years ago and we&rsquo;re still not there!). I don&rsquo;t even know
what all of the challenges are. But the situation with HTML/CSS/JS used to be
extremely bad too and now it&rsquo;s MUCH better, so maybe there&rsquo;s hope.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to add a directory to your PATH]]></title>
    <link href="https://jvns.ca/blog/2025/02/13/how-to-add-a-directory-to-your-path/"/>
    <updated>2025-02-13T12:27:56+00:00</updated>
    <id>https://jvns.ca/blog/2025/02/13/how-to-add-a-directory-to-your-path/</id>
    <content type="html"><![CDATA[<p>I was talking to a friend about how to add a directory to your PATH today. It&rsquo;s
something that feels &ldquo;obvious&rdquo; to me since I&rsquo;ve been using the terminal for a
long time, but when I searched for instructions for how to do it, I actually
couldn&rsquo;t find something that explained all of the steps &ndash; a lot of them just
said &ldquo;add this to <code>~/.bashrc</code>&rdquo;, but what if you&rsquo;re not using bash? What if your
bash config is actually in a different file? And how are you supposed to figure
out which directory to add anyway?</p>
<p>So I wanted to try to write down some more complete directions and mention some
of the gotchas I&rsquo;ve run into over the years.</p>
<p>Here&rsquo;s a table of contents:</p>
<ul>
<li><a href="#step-1-what-shell-are-you-using">step 1: what shell are you using?</a></li>
<li><a href="#step-2-find-your-shell-s-config-file">step 2: find your shell&rsquo;s config file</a>
<ul>
<li><a href="#a-note-on-bash-s-config-file">a note on bash&rsquo;s config file</a></li>
</ul>
</li>
<li><a href="#step-3-figure-out-which-directory-to-add">step 3: figure out which directory to add</a>
<ul>
<li><a href="#step-3-1-double-check-it-s-the-right-directory">step 3.1: double check it&rsquo;s the right directory</a></li>
</ul>
</li>
<li><a href="#step-4-edit-your-shell-config">step 4: edit your shell config</a></li>
<li><a href="#step-5-restart-your-shell">step 5: restart your shell</a></li>
<li>problems:
<ul>
<li><a href="#problem-1-it-ran-the-wrong-program">problem 1: it ran the wrong program</a></li>
<li><a href="#problem-2-the-program-isn-t-being-run-from-your-shell">problem 2: the program isn&rsquo;t being run from your shell</a></li>
<li><a href="#problem-3-duplicate-path-entries-making-it-harder-to-debug">problem 3: duplicate PATH entries making it harder to debug</a></li>
<li><a href="#problem-4-losing-your-history-after-updating-your-path">problem 4: losing your history after updating your PATH</a></li>
</ul>
</li>
<li>notes:
<ul>
<li><a href="#a-note-on-source">a note on source</a></li>
<li><a href="#a-note-on-fish-add-path">a note on fish_add_path</a></li>
</ul>
</li>
</ul>
<h3 id="step-1-what-shell-are-you-using">step 1: what shell are you using?</h3>
<p>If you&rsquo;re not sure what shell you&rsquo;re using, here&rsquo;s a way to find out. Run this:</p>
<pre><code>ps -p $$ -o pid,comm=
</code></pre>
<ul>
<li>if you&rsquo;re using <strong>bash</strong>, it&rsquo;ll print out <code>97295 bash</code></li>
<li>if you&rsquo;re using <strong>zsh</strong>, it&rsquo;ll print out <code>97295 zsh</code></li>
<li>if you&rsquo;re using <strong>fish</strong>, it&rsquo;ll print out an error like &ldquo;In fish, please use
$fish_pid&rdquo; (<code>$$</code> isn&rsquo;t valid syntax in fish, but in any case the error
message tells you that you&rsquo;re using fish, which you probably already knew)</li>
</ul>
<p>Also bash is the default on Linux and zsh is the default on Mac OS (as of
2024). I&rsquo;ll only cover bash, zsh, and fish in these directions.</p>
<h3 id="step-2-find-your-shell-s-config-file">step 2: find your shell&rsquo;s config file</h3>
<ul>
<li>in zsh, it&rsquo;s probably <code>~/.zshrc</code></li>
<li>in bash, it might be <code>~/.bashrc</code>, but it&rsquo;s complicated, see the note in the next section</li>
<li>in fish, it&rsquo;s probably <code>~/.config/fish/config.fish</code> (you can run <code>echo $__fish_config_dir</code> if you want to be 100% sure)</li>
</ul>
<h3 id="a-note-on-bash-s-config-file">a note on bash&rsquo;s config file</h3>
<p>Bash has three possible config files: <code>~/.bashrc</code>, <code>~/.bash_profile</code>, and <code>~/.profile</code>.</p>
<p>If you&rsquo;re not sure which one your system is set up to use, I&rsquo;d recommend
testing this way:</p>
<ol>
<li>add <code>echo hi there</code> to your <code>~/.bashrc</code></li>
<li>Restart your terminal</li>
<li>If you see &ldquo;hi there&rdquo;, that means <code>~/.bashrc</code> is being used! Hooray!</li>
<li>Otherwise remove it and try the same thing with <code>~/.bash_profile</code></li>
<li>You can also try <code>~/.profile</code> if the first two options don&rsquo;t work.</li>
</ol>
<p>(there are a lot of <a href="https://blog.flowblok.id.au/2013-02/shell-startup-scripts.html">elaborate flow charts</a> out there that explain how bash
decides which config file to use but IMO it&rsquo;s not worth it to internalize them
and just testing is the fastest way to be sure)</p>
<h3 id="step-3-figure-out-which-directory-to-add">step 3: figure out which directory to add</h3>
<p>Let&rsquo;s say that you&rsquo;re trying to install and run a program called <code>http-server</code>
and it doesn&rsquo;t work, like this:</p>
<pre><code>$ npm install -g http-server
$ http-server
bash: http-server: command not found
</code></pre>
<p>How do you find what directory <code>http-server</code> is in? Honestly in general this is
not that easy &ndash; often the answer is something like &ldquo;it depends on how npm is
configured&rdquo;. A few ideas:</p>
<ul>
<li>Often when setting up a new installer (like <code>cargo</code>, <code>npm</code>, <code>homebrew</code>, etc),
when you first set it up it&rsquo;ll print out some directions about how to update
your PATH. So if you&rsquo;re paying attention you can get the directions then.</li>
<li>Sometimes installers will automatically update your shell&rsquo;s config file
to update your <code>PATH</code> for you</li>
<li>Sometimes just Googling &ldquo;where does npm install things?&rdquo; will turn up the
answer</li>
<li>Some tools have a subcommand that tells you where they&rsquo;re configured to
install things, like:
<ul>
<li>Node/npm: <code>npm config get prefix</code> (then append <code>/bin/</code>)</li>
<li>Go: <code>go env GOPATH</code> (then append <code>/bin/</code>)</li>
<li>asdf: <code>asdf info | grep ASDF_DIR</code> (then append <code>/bin/</code> and <code>/shims/</code>)</li>
</ul>
</li>
</ul>
<h3 id="step-3-1-double-check-it-s-the-right-directory">step 3.1: double check it&rsquo;s the right directory</h3>
<p>Once you&rsquo;ve found a directory you think might be the right one, make sure it&rsquo;s
actually correct! For example, I found out that on my machine, <code>http-server</code> is
in <code>~/.npm-global/bin</code>. I can make sure that it&rsquo;s the right directory by trying to
run the program <code>http-server</code> in that directory like this:</p>
<pre><code>$ ~/.npm-global/bin/http-server
Starting up http-server, serving ./public
</code></pre>
<p>It worked! Now that you know what directory you need to add to your <code>PATH</code>,
let&rsquo;s move to the next step!</p>
<h3 id="step-4-edit-your-shell-config">step 4: edit your shell config</h3>
<p>Now we have the 2 critical pieces of information we need:</p>
<ol>
<li>Which directory you&rsquo;re trying to add to your PATH (like  <code>~/.npm-global/bin/</code>)</li>
<li>Where your shell&rsquo;s config is (like <code>~/.bashrc</code>, <code>~/.zshrc</code>, or <code>~/.config/fish/config.fish</code>)</li>
</ol>
<p>Now what you need to add depends on your shell:</p>
<p><strong>bash instructions:</strong></p>
<p>Open your shell&rsquo;s config file, and add a line like this:</p>
<pre><code>export PATH=$PATH:~/.npm-global/bin/
</code></pre>
<p>(obviously replace <code>~/.npm-global/bin</code> with the actual directory you&rsquo;re trying to add)</p>
<p><strong>zsh instructions:</strong></p>
<p>You can do the same thing as in bash, but zsh also has some slightly fancier
syntax you can use if you prefer:</p>
<pre><code>path=(
  $path
  ~/.npm-global/bin
)
</code></pre>
<p><strong>fish instructions:</strong></p>
<p>In fish, the syntax is different:</p>
<pre><code>set PATH $PATH ~/.npm-global/bin
</code></pre>
<p>(in fish you can also use <code>fish_add_path</code>, some notes on that <a href="#a-note-on-fish-add-path">further down</a>)</p>
<h3 id="step-5-restart-your-shell">step 5: restart your shell</h3>
<p>Now, an extremely important step: updating your shell&rsquo;s config won&rsquo;t take
effect if you don&rsquo;t restart it!</p>
<p>Two ways to do this:</p>
<ol>
<li>open a new terminal (or terminal tab), and maybe close the old one so you don&rsquo;t get confused</li>
<li>Run <code>bash</code> to start a new shell (or <code>zsh</code> if you&rsquo;re using zsh, or <code>fish</code> if you&rsquo;re using fish)</li>
</ol>
<p>I&rsquo;ve found that both of these usually work fine.</p>
<p>And you should be done! Try running the program you were trying to run and
hopefully it works now.</p>
<p>If not, here are a couple of problems that you might run into:</p>
<h3 id="problem-1-it-ran-the-wrong-program">problem 1: it ran the wrong program</h3>
<p>If the wrong <strong>version</strong> of a program is running, you might need to add the
directory to the <em>beginning</em> of your PATH instead of the end.</p>
<p>For example, on my system I have two versions of <code>python3</code> installed, which I
can see by running <code>which -a</code>:</p>
<pre><code>$ which -a python3
/usr/bin/python3
/opt/homebrew/bin/python3
</code></pre>
<p>The one your shell will use is the <strong>first one listed</strong>.</p>
<p>If you want to use the Homebrew version, you need to add that directory
(<code>/opt/homebrew/bin</code>) to the <strong>beginning</strong> of your PATH instead, by putting this in
your shell&rsquo;s config file (it&rsquo;s <code>/opt/homebrew/bin/:$PATH</code> instead of the usual <code>$PATH:/opt/homebrew/bin/</code>)</p>
<pre><code>export PATH=/opt/homebrew/bin/:$PATH
</code></pre>
<p>or in fish:</p>
<pre><code>set PATH ~/.cargo/bin $PATH
</code></pre>
<h3 id="problem-2-the-program-isn-t-being-run-from-your-shell">problem 2: the program isn&rsquo;t being run from your shell</h3>
<p>All of these directions only work if you&rsquo;re running the program <strong>from your
shell</strong>. If you&rsquo;re running the program from an IDE, from a GUI, in a cron job,
or some other way, you&rsquo;ll need to add the directory to your PATH in a different
way, and the exact details might depend on the situation.</p>
<p><strong>in a cron job</strong></p>
<p>Some options:</p>
<ul>
<li>use the full path to the program you&rsquo;re running, like <code>/home/bork/bin/my-program</code></li>
<li>put the full PATH you want as the first line of your crontab (something like
PATH=/bin:/usr/bin:/usr/local/bin:&hellip;.). You can get the full PATH you&rsquo;re
using in your shell by running <code>echo &quot;PATH=$PATH&quot;</code>.</li>
</ul>
<p>I&rsquo;m honestly not sure how to handle it in an IDE/GUI because I haven&rsquo;t run into
that in a long time, will add directions here if someone points me in the right
direction.</p>
<h3 id="problem-3-duplicate-path-entries-making-it-harder-to-debug">problem 3: duplicate <code>PATH</code> entries making it harder to debug</h3>
<p>If you edit your path and start a new shell by running <code>bash</code> (or <code>zsh</code>, or
<code>fish</code>), you&rsquo;ll often end up with duplicate <code>PATH</code> entries, because the shell
keeps adding new things to your <code>PATH</code> every time you start your shell.</p>
<p>Personally I don&rsquo;t think I&rsquo;ve run into a situation where this kind of
duplication breaks anything, but the duplicates can make it harder to debug
what&rsquo;s going on with your <code>PATH</code> if you&rsquo;re trying to understand its contents.</p>
<p>Some ways you could deal with this:</p>
<ol>
<li>If you&rsquo;re debugging your <code>PATH</code>, open a new terminal to do it in so you get
a &ldquo;fresh&rdquo; state. This should avoid the duplication.</li>
<li>Deduplicate your <code>PATH</code> at the end of your shell&rsquo;s config  (for example in
zsh apparently you can do this with <code>typeset -U path</code>)</li>
<li>Check that the directory isn&rsquo;t already in your <code>PATH</code> when adding it (for
example in fish I believe you can do this with <code>fish_add_path --path /some/directory</code>)</li>
</ol>
<p>How to deduplicate your <code>PATH</code> is shell-specific and there isn&rsquo;t always a
built in way to do it so you&rsquo;ll need to look up how to accomplish it in your
shell.</p>
<h3 id="problem-4-losing-your-history-after-updating-your-path">problem 4: losing your history after updating your <code>PATH</code></h3>
<p>Here&rsquo;s a situation that&rsquo;s easy to get into in bash or zsh:</p>
<ol>
<li>Run a command (it fails)</li>
<li>Update your <code>PATH</code></li>
<li>Run <code>bash</code> to reload your config</li>
<li>Press the up arrow a couple of times to rerun the failed command (or open a new terminal)</li>
<li>The failed command isn&rsquo;t in your history! Why not?</li>
</ol>
<p>This happens because in bash, by default, history is not saved until you exit
the shell.</p>
<p>Some options for fixing this:</p>
<ul>
<li>Instead of running <code>bash</code> to reload your config, run <code>source ~/.bashrc</code> (or
<code>source ~/.zshrc</code> in zsh). This will reload the config inside your current
session.</li>
<li>Configure your shell to continuously save your history instead of only saving
the history when the shell exits. (How to do this depends on whether you&rsquo;re
using bash or zsh, the history options in zsh are a bit complicated and I&rsquo;m
not exactly sure what the best way is)</li>
</ul>
<h3 id="a-note-on-source">a note on <code>source</code></h3>
<p>When you install <code>cargo</code> (Rust&rsquo;s installer) for the first time, it gives you
these instructions for how to set up your PATH, which don&rsquo;t mention a specific
directory at all.</p>
<pre><code>This is usually done by running one of the following (note the leading DOT):

. &quot;$HOME/.cargo/env&quot;        	# For sh/bash/zsh/ash/dash/pdksh
source &quot;$HOME/.cargo/env.fish&quot;  # For fish
</code></pre>
<p>The idea is that you add that line to your shell&rsquo;s config, and their script
automatically sets up your <code>PATH</code> (and potentially other things) for you.</p>
<p>This is pretty common (for example <a href="https://github.com/Homebrew/install/blob/deacfa6a6e62e5f4002baf9e1fac7a96e9aa5d41/install.sh#L1072-L1087">Homebrew</a> suggests you eval <code>brew shellenv</code>), and there are
two ways to approach this:</p>
<ol>
<li>Just do what the tool suggests (like adding <code>. &quot;$HOME/.cargo/env&quot;</code> to your shell&rsquo;s config)</li>
<li>Figure out which directories the script they&rsquo;re telling you to run would add
to your PATH, and then add those manually. Here&rsquo;s how I&rsquo;d do that:
<ul>
<li>Run <code>. &quot;$HOME/.cargo/env&quot;</code> in my shell (or the fish version if using fish)</li>
<li>Run <code>echo &quot;$PATH&quot; | tr ':' '\n' | grep cargo</code> to figure out which directories it added</li>
<li>See that it says <code>/Users/bork/.cargo/bin</code> and shorten that to <code>~/.cargo/bin</code></li>
<li>Add the directory <code>~/.cargo/bin</code> to PATH (with the directions in this post)</li>
</ul>
</li>
</ol>
<p>I don&rsquo;t think there&rsquo;s anything wrong with doing what the tool suggests (it
might be the &ldquo;best way&rdquo;!), but personally I usually use the second approach
because I prefer knowing exactly what configuration I&rsquo;m changing.</p>
<h3 id="a-note-on-fish-add-path">a note on <code>fish_add_path</code></h3>
<p>fish has a handy function called <code>fish_add_path</code> that you can run to add a directory to your <code>PATH</code> like this:</p>
<pre><code>fish_add_path /some/directory
</code></pre>
<p>This is cool (it&rsquo;s such a simple command!) but I&rsquo;ve stopped using it for a couple of reasons:</p>
<ol>
<li>Sometimes <code>fish_add_path</code> will update the <code>PATH</code> for every session in the
future (with a &ldquo;universal variable&rdquo;) and sometimes it will update the <code>PATH</code>
just for the current session and it&rsquo;s hard for me to tell which one it will
do. In theory the docs explain this but I could not understand them.</li>
<li>If you ever need to <em>remove</em> the directory from your <code>PATH</code> a few weeks or
months later because maybe you made a mistake, it&rsquo;s kind of hard to do
(there are <a href="https://github.com/fish-shell/fish-shell/issues/8604">instructions in this comments of this github issue though</a>).</li>
</ol>
<h3 id="that-s-all">that&rsquo;s all</h3>
<p>Hopefully this will help some people. Let me know (on Mastodon or Bluesky) if
you there are other major gotchas that have tripped you up when adding a
directory to your PATH, or if you have questions about this post!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some terminal frustrations]]></title>
    <link href="https://jvns.ca/blog/2025/02/05/some-terminal-frustrations/"/>
    <updated>2025-02-05T16:57:00+00:00</updated>
    <id>https://jvns.ca/blog/2025/02/05/some-terminal-frustrations/</id>
    <content type="html"><![CDATA[<p>A few weeks ago I ran a terminal survey (you can <a href="https://jvns.ca/terminal-survey/results-bsky.html">read the results here</a>) and at the end I asked:</p>
<blockquote>
<p>What’s the most frustrating thing about using the terminal for you?</p>
</blockquote>
<p>1600 people answered, and I decided to spend a few days categorizing all the
responses. Along the way I learned that classifying qualitative data is not
easy but I gave it my best shot. I ended up building a custom
<a href="https://github.com/jvns/classificator">tool</a> to make it faster to categorize
everything.</p>
<p>As with all of my surveys the methodology isn&rsquo;t particularly scientific. I just
posted the survey to Mastodon and Twitter, ran it for a couple of days, and got
answers from whoever happened to see it and felt like responding.</p>
<p>Here are the top categories of frustrations!</p>
<p>I think it&rsquo;s worth keeping in mind while reading these comments that</p>
<ul>
<li>40% of people answering this survey have been using the terminal for <strong>21+ years</strong></li>
<li>95% of people answering the survey have been using the terminal for at least 4 years</li>
</ul>
<p>These comments aren&rsquo;t coming from total beginners.</p>
<p>Here are the categories of frustrations! The number in brackets is the number
of people with that frustration. I&rsquo;m mostly writing this up for myself because
I&rsquo;m trying to write a zine about the terminal and I wanted to get a sense for
what people are having trouble with.</p>
<h3 id="remembering-syntax-115">remembering syntax (115)</h3>
<p>People talked about struggles remembering:</p>
<ul>
<li>the syntax for CLI tools like awk, jq, sed, etc</li>
<li>the syntax for redirects</li>
<li>keyboard shortcuts for tmux, text editing, etc</li>
</ul>
<p>One example comment:</p>
<blockquote>
<p>There are just so many little &ldquo;trivia&rdquo; details to remember for full
functionality. Even after all these years I&rsquo;ll sometimes forget where it&rsquo;s 2
or 1 for stderr, or forget which is which for <code>&gt;</code> and <code>&gt;&gt;</code>.</p>
</blockquote>
<h3 id="switching-terminals-is-hard-91">switching terminals is hard (91)</h3>
<p>People talked about struggling with switching systems (for example home/work
computer or when SSHing) and running into:</p>
<ul>
<li>OS differences in keyboard shortcuts (like Linux vs Mac)</li>
<li>systems which don&rsquo;t have their preferred text editor (&ldquo;no vim&rdquo; or &ldquo;only vim&rdquo;)</li>
<li>different versions of the same command (like Mac OS grep vs GNU grep)</li>
<li>no tab completion</li>
<li>a shell they aren&rsquo;t used to (&ldquo;the subtle differences between zsh and bash&rdquo;)</li>
</ul>
<p>as well as differences inside the same system like pagers being not consistent
with each other (git diff pagers, other pagers).</p>
<p>One example comment:</p>
<blockquote>
<p>I got used to fish and vi mode which are not available when I ssh into
servers, containers.</p>
</blockquote>
<h3 id="color-85">color (85)</h3>
<p>Lots of problems with color, like:</p>
<ul>
<li>programs setting colors that are unreadable with a light background color</li>
<li>finding a colorscheme they like (and getting it to work consistently across different apps)</li>
<li>color not working inside several layers of SSH/tmux/etc</li>
<li>not liking the defaults</li>
<li>not wanting color at all and struggling to turn it off</li>
</ul>
<p>This comment felt relatable to me:</p>
<blockquote>
<p>Getting my terminal theme configured in a reasonable way between the terminal
emulator and fish (I did this years ago and remember it being tedious and
fiddly and now feel like I&rsquo;m locked into my current theme because it works
and I dread touching any of that configuration ever again).</p>
</blockquote>
<h3 id="keyboard-shortcuts-84">keyboard shortcuts (84)</h3>
<p>Half of the comments on keyboard shortcuts were about how on Linux/Windows, the
keyboard shortcut to copy/paste in the terminal is different from in the rest
of the OS.</p>
<p>Some other issues with keyboard shortcuts other than copy/paste:</p>
<ul>
<li>using <code>Ctrl-W</code> in a browser-based terminal and closing the window</li>
<li>the terminal only supports a limited set of keyboard shortcuts (no
<code>Ctrl-Shift-</code>, no <code>Super</code>, no <code>Hyper</code>, lots of <code>ctrl-</code> shortcuts aren&rsquo;t
possible like <code>Ctrl-,</code>)</li>
<li>the OS stopping you from using a terminal keyboard shortcut (like by default
Mac OS uses <code>Ctrl+left arrow</code> for something else)</li>
<li>issues using emacs in the terminal</li>
<li>backspace not working (2)</li>
</ul>
<h3 id="other-copy-and-paste-issues-75">other copy and paste issues (75)</h3>
<p>Aside from &ldquo;the keyboard shortcut for copy and paste is different&rdquo;, there were
a lot of OTHER issues with copy and paste, like:</p>
<ul>
<li>copying over SSH</li>
<li>how tmux and the terminal emulator both do copy/paste in different ways</li>
<li>dealing with many different clipboards (system clipboard, vim clipboard, the
&ldquo;middle click&rdquo; clipboard on Linux, tmux&rsquo;s clipboard, etc) and potentially
synchronizing them</li>
<li>random spaces added when copying from the terminal</li>
<li>pasting multiline commands which automatically get run in a terrifying way</li>
<li>wanting a way to copy text without using the mouse</li>
</ul>
<h3 id="discoverability-55">discoverability (55)</h3>
<p>There were lots of comments about this, which all came down to the same basic
complaint &ndash; it&rsquo;s hard to discover useful tools or features! This comment kind of
summed it all up:</p>
<blockquote>
<p>How difficult it is to learn independently. Most of what I know is an
assorted collection of stuff I&rsquo;ve been told by random people over the years.</p>
</blockquote>
<h3 id="steep-learning-curve-44">steep learning curve (44)</h3>
<p>A lot of comments about it generally having a steep learning curve. A couple of
example comments:</p>
<blockquote>
<p>After 15 years of using it, I’m not much faster than using it than I was 5 or
maybe even 10 years ago.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>That I know I could make my life easier by learning more about the shortcuts
and commands and configuring the terminal but I don&rsquo;t spend the time because it
feels overwhelming.</p>
</blockquote>
<h3 id="history-42">history  (42)</h3>
<p>Some issues with shell history:</p>
<ul>
<li>history not being shared between terminal tabs (16)</li>
<li>limits that are too short (4)</li>
<li>history not being restored when terminal tabs are restored</li>
<li>losing history because the terminal crashed</li>
<li>not knowing how to search history</li>
</ul>
<p>One example comment:</p>
<blockquote>
<p>It wasted a lot of time until I figured it out and still annoys me that
&ldquo;history&rdquo; on zsh has such a small buffer;  I have to type &ldquo;history 0&rdquo; to get
any useful length of history.</p>
</blockquote>
<h3 id="bad-documentation-37">bad documentation (37)</h3>
<p>People talked about:</p>
<ul>
<li>documentation being generally opaque</li>
<li>lack of examples in man pages</li>
<li>programs which don&rsquo;t have man pages</li>
</ul>
<p>Here&rsquo;s a representative comment:</p>
<blockquote>
<p>Finding good examples and docs. Man pages often not enough, have to wade
through stack overflow</p>
</blockquote>
<h3 id="scrollback-36">scrollback (36)</h3>
<p>A few issues with scrollback:</p>
<ul>
<li>programs printing out too much data making you lose scrollback history</li>
<li>resizing the terminal messes up the scrollback</li>
<li>lack of timestamps</li>
<li>GUI programs that you start in the background printing stuff out that gets in
the way of other programs&rsquo; outputs</li>
</ul>
<p>One example comment:</p>
<blockquote>
<p>When resizing the terminal (in particular: making it narrower) leads to
broken rewrapping of the scrollback content because the commands formatted
their output based on the terminal window width.</p>
</blockquote>
<h3 id="it-feels-outdated-33">&ldquo;it feels outdated&rdquo; (33)</h3>
<p>Lots of comments about how the terminal feels hampered by legacy decisions and
how users often end up needing to learn implementation details that feel very
esoteric. One example comment:</p>
<blockquote>
<p>Most of the legacy cruft, it would be great to have a green field
implementation of the CLI interface.</p>
</blockquote>
<h3 id="shell-scripting-32">shell scripting (32)</h3>
<p>Lots of complaints about POSIX shell scripting. There&rsquo;s a general feeling that
shell scripting is difficult but also that switching to a different less
standard scripting language (fish, nushell, etc) brings its own problems.</p>
<blockquote>
<p>Shell scripting. My tolerance to ditch a shell script and go to a scripting
language is pretty low. It’s just too messy and powerful. Screwing up can be
costly so I don’t even bother.</p>
</blockquote>
<h3 id="more-issues">more issues</h3>
<p>Some more issues that were mentioned at least 10 times:</p>
<ul>
<li>(31) inconsistent command line arguments: is it -h or help or &ndash;help?</li>
<li>(24) keeping dotfiles in sync across different systems</li>
<li>(23) performance (e.g. &ldquo;my shell takes too long to start&rdquo;)</li>
<li>(20) window management (potentially with some combination of tmux tabs, terminal tabs, and multiple terminal windows. Where did that shell session go?)</li>
<li>(17) generally feeling scared/uneasy (&ldquo;The debilitating fear that I’m going
to do some mysterious Bad Thing with a command and I will have absolutely no
idea how to fix or undo it or even really figure out what happened&rdquo;)</li>
<li>(16) terminfo issues (&ldquo;Having to learn about terminfo if/when I try a new terminal emulator and ssh elsewhere.&rdquo;)</li>
<li>(16) lack of image support (sixel etc)</li>
<li>(15) SSH issues (like having to start over when you lose the SSH connection)</li>
<li>(15) various tmux/screen issues (for example lack of integration between tmux and the terminal emulator)</li>
<li>(15) typos &amp; slow typing</li>
<li>(13) the terminal getting messed up for various reasons (pressing <code>Ctrl-S</code>, <code>cat</code>ing a binary, etc)</li>
<li>(12) quoting/escaping in the shell</li>
<li>(11) various Windows/PowerShell issues</li>
</ul>
<h3 id="n-a-122">n/a (122)</h3>
<p>There were also 122 answers to the effect of &ldquo;nothing really&rdquo; or &ldquo;only that I
can&rsquo;t do EVERYTHING in the terminal&rdquo;</p>
<p>One example comment:</p>
<blockquote>
<p>Think I&rsquo;ve found work arounds for most/all frustrations</p>
</blockquote>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>I&rsquo;m not going to make a lot of commentary on these results, but here are a
couple of categories that feel related to me:</p>
<ul>
<li>remembering syntax &amp; history (often the thing you need to remember is something you&rsquo;ve run before!)</li>
<li>discoverability &amp; the learning curve (the lack of discoverability is definitely a big part of what makes it hard to learn)</li>
<li>&ldquo;switching systems is hard&rdquo; &amp; &ldquo;it feels outdated&rdquo; (tools that haven&rsquo;t really
changed in 30 or 40 years have many problems but they do tend to be always
<em>there</em> no matter what system you&rsquo;re on, which is very useful and makes them
hard to stop using)</li>
</ul>
<p>Trying to categorize all these results in a reasonable way really gave me an
appreciation for social science researchers&rsquo; skills.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[What's involved in getting a "modern" terminal setup?]]></title>
    <link href="https://jvns.ca/blog/2025/01/11/getting-a-modern-terminal-setup/"/>
    <updated>2025-01-11T09:46:01+00:00</updated>
    <id>https://jvns.ca/blog/2025/01/11/getting-a-modern-terminal-setup/</id>
    <content type="html"><![CDATA[<p>Hello! Recently I ran a terminal survey and I asked people what frustrated
them. One person commented:</p>
<blockquote>
<p>There are so many pieces to having a modern terminal experience. I wish it
all came out of the box.</p>
</blockquote>
<p>My immediate reaction was &ldquo;oh, getting a modern terminal experience isn&rsquo;t that
hard, you just need to&hellip;.&rdquo;, but the more I thought about it, the longer the
&ldquo;you just need to&hellip;&rdquo; list got, and I kept thinking about more and more
caveats.</p>
<p>So I thought I would write down some notes about what it means to me personally
to have a &ldquo;modern&rdquo; terminal experience and what I think can make it hard for
people to get there.</p>
<h3 id="what-is-a-modern-terminal-experience">what is a &ldquo;modern terminal experience&rdquo;?</h3>
<p>Here are a few things that are important to me, with which part of the system
is responsible for them:</p>
<ul>
<li><strong>multiline support for copy and paste</strong>: if you paste 3 commands in your shell, it should not immediately run them all! That&rsquo;s scary! (<strong>shell</strong>, <strong>terminal emulator</strong>)</li>
<li><strong>infinite shell history</strong>: if I run a command in my shell, it should be saved forever, not deleted after 500 history entries or whatever. Also I want commands to be saved to the history immediately when I run them, not only when I exit the shell session (<strong>shell</strong>)</li>
<li><strong>a useful prompt</strong>: I can&rsquo;t live without having my <strong>current directory</strong> and <strong>current git branch</strong> in my prompt (<strong>shell</strong>)</li>
<li><strong>24-bit colour</strong>: this is important to me because I find it MUCH easier to theme neovim with 24-bit colour support than in a terminal with only 256 colours (<strong>terminal emulator</strong>)</li>
<li><strong>clipboard integration</strong> between vim and my operating system so that when I copy in Firefox, I can just press <code>p</code> in vim to paste (<strong>text editor</strong>, maybe the OS/terminal emulator too)</li>
<li><strong>good autocomplete</strong>: for example commands like git should have command-specific autocomplete (<strong>shell</strong>)</li>
<li><strong>having colours in <code>ls</code></strong> (<strong>shell config</strong>)</li>
<li><strong>a terminal theme I like</strong>: I spend a lot of time in my terminal, I want it to look nice and I want its theme to match my terminal editor&rsquo;s theme. (<strong>terminal emulator</strong>, <strong>text editor</strong>)</li>
<li><strong>automatic terminal fixing</strong>: If a programs prints out some weird escape
codes that mess up my terminal, I want that to automatically get reset so
that my terminal doesn&rsquo;t get messed up (<strong>shell</strong>)</li>
<li><strong>keybindings</strong>: I want <code>Ctrl+left arrow</code> to work (<strong>shell</strong> or <strong>application</strong>)</li>
<li><strong>being able to use the scroll wheel in programs like <code>less</code></strong>: (<strong>terminal emulator</strong> and <strong>applications</strong>)</li>
</ul>
<p>There are a million other terminal conveniences out there and different people
value different things, but those are the ones that I would be really unhappy
without.</p>
<h3 id="how-i-achieve-a-modern-experience">how I achieve a &ldquo;modern experience&rdquo;</h3>
<p>My basic approach is:</p>
<ol>
<li>use the <code>fish</code> shell. Mostly don&rsquo;t configure it, except to:
<ul>
<li>set the <code>EDITOR</code> environment variable to my favourite terminal editor</li>
<li>alias <code>ls</code> to <code>ls --color=auto</code></li>
</ul>
</li>
<li>use any terminal emulator with 24-bit colour support. In the past I&rsquo;ve used
GNOME Terminal, Terminator, and iTerm, but I&rsquo;m not picky about this. I don&rsquo;t really
configure it other than to choose a font.</li>
<li>use <code>neovim</code>, with a configuration that I&rsquo;ve been very slowly building over the last 9 years or so (the last time I deleted my vim config and started from scratch was 9 years ago)</li>
<li>use the <a href="https://github.com/chriskempson/base16">base16 framework</a> to theme everything</li>
</ol>
<p>A few things that affect my approach:</p>
<ul>
<li>I don&rsquo;t spend a lot of time SSHed into other machines</li>
<li>I&rsquo;d rather use the mouse a little than come up with keyboard-based ways to do everything</li>
<li>I work on a lot of small projects, not one big project</li>
</ul>
<h3 id="some-out-of-the-box-options-for-a-modern-experience">some &ldquo;out of the box&rdquo; options for a &ldquo;modern&rdquo; experience</h3>
<p>What if you want a nice experience, but don&rsquo;t want to spend a lot of time on
configuration? Figuring out how to configure vim in a way that I was satisfied
with really did take me like ten years, which is a long time!</p>
<p>My best ideas for how to get a reasonable terminal experience with minimal
config are:</p>
<ul>
<li>shell: either <code>fish</code> or <code>zsh</code> with <a href="https://ohmyz.sh/">oh-my-zsh</a></li>
<li>terminal emulator: almost anything with 24-bit colour support, for example all of these are popular:
<ul>
<li>linux: GNOME Terminal, Konsole, Terminator, xfce4-terminal</li>
<li>mac: iTerm (Terminal.app doesn&rsquo;t have 256-colour support)</li>
<li>cross-platform: kitty, alacritty, wezterm, or ghostty</li>
</ul>
</li>
<li>shell config:
<ul>
<li>set the <code>EDITOR</code> environment variable to your favourite terminal text
editor</li>
<li>maybe alias <code>ls</code> to <code>ls --color=auto</code></li>
</ul>
</li>
<li>text editor: this is a tough one, maybe <a href="https://micro-editor.github.io/">micro</a> or <a href="https://helix-editor.com/">helix</a>? I haven&rsquo;t used
either of them seriously but they both seem like very cool projects and I
think it&rsquo;s amazing that you can just use all the usual GUI editor commands
(<code>Ctrl-C</code> to copy, <code>Ctrl-V</code> to paste, <code>Ctrl-A</code> to select all) in micro and
they do what you&rsquo;d expect. I would probably try switching to helix except
that retraining my vim muscle memory seems way too hard. Also helix doesn&rsquo;t
have a GUI or plugin system yet.</li>
</ul>
<p>Personally I <strong>wouldn&rsquo;t</strong> use xterm, rxvt, or Terminal.app as a terminal emulator,
because I&rsquo;ve found in the past that they&rsquo;re missing core features (like 24-bit
colour in Terminal.app&rsquo;s case) that make the terminal harder to use for me.</p>
<p>I don&rsquo;t want to pretend that getting a &ldquo;modern&rdquo; terminal experience is easier
than it is though &ndash; I think there are two issues that make it hard. Let&rsquo;s talk
about them!</p>
<h3 id="issue-1-with-getting-to-a-modern-experience-the-shell">issue 1 with getting to a &ldquo;modern&rdquo; experience: the shell</h3>
<p>bash and zsh are by far the two most popular shells, and neither of them
provide a default experience that I would be happy using out of the box, for
example:</p>
<ul>
<li>you need to customize your prompt</li>
<li>they don&rsquo;t come with git completions by default, you have to set them up</li>
<li>by default, bash only stores 500 (!) lines of history and (at least on Mac OS)
zsh is only configured to store 2000 lines, which is still not a lot</li>
<li>I find bash&rsquo;s tab completion very frustrating, if there&rsquo;s more than
one match then you can&rsquo;t tab through them</li>
</ul>
<p>And even though <a href="https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/">I love fish</a>, the fact
that it isn&rsquo;t POSIX does make it hard for a lot of folks to make the switch.</p>
<p>Of course it&rsquo;s totally possible to learn how to customize your prompt in bash
or whatever, and it doesn&rsquo;t even need to be that complicated (in bash I&rsquo;d
probably start with something like <code>export PS1='[\u@\h \W$(__git_ps1 &quot; (%s)&quot;)]\$ '</code>, or maybe use <a href="https://starship.rs/">starship</a>).
But each of these &ldquo;not complicated&rdquo; things really does add up and it&rsquo;s
especially tough if you need to keep your config in sync across several
systems.</p>
<p>An extremely popular solution to getting a &ldquo;modern&rdquo; shell experience is
<a href="https://ohmyz.sh/">oh-my-zsh</a>. It seems like a great project and I know a lot
of people use it very happily, but I&rsquo;ve struggled with configuration systems
like that in the past &ndash; it looks like right now the base oh-my-zsh adds about
3000 lines of config, and often I find that having an extra configuration
system makes it harder to debug what&rsquo;s happening when things go wrong. I
personally have a tendency to use the system to add a lot of extra plugins,
make my system slow, get frustrated that it&rsquo;s slow, and then delete it
completely and write a new config from scratch.</p>
<h3 id="issue-2-with-getting-to-a-modern-experience-the-text-editor">issue 2 with getting to a &ldquo;modern&rdquo; experience: the text editor</h3>
<p>In the terminal survey I ran recently, the most popular terminal text editors
by far were <code>vim</code>, <code>emacs</code>, and <code>nano</code>.</p>
<p>I think the main options for terminal text editors are:</p>
<ul>
<li>use vim or emacs and configure it to your liking, you can probably have any
feature you want if you put in the work</li>
<li>use nano and accept that you&rsquo;re going to have a pretty limited experience
(for example I don&rsquo;t think you can select text with the mouse and then &ldquo;cut&rdquo;
it in nano)</li>
<li>use <code>micro</code> or <code>helix</code> which seem to offer a pretty good out-of-the-box
experience, potentially occasionally run into issues with using a less
mainstream text editor</li>
<li>just avoid using a terminal text editor as much as possible, maybe use VSCode, use
VSCode&rsquo;s terminal for all your terminal needs, and mostly never edit files in
the terminal. Or I know a lot of people use <code>code</code> as their <code>EDITOR</code> in the terminal.</li>
</ul>
<h3 id="issue-3-individual-applications">issue 3: individual applications</h3>
<p>The last issue is that sometimes individual programs that I use are kind of
annoying. For example on my Mac OS machine, <code>/usr/bin/sqlite3</code> doesn&rsquo;t support
the <code>Ctrl+Left Arrow</code> keyboard shortcut. Fixing this to get a reasonable
terminal experience in SQLite was a little complicated, I had to:</p>
<ul>
<li>realize why this is happening (Mac OS won&rsquo;t ship GNU tools, and &ldquo;Ctrl-Left arrow&rdquo; support comes from GNU readline)</li>
<li>find a workaround (install sqlite from homebrew, which does have readline support)</li>
<li>adjust my environment (put Homebrew&rsquo;s sqlite3 in my PATH)</li>
</ul>
<p>I find that debugging application-specific issues like this is really not easy
and often it doesn&rsquo;t feel &ldquo;worth it&rdquo; &ndash; often I&rsquo;ll end up just dealing with
various minor inconveniences because I don&rsquo;t want to spend hours investigating
them. The only reason I was even able to figure this one out at all is that
I&rsquo;ve been spending a huge amount of time thinking about the terminal recently.</p>
<p>A big part of having a &ldquo;modern&rdquo; experience using terminal programs is just
using newer terminal programs, for example I can&rsquo;t be bothered to learn a
keyboard shortcut to sort the columns in <code>top</code>, but in <code>htop</code>  I can just click
on a column heading with my mouse to sort it. So I use htop instead! But discovering new more &ldquo;modern&rdquo; command line tools isn&rsquo;t easy (though
I made <a href="https://jvns.ca/blog/2022/04/12/a-list-of-new-ish--command-line-tools/">a list here</a>),
finding ones that I actually like using in practice takes time, and if you&rsquo;re
SSHed into another machine, they won&rsquo;t always be there.</p>
<h3 id="everything-affects-everything-else">everything affects everything else</h3>
<p>Something I find tricky about configuring my terminal to make everything &ldquo;nice&rdquo;
is that changing one seemingly small thing about my workflow can really affect
everything else. For example right now I don&rsquo;t use tmux. But if I needed to use
tmux again (for example because I was doing a lot of work SSHed into another
machine), I&rsquo;d need to think about a few things, like:</p>
<ul>
<li>if I wanted tmux&rsquo;s copy to synchronize with my system clipboard over
SSH, I&rsquo;d need to make sure that my terminal emulator has <a href="https://old.reddit.com/r/vim/comments/k1ydpn/a_guide_on_how_to_copy_text_from_anywhere/">OSC 52 support</a></li>
<li>if I wanted to use iTerm&rsquo;s tmux integration (which makes tmux tabs into iTerm
tabs), I&rsquo;d need to change how I configure colours &ndash; right now I set them
with a <a href="https://github.com/chriskempson/base16-shell/blob/588691ba71b47e75793ed9edfcfaa058326a6f41/scripts/base16-solarized-light.sh">shell script</a> that I run when my shell starts, but that means the
colours get lost when restoring a tmux session.</li>
</ul>
<p>and probably more things I haven&rsquo;t thought of. &ldquo;Using tmux means that I have to
change how I manage my colours&rdquo; sounds unlikely, but that really did happen to
me and I decided &ldquo;well, I don&rsquo;t want to change how I manage colours right now,
so I guess I&rsquo;m not using that feature!&rdquo;.</p>
<p>It&rsquo;s also hard to remember which features I&rsquo;m relying on &ndash; for example maybe
my current terminal <em>does</em> have OSC 52 support and because copying from tmux over SSH
has always Just Worked I don&rsquo;t even realize that that&rsquo;s something I need, and
then it mysteriously stops working when I switch terminals.</p>
<h3 id="change-things-slowly">change things slowly</h3>
<p>Personally even though I think my setup is not <em>that</em> complicated, it&rsquo;s taken
me 20 years to get to this point! Because terminal config changes are so likely
to have unexpected and hard-to-understand consequences, I&rsquo;ve found that if I
change a lot of terminal configuration all at once it makes it much harder to
understand what went wrong if there&rsquo;s a problem, which can be really
disorienting.</p>
<p>So I usually prefer to make pretty small changes, and accept that changes can
might take me a REALLY long time to get used to. For example I switched from
using <code>ls</code> to <a href="https://github.com/eza-community/eza">eza</a> a year or two ago and
while I like it (because <code>eza -l</code> prints human-readable file sizes by default)
I&rsquo;m still not quite sure about it. But also sometimes it&rsquo;s worth it to make a
big change, like I made the switch to fish (from bash) 10 years ago and I&rsquo;m
very happy I did.</p>
<h3 id="getting-a-modern-terminal-is-not-that-easy">getting a &ldquo;modern&rdquo; terminal is not that easy</h3>
<p>Trying to explain how &ldquo;easy&rdquo; it is to configure your terminal really just made
me think that it&rsquo;s kind of hard and that I still sometimes get confused.</p>
<p>I&rsquo;ve found that there&rsquo;s never one perfect way to configure things in the
terminal that will be compatible with every single other thing. I just need to
try stuff, figure out some kind of locally stable state that works for me, and
accept that if I start using a new tool it might disrupt the system and I might
need to rethink things.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA["Rules" that terminal programs follow]]></title>
    <link href="https://jvns.ca/blog/2024/11/26/terminal-rules/"/>
    <updated>2024-12-12T09:28:22+00:00</updated>
    <id>https://jvns.ca/blog/2024/11/26/terminal-rules/</id>
    <content type="html"><![CDATA[<p>Recently I&rsquo;ve been thinking about how everything that happens in the terminal
is some combination of:</p>
<ol>
<li>Your <strong>operating system</strong>&rsquo;s job</li>
<li>Your <strong>shell</strong>&rsquo;s job</li>
<li>Your <strong>terminal emulator</strong>&rsquo;s job</li>
<li>The job of <strong>whatever program you happen to be running</strong> (like <code>top</code> or <code>vim</code> or <code>cat</code>)</li>
</ol>
<p>The first three (your operating system, shell, and terminal emulator) are all kind of
known quantities &ndash; if you&rsquo;re using bash in GNOME Terminal on Linux, you can
more or less reason about how how all of those things interact, and some of
their behaviour is standardized by POSIX.</p>
<p>But the fourth one (&ldquo;whatever program you happen to be running&rdquo;) feels like it
could do ANYTHING. How are you supposed to know how a program is going to
behave?</p>
<p>This post is kind of long so here&rsquo;s a quick table of contents:</p>
<ul>
<li><a href="#programs-behave-surprisingly-consistently">programs behave surprisingly consistently</a></li>
<li><a href="#these-are-meant-to-be-descriptive-not-prescriptive">these are meant to be descriptive, not prescriptive</a></li>
<li><a href="#it-s-not-always-obvious-which-rules-are-the-program-s-responsibility-to-implement">it&rsquo;s not always obvious which &ldquo;rules&rdquo; are the program&rsquo;s responsibility to implement</a></li>
<li><a href="#rule-1-noninteractive-programs-should-quit-when-you-press-ctrl-c">rule 1: noninteractive programs should quit when you press <code>Ctrl-C</code></a></li>
<li><a href="#rule-2-tuis-should-quit-when-you-press-q">rule 2: TUIs should quit when you press <code>q</code></a></li>
<li><a href="#rule-3-repls-should-quit-when-you-press-ctrl-d-on-an-empty-line">rule 3: REPLs should quit when you press <code>Ctrl-D</code> on an empty line</a></li>
<li><a href="#rule-4-don-t-use-more-than-16-colours">rule 4: don&rsquo;t use more than 16 colours</a></li>
<li><a href="#rule-5-vaguely-support-readline-keybindings">rule 5: vaguely support readline keybindings</a></li>
<li><a href="#rule-5-1-ctrl-w-should-delete-the-last-word">rule 5.1: <code>Ctrl-W</code> should delete the last word</a></li>
<li><a href="#rule-6-disable-colours-when-writing-to-a-pipe">rule 6: disable colours when writing to a pipe</a></li>
<li><a href="#rule-7-means-stdin-stdout">rule 7: <code>-</code> means stdin/stdout</a></li>
<li><a href="#these-rules-take-a-long-time-to-learn">these &ldquo;rules&rdquo; take a long time to learn</a></li>
</ul>
<h3 id="programs-behave-surprisingly-consistently">programs behave surprisingly consistently</h3>
<p>As far as I know, there are no real standards for how programs in the terminal
should behave &ndash; the closest things I know of are:</p>
<ul>
<li>POSIX, which mostly dictates how your terminal emulator / OS / shell should
work together. I think it does specify a few things about how core utilities like
<code>cp</code> should work but AFAIK it doesn&rsquo;t have anything to say about how for
example <code>htop</code> should behave.</li>
<li>these <a href="https://clig.dev/">command line interface guidelines</a></li>
</ul>
<p>But even though there are no standards, in my experience programs in the
terminal behave in a pretty consistent way. So I wanted to write down a list of
&ldquo;rules&rdquo; that in my experience programs mostly follow.</p>
<h3 id="these-are-meant-to-be-descriptive-not-prescriptive">these are meant to be descriptive, not prescriptive</h3>
<p>My goal here isn&rsquo;t to convince authors of terminal programs that they <em>should</em>
follow any of these rules. There are lots of exceptions to these and often
there&rsquo;s a good reason for those exceptions.</p>
<p>But it&rsquo;s very useful for me to know what behaviour to expect from a random new
terminal program that I&rsquo;m using. Instead of &ldquo;uh, programs could do literally
anything&rdquo;, it&rsquo;s &ldquo;ok, here are the basic rules I expect, and then I can keep a
short mental list of exceptions&rdquo;.</p>
<p>So I&rsquo;m just writing down what I&rsquo;ve observed about how programs behave in my 20
years of using the terminal, why I think they behave that way, and some
examples of cases where that rule is &ldquo;broken&rdquo;.</p>
<h3 id="it-s-not-always-obvious-which-rules-are-the-program-s-responsibility-to-implement">it&rsquo;s not always obvious which &ldquo;rules&rdquo; are the program&rsquo;s responsibility to implement</h3>
<p>There are a bunch of common conventions that I think are pretty clearly the
program&rsquo;s responsibility to implement, like:</p>
<ul>
<li>config files should go in <code>~/.BLAHrc</code> or <code>~/.config/BLAH/FILE</code> or <code>/etc/BLAH/</code> or something</li>
<li><code>--help</code> should print help text</li>
<li>programs should print &ldquo;regular&rdquo; output to stdout and errors to stderr</li>
</ul>
<p>But in this post I&rsquo;m going to focus on things that it&rsquo;s not 100% obvious are
the program&rsquo;s responsibility. For example it feels to me like a &ldquo;law of nature&rdquo;
that pressing <code>Ctrl-D</code> should quit a REPL, but programs often
need to explicitly implement support for it &ndash; even though <code>cat</code> doesn&rsquo;t need
to implement <code>Ctrl-D</code> support, <code>ipython</code> <a href="https://github.com/prompt-toolkit/python-prompt-toolkit/blob/a2a12300c635ab3c051566e363ed27d853af4b21/src/prompt_toolkit/shortcuts/prompt.py#L824-L837">does</a>. (more about that in &ldquo;rule 3&rdquo; below)</p>
<p>Understanding which things are the program&rsquo;s responsibility makes it much less
surprising when different programs&rsquo; implementations are slightly different.</p>
<h3 id="rule-1-noninteractive-programs-should-quit-when-you-press-ctrl-c">rule 1: noninteractive programs should quit when you press <code>Ctrl-C</code></h3>
<p>The main reason for this rule is that noninteractive programs will quit by
default on <code>Ctrl-C</code> if they don&rsquo;t set up a <code>SIGINT</code> signal handler, so this is
kind of a &ldquo;you should act like the default&rdquo; rule.</p>
<p>Something that trips a lot of people up is that this doesn&rsquo;t apply to
<strong>interactive</strong> programs like <code>python3</code> or <code>bc</code> or <code>less</code>. This is because in
an interactive program, <code>Ctrl-C</code> has a different job &ndash; if the program is
running an operation (like for example a search in <code>less</code> or some Python code
in <code>python3</code>), then <code>Ctrl-C</code> will interrupt that operation but not stop the
program.</p>
<p>As an example of how this works in an interactive program: here&rsquo;s the code <a href="https://github.com/prompt-toolkit/python-prompt-toolkit/blob/a2a12300c635ab3c051566e363ed27d853af4b21/src/prompt_toolkit/key_binding/bindings/vi.py#L2225">in prompt-toolkit</a> (the library that iPython uses for handling input)
that aborts a search when you press <code>Ctrl-C</code>.</p>
<h3 id="rule-2-tuis-should-quit-when-you-press-q">rule 2: TUIs should quit when you press <code>q</code></h3>
<p>TUI programs (like <code>less</code> or <code>htop</code>) will usually quit when you press <code>q</code>.</p>
<p>This rule doesn&rsquo;t apply to any program where pressing <code>q</code> to quit wouldn&rsquo;t make
sense, like <code>tmux</code> or text editors.</p>
<h3 id="rule-3-repls-should-quit-when-you-press-ctrl-d-on-an-empty-line">rule 3: REPLs should quit when you press <code>Ctrl-D</code> on an empty line</h3>
<p>REPLs (like <code>python3</code> or <code>ed</code>) will usually quit when you press <code>Ctrl-D</code> on an
empty line. This rule is similar to the <code>Ctrl-C</code> rule &ndash; the reason for this is
that by default if you&rsquo;re running a program (like <code>cat</code>) in &ldquo;cooked mode&rdquo;, then
the operating system will return an <code>EOF</code> when you press <code>Ctrl-D</code> on an empty
line.</p>
<p>Most of the REPLs I use (sqlite3, python3, fish, bash, etc) don&rsquo;t actually use
cooked mode, but they all implement this keyboard shortcut anyway to mimic the
default behaviour.</p>
<p>For example, here&rsquo;s <a href="https://github.com/prompt-toolkit/python-prompt-toolkit/blob/a2a12300c635ab3c051566e363ed27d853af4b21/src/prompt_toolkit/shortcuts/prompt.py#L824-L837">the code in prompt-toolkit</a>
that quits when you press Ctrl-D, and here&rsquo;s <a href="https://github.com/bminor/bash/blob/6794b5478f660256a1023712b5fc169196ed0a22/lib/readline/readline.c#L658-L672">the same code in readline</a>.</p>
<p>I actually thought that this one was a &ldquo;Law of Terminal Physics&rdquo; until very
recently because I&rsquo;ve basically never seen it broken, but you can see that it&rsquo;s
just something that each individual input library has to implement in the links
above.</p>
<p>Someone pointed out that the Erlang REPL does not quit when you press <code>Ctrl-D</code>,
so I guess not every REPL follows this &ldquo;rule&rdquo;.</p>
<h3 id="rule-4-don-t-use-more-than-16-colours">rule 4: don&rsquo;t use more than 16 colours</h3>
<p>Terminal programs rarely use colours other than the base 16 ANSI colours. This
is because if you specify colours with a hex code, it&rsquo;s very likely to clash
with some users&rsquo; background colour. For example if I print out some text as
<code>#EEEEEE</code>, it would be almost invisible on a white background, though it would
look fine on a dark background.</p>
<p>But if you stick to the default 16 base colours, you have a much better chance
that the user has configured those colours in their terminal emulator so that
they work reasonably well with their background color. Another reason to stick
to the default base 16 colours is that it makes less assumptions about what
colours the terminal emulator supports.</p>
<p>The only programs I usually see breaking this &ldquo;rule&rdquo; are text editors, for
example Helix by default will use a purple background which is not a default
ANSI colour. It seems fine for Helix to break this rule since Helix isn&rsquo;t a
&ldquo;core&rdquo; program and I assume any Helix user who doesn&rsquo;t like that colorscheme
will just change the theme.</p>
<h3 id="rule-5-vaguely-support-readline-keybindings">rule 5: vaguely support readline keybindings</h3>
<p>Almost every program I use supports <code>readline</code> keybindings if it would make
sense to do so. For example, here are a bunch of different programs and a link
to where they define <code>Ctrl-E</code> to go to the end of the line:</p>
<ul>
<li>ipython (<a href="https://github.com/prompt-toolkit/python-prompt-toolkit/blob/a2a12300c635ab3c051566e363ed27d853af4b21/src/prompt_toolkit/key_binding/bindings/emacs.py#L72">Ctrl-E defined here</a>)</li>
<li>atuin (<a href="https://github.com/atuinsh/atuin/blob/a67cfc82fe0dc907a01f07a0fd625701e062a33b/crates/atuin/src/command/client/search/interactive.rs#L407">Ctrl-E defined here</a>)</li>
<li>fzf (<a href="https://github.com/junegunn/fzf/blob/bb55045596d6d08445f3c6d320c3ec2b457462d1/src/terminal.go#L611">Ctrl-E defined here</a>)</li>
<li>zsh (<a href="https://github.com/zsh-users/zsh/blob/86d5f24a3d28541f242eb3807379301ea976de87/Src/Zle/zle_bindings.c#L94">Ctrl-E defined here</a>)</li>
<li>fish (<a href="https://github.com/fish-shell/fish-shell/blob/99fa8aaaa7956178973150a03ce4954ab17a197b/share/functions/fish_default_key_bindings.fish#L43">Ctrl-E defined here</a>)</li>
<li>tmux&rsquo;s command prompt (<a href="https://github.com/tmux/tmux/blob/ae8f2208c98e3c2d6e3fe4cad2281dce8fd11f31/key-bindings.c#L490">Ctrl-E defined here</a>)</li>
</ul>
<p>None of those programs actually uses <code>readline</code> directly, they just sort of
mimic emacs/readline keybindings. They don&rsquo;t always mimic them <em>exactly</em>: for
example atuin seems to use <code>Ctrl-A</code> as a prefix, so <code>Ctrl-A</code> doesn&rsquo;t go to the
beginning of the line.</p>
<p>Also all of these programs seem to implement their own internal cut and paste
buffers so you can delete a line with <code>Ctrl-U</code> and then paste it with <code>Ctrl-Y</code>.</p>
<p>The exceptions to this are:</p>
<ul>
<li>some programs (like <code>git</code>, <code>cat</code>, and <code>nc</code>) don&rsquo;t have any line editing support at all (except for backspace, <code>Ctrl-W</code>, and <code>Ctrl-U</code>)</li>
<li>as usual text editors are an exception, every text editor has its own
approach to editing text</li>
</ul>
<p>I wrote more about this &ldquo;what keybindings does a program support?&rdquo; question in
<a href="https://jvns.ca/blog/2024/07/08/readline/">entering text in the terminal is complicated</a>.</p>
<h3 id="rule-5-1-ctrl-w-should-delete-the-last-word">rule 5.1: Ctrl-W should delete the last word</h3>
<p>I&rsquo;ve never seen a program (other than a text editor) where <code>Ctrl-W</code> <em>doesn&rsquo;t</em>
delete the last word. This is similar to the <code>Ctrl-C</code> rule &ndash; by default if a
program is in &ldquo;cooked mode&rdquo;, the OS will delete the last word if you press
<code>Ctrl-W</code>, and delete the whole line if you press <code>Ctrl-U</code>. So usually programs
will imitate that behaviour.</p>
<p>I can&rsquo;t think of any exceptions to this other than text editors but if there
are I&rsquo;d love to hear about them!</p>
<h3 id="rule-6-disable-colours-when-writing-to-a-pipe">rule 6: disable colours when writing to a pipe</h3>
<p>Most programs will disable colours when writing to a pipe. For example:</p>
<ul>
<li><code>rg blah</code> will highlight all occurrences of <code>blah</code> in the output, but if the
output is to a pipe or a file, it&rsquo;ll turn off the highlighting.</li>
<li><code>ls --color=auto</code> will use colour when writing to a terminal, but not when
writing to a pipe</li>
</ul>
<p>Both of those programs will also format their output differently when writing
to the terminal: <code>ls</code> will organize files into columns, and ripgrep will group
matches with headings.</p>
<p>If you want to force the program to use colour (for example because you want to
look at the colour), you can use <code>unbuffer</code> to force the program&rsquo;s output to be
a tty like this:</p>
<pre><code>unbuffer rg blah |  less -R
</code></pre>
<p>I&rsquo;m sure that there are some programs that &ldquo;break&rdquo; this rule but I can&rsquo;t think
of any examples right now. Some programs have an <code>--color</code> flag that you can
use to force colour to be on, in the example above you could also do <code>rg --color=always | less -R</code>.</p>
<h3 id="rule-7-means-stdin-stdout">rule 7: <code>-</code> means stdin/stdout</h3>
<p>Usually if you pass <code>-</code> to a program instead of a filename, it&rsquo;ll read from
stdin or write to stdout (whichever is appropriate). For example, if you want
to format the Python code that&rsquo;s on your clipboard with <code>black</code> and then copy
it, you could run:</p>
<pre><code>pbpaste | black - | pbcopy
</code></pre>
<p>(<code>pbpaste</code> is a Mac program, you can do something similar on Linux with <code>xclip</code>)</p>
<p>My impression is that most programs implement this if it would make sense and I
can&rsquo;t think of any exceptions right now, but I&rsquo;m sure there are many
exceptions.</p>
<h3 id="these-rules-take-a-long-time-to-learn">these &ldquo;rules&rdquo; take a long time to learn</h3>
<p>These rules took me a long time for me to learn because I had to:</p>
<ol>
<li>learn that the rule applied anywhere at all (&quot;<code>Ctrl-C</code> will exit programs&quot;)</li>
<li>notice some exceptions (&ldquo;okay, <code>Ctrl-C</code> will exit <code>find</code> but not <code>less</code>&rdquo;)</li>
<li>subconsciously figure out what the pattern is (&quot;<code>Ctrl-C</code> will generally quit
noninteractive programs, but in interactive programs it might interrupt the
current operation instead of quitting the program&quot;)</li>
<li>eventually maybe formulate it into an explicit rule that I know</li>
</ol>
<p>A lot of my understanding of the terminal is honestly still in the
&ldquo;subconscious pattern recognition&rdquo; stage. The only reason I&rsquo;ve been taking the
time to make things explicit at all is because I&rsquo;ve been trying to explain how
it works to others. Hopefully writing down these &ldquo;rules&rdquo; explicitly will make
learning some of this stuff a little bit faster for others.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why pipes sometimes get "stuck": buffering]]></title>
    <link href="https://jvns.ca/blog/2024/11/29/why-pipes-get-stuck-buffering/"/>
    <updated>2024-11-29T08:23:31+00:00</updated>
    <id>https://jvns.ca/blog/2024/11/29/why-pipes-get-stuck-buffering/</id>
    <content type="html"><![CDATA[<p>Here&rsquo;s a niche terminal problem that has bothered me for years but that I never
really understood until a few weeks ago. Let&rsquo;s say you&rsquo;re running this command
to watch for some specific output in a log file:</p>
<pre><code>tail -f /some/log/file | grep thing1 | grep thing2
</code></pre>
<p>If log lines are being added to the file relatively slowly, the result I&rsquo;d see
is&hellip; nothing! It doesn&rsquo;t matter if there were matches in the log file or not,
there just wouldn&rsquo;t be any output.</p>
<p>I internalized this as &ldquo;uh, I guess pipes just get stuck sometimes and don&rsquo;t
show me the output, that&rsquo;s weird&rdquo;, and I&rsquo;d handle it by just
running <code>grep thing1 /some/log/file | grep thing2</code> instead, which would work.</p>
<p>So as I&rsquo;ve been doing a terminal deep dive over the last few months I was
really excited to finally learn exactly why this happens.</p>
<h3 id="why-this-happens-buffering">why this happens: buffering</h3>
<p>The reason why &ldquo;pipes get stuck&rdquo; sometimes is that it&rsquo;s VERY common for
programs to buffer their output before writing it to a pipe or file. So the
pipe is working fine, the problem is that the program never even wrote the data
to the pipe!</p>
<p>This is for performance reasons: writing all output immediately as soon as you
can uses more system calls, so it&rsquo;s more efficient to save up data until you
have 8KB or so of data to write (or until the program exits) and THEN write it
to the pipe.</p>
<p>In this example:</p>
<pre><code>tail -f /some/log/file | grep thing1 | grep thing2
</code></pre>
<p>the problem is that <code>grep thing1</code> is saving up all of its matches until it has
8KB of data to write, which might literally never happen.</p>
<h3 id="programs-don-t-buffer-when-writing-to-a-terminal">programs don&rsquo;t buffer when writing to a terminal</h3>
<p>Part of why I found this so disorienting is that <code>tail -f file | grep thing</code>
will work totally fine, but then when you add the second <code>grep</code>, it stops
working!! The reason for this is that the way <code>grep</code> handles buffering depends
on whether it&rsquo;s writing to a terminal or not.</p>
<p>Here&rsquo;s how <code>grep</code> (and many other programs) decides to buffer its output:</p>
<ul>
<li>Check if stdout is a terminal or not using the <code>isatty</code> function
<ul>
<li>If it&rsquo;s a terminal, use line buffering (print every line immediately as soon as you have it)</li>
<li>Otherwise, use &ldquo;block buffering&rdquo; &ndash; only print data if you have at least 8KB or so of data to print</li>
</ul>
</li>
</ul>
<p>So if <code>grep</code> is writing directly to your terminal then you&rsquo;ll see the line as
soon as it&rsquo;s printed, but if it&rsquo;s writing to a pipe, you won&rsquo;t.</p>
<p>Of course the buffer size isn&rsquo;t always 8KB for every program, it depends on the implementation. For <code>grep</code> the buffering is handled by libc, and libc&rsquo;s buffer size is
defined in the <code>BUFSIZ</code> variable. <a href="https://github.com/bminor/glibc/blob/c69e8cccaff8f2d89cee43202623b33e6ef5d24a/libio/stdio.h#L100">Here&rsquo;s where that&rsquo;s defined in glibc</a>.</p>
<p>(as an aside: &ldquo;programs do not use 8KB output buffers when writing to a
terminal&rdquo; isn&rsquo;t, like, a law of terminal physics, a program COULD use an 8KB
buffer when writing output to a terminal if it wanted, it would just be
extremely weird if it did that, I can&rsquo;t think of any program that behaves that
way)</p>
<h3 id="commands-that-buffer-commands-that-don-t">commands that buffer &amp; commands that don&rsquo;t</h3>
<p>One annoying thing about this buffering behaviour is that you kind of need to
remember which commands buffer their output when writing to a pipe.</p>
<p>Some commands that <strong>don&rsquo;t</strong> buffer their output:</p>
<ul>
<li>tail</li>
<li>cat</li>
<li>tee</li>
</ul>
<p>I think almost everything else will buffer output, especially if it&rsquo;s a command
where you&rsquo;re likely to be using it for batch processing. Here&rsquo;s a list of some
common commands that buffer their output when writing to a pipe, along with the
flag that disables block buffering.</p>
<ul>
<li>grep (<code>--line-buffered</code>)</li>
<li>sed (<code>-u</code>)</li>
<li>awk (there&rsquo;s a <code>fflush()</code> function)</li>
<li>tcpdump (<code>-l</code>)</li>
<li>jq (<code>-u</code>)</li>
<li>tr (<code>-u</code>)</li>
<li>cut (can&rsquo;t disable buffering)</li>
</ul>
<p>Those are all the ones I can think of, lots of unix commands (like <code>sort</code>) may
or may not buffer their output but it doesn&rsquo;t matter because <code>sort</code> can&rsquo;t do
anything until it finishes receiving input anyway.</p>
<p>Also I did my best to test both the Mac OS and GNU versions of these but there
are a lot of variations and I might have made some mistakes.</p>
<h3 id="programming-languages-where-the-default-print-statement-buffers">programming languages where the default &ldquo;print&rdquo; statement buffers</h3>
<p>Also, here are a few programming language where the default print statement
will buffer output when writing to a pipe, and some ways to disable buffering
if you want:</p>
<ul>
<li>C (disable with <code>setvbuf</code>)</li>
<li>Python (disable with <code>python -u</code>, or <code>PYTHONUNBUFFERED=1</code>, or <code>sys.stdout.reconfigure(line_buffering=False)</code>, or <code>print(x, flush=True)</code>)</li>
<li>Ruby (disable with <code>STDOUT.sync = true</code>)</li>
<li>Perl (disable with <code>$| = 1</code>)</li>
</ul>
<p>I assume that these languages are designed this way so that the default print
function will be fast when you&rsquo;re doing batch processing.</p>
<p>Also whether output is buffered or not might depend on how you print, for
example in C++ <code>cout &lt;&lt; &quot;hello\n&quot;</code> buffers when writing to a pipe but <code>cout &lt;&lt; &quot;hello&quot; &lt;&lt; endl</code> will flush its output.</p>
<h3 id="when-you-press-ctrl-c-on-a-pipe-the-contents-of-the-buffer-are-lost">when you press <code>Ctrl-C</code> on a pipe, the contents of the buffer are lost</h3>
<p>Let&rsquo;s say you&rsquo;re running this command as a hacky way to watch for DNS requests
to <code>example.com</code>, and you forgot to pass <code>-l</code> to tcpdump:</p>
<pre><code>sudo tcpdump -ni any port 53 | grep example.com
</code></pre>
<p>When you press <code>Ctrl-C</code>, what happens? In a magical perfect world, what I would
<em>want</em> to happen is for <code>tcpdump</code> to flush its buffer, <code>grep</code> would search for
<code>example.com</code>, and I would see all the output I missed.</p>
<p>But in the real world, what happens is that all the programs get killed and the
output in <code>tcpdump</code>&rsquo;s buffer is lost.</p>
<p>I think this problem is probably unavoidable &ndash; I spent a little time with
<code>strace</code> to see how this works and <code>grep</code> receives the <code>SIGINT</code> before
<code>tcpdump</code> anyway so even if <code>tcpdump</code> tried to flush its buffer <code>grep</code> would
already be dead.</p>
<small>
<p>After a little more investigation, there is a workaround: if you find
<code>tcpdump</code>&rsquo;s PID and <code>kill -TERM $PID</code>, then tcpdump will flush the buffer so
you can see the output. That&rsquo;s kind of a pain but I tested it and it seems to
work.</p>
</small>
<h3 id="redirecting-to-a-file-also-buffers">redirecting to a file also buffers</h3>
<p>It&rsquo;s not just pipes, this will also buffer:</p>
<pre><code>sudo tcpdump -ni any port 53 &gt; output.txt
</code></pre>
<p>Redirecting to a file doesn&rsquo;t have the same &ldquo;<code>Ctrl-C</code> will totally destroy the
contents of the buffer&rdquo; problem though &ndash; in my experience it usually behaves
more like you&rsquo;d want, where the contents of the buffer get written to the file
before the program exits. I&rsquo;m not 100% sure whether this is something you can
always rely on or not.</p>
<h3 id="a-bunch-of-potential-ways-to-avoid-buffering">a bunch of potential ways to avoid buffering</h3>
<p>Okay, let&rsquo;s talk solutions. Let&rsquo;s say you&rsquo;ve run this command:</p>
<pre><code>tail -f /some/log/file | grep thing1 | grep thing2
</code></pre>
<p>I asked people on Mastodon how they would solve this in practice and there were
5 basic approaches. Here they are:</p>
<h4 id="solution-1-run-a-program-that-finishes-quickly">solution 1: run a program that finishes quickly</h4>
<p>Historically my solution to this has been to just avoid the &ldquo;command writing to
pipe slowly&rdquo; situation completely and instead run a program that will finish quickly
like this:</p>
<pre><code>cat /some/log/file | grep thing1 | grep thing2 | tail
</code></pre>
<p>This doesn&rsquo;t do the same thing as the original command but it does mean that
you get to avoid thinking about these weird buffering issues.</p>
<p>(you could also do <code>grep thing1 /some/log/file</code> but I often prefer to use an
&ldquo;unnecessary&rdquo; <code>cat</code>)</p>
<h4 id="solution-2-remember-the-line-buffer-flag-to-grep">solution 2: remember the &ldquo;line buffer&rdquo; flag to grep</h4>
<p>You could remember that grep has a flag to avoid buffering and pass it like this:</p>
<pre><code>tail -f /some/log/file | grep --line-buffered thing1 | grep thing2
</code></pre>
<h4 id="solution-3-use-awk">solution 3: use awk</h4>
<p>Some people said that if they&rsquo;re specifically dealing with a multiple greps
situation, they&rsquo;ll rewrite it to use a single <code>awk</code> instead, like this:</p>
<pre><code>tail -f /some/log/file |  awk '/thing1/ &amp;&amp; /thing2/'
</code></pre>
<p>Or you would write a more complicated <code>grep</code>, like this:</p>
<pre><code>tail -f /some/log/file |  grep -E 'thing1.*thing2'
</code></pre>
<p>(<code>awk</code> also buffers, so for this to work you&rsquo;ll want <code>awk</code> to be the last command in the pipeline)</p>
<h4 id="solution-4-use-stdbuf">solution 4: use <code>stdbuf</code></h4>
<p><code>stdbuf</code> uses LD_PRELOAD to turn off libc&rsquo;s buffering, and you can use it to turn off output buffering like this:</p>
<pre><code>tail -f /some/log/file | stdbuf -o0 grep thing1 | grep thing2
</code></pre>
<p>Like any <code>LD_PRELOAD</code> solution it&rsquo;s a bit unreliable &ndash; it doesn&rsquo;t work on
static binaries, I think won&rsquo;t work if the program isn&rsquo;t using libc&rsquo;s
buffering, and doesn&rsquo;t always work on Mac OS. Harry Marr has a really nice <a href="https://hmarr.com/blog/how-stdbuf-works/">How stdbuf works</a> post.</p>
<h4 id="solution-5-use-unbuffer">solution 5: use <code>unbuffer</code></h4>
<p><code>unbuffer program</code> will force the program&rsquo;s output to be a TTY, which means
that it&rsquo;ll behave the way it normally would on a TTY (less buffering, colour
output, etc). You could use it in this example like this:</p>
<pre><code>tail -f /some/log/file | unbuffer grep thing1 | grep thing2
</code></pre>
<p>Unlike <code>stdbuf</code> it will always work, though it might have unwanted side
effects, for example <code>grep thing1</code>&rsquo;s will also colour matches.</p>
<p>If you want to install unbuffer, it&rsquo;s in the <code>expect</code> package.</p>
<h3 id="that-s-all-the-solutions-i-know-about">that&rsquo;s all the solutions I know about!</h3>
<p>It&rsquo;s a bit hard for me to say which one is &ldquo;best&rdquo;, I think personally I&rsquo;m
mostly likely to use <code>unbuffer</code> because I know it&rsquo;s always going to work.</p>
<p>If I learn about more solutions I&rsquo;ll try to add them to this post.</p>
<h3 id="i-m-not-really-sure-how-often-this-comes-up">I&rsquo;m not really sure how often this comes up</h3>
<p>I think it&rsquo;s not very common for me to have a program that slowly trickles data
into a pipe like this, normally if I&rsquo;m using a pipe a bunch of data gets
written very quickly, processed by everything in the pipeline, and then
everything exits. The only examples I can come up with right now are:</p>
<ul>
<li>tcpdump</li>
<li><code>tail -f</code></li>
<li>watching log files in a different way like with <code>kubectl logs</code></li>
<li>the output of a slow computation</li>
</ul>
<h3 id="what-if-there-were-an-environment-variable-to-disable-buffering">what if there were an environment variable to disable buffering?</h3>
<p>I think it would be cool if there were a standard environment variable to turn
off buffering, like <code>PYTHONUNBUFFERED</code> in Python. I got this idea from a
<a href="https://blog.plover.com/Unix/stdio-buffering.html">couple</a> of <a href="https://blog.plover.com/Unix/stdio-buffering-2.html">blog posts</a> by Mark Dominus
in 2018. Maybe <code>NO_BUFFER</code> like <a href="https://no-color.org/">NO_COLOR</a>?</p>
<p>The design seems tricky to get right; Mark points out that NETBSD has <a href="https://man.netbsd.org/setbuf.3">environment variables called <code>STDBUF</code>, <code>STDBUF1</code>, etc</a> which gives you a
ton of control over buffering but I imagine most developers don&rsquo;t want to
implement many different environment variables to handle a relatively minor
edge case.</p>
<p>I&rsquo;m also curious about whether there are any programs that just automatically
flush their output buffers after some period of time (like 1 second). It feels
like it would be nice in theory but I can&rsquo;t think of any program that does that
so I imagine there are some downsides.</p>
<h3 id="stuff-i-left-out">stuff I left out</h3>
<p>Some things I didn&rsquo;t talk about in this post since these posts have been
getting pretty long recently and seriously does anyone REALLY want to read 3000
words about buffering?</p>
<ul>
<li>the difference between line buffering and having totally unbuffered output</li>
<li>how buffering to stderr is different from buffering to stdout</li>
<li>this post is only about buffering that happens <strong>inside the program</strong>, your
operating system&rsquo;s TTY driver also does a little bit of buffering sometimes</li>
<li>other reasons you might need to flush your output other than &ldquo;you&rsquo;re writing
to a pipe&rdquo;</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Importing a frontend Javascript library without a build system]]></title>
    <link href="https://jvns.ca/blog/2024/11/18/how-to-import-a-javascript-library/"/>
    <updated>2024-11-18T09:35:42+00:00</updated>
    <id>https://jvns.ca/blog/2024/11/18/how-to-import-a-javascript-library/</id>
    <content type="html"><![CDATA[<p>I like writing Javascript <a href="https://jvns.ca/blog/2023/02/16/writing-javascript-without-a-build-system/">without a build system</a>
and for the millionth time yesterday I ran into a problem where I needed to
figure out how to import a Javascript library in my code without using a build
system, and it took FOREVER to figure out how to import it because the
library&rsquo;s setup instructions assume that you&rsquo;re using a build system.</p>
<p>Luckily at this point I&rsquo;ve mostly learned how to navigate this situation and
either successfully use the library or decide it&rsquo;s too difficult and switch to
a different library, so here&rsquo;s the guide I wish I had to importing Javascript
libraries years ago.</p>
<p>I&rsquo;m only going to talk about using Javacript libraries on the frontend, and
only about how to use them in a no-build-system setup.</p>
<p>In this post I&rsquo;m going to talk about:</p>
<ol>
<li>the three main types of Javascript files a library might provide (ES Modules, the &ldquo;classic&rdquo; global variable kind, and CommonJS)</li>
<li>how to figure out which types of files a Javascript library includes in its build</li>
<li>ways to import each type of file in your code</li>
</ol>
<h3 id="the-three-kinds-of-javascript-files">the three kinds of Javascript files</h3>
<p>There are 3 basic types of Javascript files a library can provide:</p>
<ol>
<li>the &ldquo;classic&rdquo; type of file that defines a global variable. This is the kind
of file that you can just <code>&lt;script src&gt;</code> and it&rsquo;ll Just Work. Great if you
can get it but not always available</li>
<li>an ES module (which may or may not depend on other files, we&rsquo;ll get to that)</li>
<li>a &ldquo;CommonJS&rdquo; module. This is for Node, you can&rsquo;t use it in a browser at all
without using a build system.</li>
</ol>
<p>I&rsquo;m not sure if there&rsquo;s a better name for the &ldquo;classic&rdquo; type but I&rsquo;m just going
to call it &ldquo;classic&rdquo;. Also there&rsquo;s a type called &ldquo;AMD&rdquo; but I&rsquo;m not sure how
relevant it is in 2024.</p>
<p>Now that we know the 3 types of files, let&rsquo;s talk about how to figure out which
of these the library actually provides!</p>
<h3 id="where-to-find-the-files-the-npm-build">where to find the files: the NPM build</h3>
<p>Every Javascript library has a <strong>build</strong> which it uploads to NPM. You might be
thinking (like I did originally) &ndash; Julia! The whole POINT is that we&rsquo;re not
using Node to build our library! Why are we talking about NPM?</p>
<p>But if you&rsquo;re using a link from a CDN like <a href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js">https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js</a>,
you&rsquo;re still using the NPM build! All the files on the CDNs originally come
from NPM.</p>
<p>Because of this, I sometimes like to <code>npm install</code> the library even if I&rsquo;m not
planning to use Node to build my library at all &ndash; I&rsquo;ll just create a new temp
folder, <code>npm install</code> there, and then delete it when I&rsquo;m done. I like being able to poke
around in the files in the NPM build on my filesystem, because then I can be
100% sure that I&rsquo;m seeing everything that the library is making available in
its build and that the CDN isn&rsquo;t hiding something from me.</p>
<p>So let&rsquo;s <code>npm install</code> a few libraries and try to figure out what types of
Javascript files they provide in their builds!</p>
<h3 id="example-library-1-chart-js">example library 1: chart.js</h3>
<p>First let&rsquo;s look inside <a href="https://www.chartjs.org">Chart.js</a>, a plotting library.</p>
<pre><code>$ cd /tmp/whatever
$ npm install chart.js
$ cd node_modules/chart.js/dist
$ ls *.*js
chart.cjs  chart.js  chart.umd.js  helpers.cjs  helpers.js
</code></pre>
<p>This library seems to have 3 basic options:</p>
<p><strong>option 1:</strong> <code>chart.cjs</code>. The <code>.cjs</code> suffix tells me that this is a <strong>CommonJS
file</strong>, for using in Node. This means it&rsquo;s impossible to use it directly in the
browser without some kind of build step.</p>
<p><strong>option 2:<code>chart.js</code></strong>. The <code>.js</code> suffix by itself doesn&rsquo;t tell us what kind of
file it is, but if I open it up, I see <code>import '@kurkle/color';</code> which is an
immediate sign that this is an ES module &ndash; the <code>import ...</code> syntax is ES
module syntax.</p>
<p><strong>option 3: <code>chart.umd.js</code></strong>. &ldquo;UMD&rdquo; stands for &ldquo;Universal Module Definition&rdquo;,
which I think means that you can use this file either with a basic <code>&lt;script src&gt;</code>, CommonJS,
or some third thing called AMD that I don&rsquo;t understand.</p>
<h3 id="how-to-use-a-umd-file">how to use a UMD file</h3>
<p>When I was using Chart.js I picked Option 3. I just needed to add this to my
code:</p>
<pre><code>&lt;script src=&quot;./chart.umd.js&quot;&gt; &lt;/script&gt;
</code></pre>
<p>and then I could use the library with the global <code>Chart</code> environment variable.
Couldn&rsquo;t be easier. I just copied <code>chart.umd.js</code> into my Git repository so that
I didn&rsquo;t have to worry about using NPM or the CDNs going down or anything.</p>
<h3 id="the-build-files-aren-t-always-in-the-dist-directory">the build files aren&rsquo;t always in the <code>dist</code> directory</h3>
<p>A lot of libraries will put their build in the <code>dist</code> directory, but not
always! The build files&rsquo; location is specified in the library&rsquo;s <code>package.json</code>.</p>
<p>For example here&rsquo;s an excerpt from Chart.js&rsquo;s <code>package.json</code>.</p>
<pre><code>  &quot;jsdelivr&quot;: &quot;./dist/chart.umd.js&quot;,
  &quot;unpkg&quot;: &quot;./dist/chart.umd.js&quot;,
  &quot;main&quot;: &quot;./dist/chart.cjs&quot;,
  &quot;module&quot;: &quot;./dist/chart.js&quot;,
</code></pre>
<p>I think this is saying that if you want to use an ES Module (<code>module</code>) you
should use <code>dist/chart.js</code>, but the jsDelivr and unpkg CDNs should use
<code>./dist/chart.umd.js</code>. I guess <code>main</code> is for Node.</p>
<p><code>chart.js</code>&rsquo;s <code>package.json</code> also says <code>&quot;type&quot;: &quot;module&quot;</code>, which <a href="https://nodejs.org/api/packages.html#modules-packages">according to this documentation</a>
tells Node to treat files as ES modules by default. I think it doesn&rsquo;t tell us
specifically which files are ES modules and which ones aren&rsquo;t but it does tell
us that <em>something</em> in there is an ES module.</p>
<h3 id="example-library-2-atcute-oauth-browser-client">example library 2: <code>@atcute/oauth-browser-client</code></h3>
<p><a href="https://github.com/mary-ext/atcute/tree/trunk/packages/oauth/browser-client"><code>@atcute/oauth-browser-client</code></a>
is a library for logging into Bluesky with OAuth in the browser.</p>
<p>Let&rsquo;s see what kinds of Javascript files it provides in its build!</p>
<pre><code>$ npm install @atcute/oauth-browser-client
$ cd node_modules/@atcute/oauth-browser-client/dist
$ ls *js
constants.js  dpop.js  environment.js  errors.js  index.js  resolvers.js
</code></pre>
<p>It seems like the only plausible root file in here is <code>index.js</code>, which looks
something like this:</p>
<pre><code>export { configureOAuth } from './environment.js';
export * from './errors.js';
export * from './resolvers.js';
</code></pre>
<p>This <code>export</code> syntax means it&rsquo;s an <strong>ES module</strong>. That means we can use it in
the browser without a build step! Let&rsquo;s see how to do that.</p>
<h3 id="how-to-use-an-es-module-with-importmaps">how to use an ES module with importmaps</h3>
<p>Using an ES module isn&rsquo;t an easy as just adding a <code>&lt;script src=&quot;whatever.js&quot;&gt;</code>. Instead, if
the ES module has dependencies (like <code>@atcute/oauth-browser-client</code> does) the
steps are:</p>
<ol>
<li>Set up an import map in your HTML</li>
<li>Put import statements like <code>import { configureOAuth } from '@atcute/oauth-browser-client';</code> in your JS code</li>
<li>Include your JS code in your HTML like this: <code>&lt;script type=&quot;module&quot; src=&quot;YOURSCRIPT.js&quot;&gt;&lt;/script&gt;</code></li>
</ol>
<p>The reason we need an import map instead of just doing something like <code>import { BrowserOAuthClient } from &quot;./oauth-client-browser.js&quot;</code> is that internally the module has more import statements like <code>import {something} from @atcute/client</code>, and we need to tell the browser where to get the code for <code>@atcute/client</code> and all of its other dependencies.</p>
<p>Here&rsquo;s what the importmap I used looks like for <code>@atcute/oauth-browser-client</code>:</p>
<pre><code>&lt;script type=&quot;importmap&quot;&gt;
{
  &quot;imports&quot;: {
    &quot;nanoid&quot;: &quot;./node_modules/nanoid/bin/dist/index.js&quot;,
    &quot;nanoid/non-secure&quot;: &quot;./node_modules/nanoid/non-secure/index.js&quot;,
    &quot;nanoid/url-alphabet&quot;: &quot;./node_modules/nanoid/url-alphabet/dist/index.js&quot;,
    &quot;@atcute/oauth-browser-client&quot;: &quot;./node_modules/@atcute/oauth-browser-client/dist/index.js&quot;,
    &quot;@atcute/client&quot;: &quot;./node_modules/@atcute/client/dist/index.js&quot;,
    &quot;@atcute/client/utils/did&quot;: &quot;./node_modules/@atcute/client/dist/utils/did.js&quot;
  }
}
&lt;/script&gt;
</code></pre>
<p>Getting these import maps to work is pretty fiddly, I feel like there must be a
tool to generate them automatically but I haven&rsquo;t found one yet. It&rsquo;s definitely possible to
write a script that automatically generates the importmaps using <a href="https://esbuild.github.io/api/#metafile">esbuild&rsquo;s metafile</a> but I haven&rsquo;t done that and
maybe there&rsquo;s a better way.</p>
<p>I decided to set up importmaps yesterday to get
<a href="https://github.com/jvns/bsky-oauth-example">github.com/jvns/bsky-oauth-example</a>
to work, so there&rsquo;s some example code in that repo.</p>
<p>Also someone pointed me to Simon Willison&rsquo;s
<a href="https://simonwillison.net/2023/May/2/download-esm/">download-esm</a>, which will
download an ES module and rewrite the imports to point to the JS files directly
so that you don&rsquo;t need importmaps. I haven&rsquo;t tried it yet but it seems like a
great idea.</p>
<h3 id="problems-with-importmaps-too-many-files">problems with importmaps: too many files</h3>
<p>I did run into some problems with using importmaps in the browser though &ndash; it
needed to download dozens of Javascript files to load my site, and my webserver
in development couldn&rsquo;t keep up for some reason. I kept seeing files fail to
load randomly and then had to reload the page and hope that they would succeed
this time.</p>
<p>It wasn&rsquo;t an issue anymore when I deployed my site to production, so I guess it
was a problem with my local dev environment.</p>
<p>Also one slightly annoying thing about ES modules in general is that you need to
be running a webserver to use them, I&rsquo;m sure this is for a good reason but it&rsquo;s
easier when you can just open your <code>index.html</code> file without starting a
webserver.</p>
<p>Because of the &ldquo;too many files&rdquo; thing I think actually using ES modules with
importmaps in this way isn&rsquo;t actually that appealing to me, but it&rsquo;s good to
know it&rsquo;s possible.</p>
<h3 id="how-to-use-an-es-module-without-importmaps">how to use an ES module without importmaps</h3>
<p>If the ES module doesn&rsquo;t have dependencies then it&rsquo;s even easier &ndash; you don&rsquo;t
need the importmaps! You can just:</p>
<ul>
<li>put <code>&lt;script type=&quot;module&quot; src=&quot;YOURCODE.js&quot;&gt;&lt;/script&gt;</code> in your HTML. The <code>type=&quot;module&quot;</code> is important.</li>
<li>put <code>import {whatever} from &quot;https://example.com/whatever.js&quot;</code> in <code>YOURCODE.js</code></li>
</ul>
<h3 id="alternative-use-esbuild">alternative: use esbuild</h3>
<p>If you don&rsquo;t want to use importmaps, you can also use a build system like <a href="https://esbuild.github.io/">esbuild</a>. I talked about how to do
that in <a href="https://jvns.ca/blog/2021/11/15/esbuild-vue/">Some notes on using esbuild</a>, but this blog post is
about ways to avoid build systems completely so I&rsquo;m not going to talk about
that option here. I do still like esbuild though and I think it&rsquo;s a good option
in this case.</p>
<h3 id="what-s-the-browser-support-for-importmaps">what&rsquo;s the browser support for importmaps?</h3>
<p><a href="https://caniuse.com/import-maps">CanIUse</a> says that importmaps are in
&ldquo;Baseline 2023: newly available across major browsers&rdquo; so my sense is that in
2024 that&rsquo;s still maybe a little bit too new? I think I would use importmaps
for some fun experimental code that I only wanted like myself and 12 people to
use, but if I wanted my code to be more widely usable I&rsquo;d use <code>esbuild</code> instead.</p>
<h3 id="example-library-3-atproto-oauth-client-browser">example library 3: <code>@atproto/oauth-client-browser</code></h3>
<p>Let&rsquo;s look at one final example library! This is a different Bluesky auth
library than <code>@atcute/oauth-browser-client</code>.</p>
<pre><code>$ npm install @atproto/oauth-client-browser
$ cd node_modules/@atproto/oauth-client-browser/dist
$ ls *js
browser-oauth-client.js  browser-oauth-database.js  browser-runtime-implementation.js  errors.js  index.js  indexed-db-store.js  util.js
</code></pre>
<p>Again, it seems like only real candidate file here is <code>index.js</code>. But this is a
different situation from the previous example library! Let&rsquo;s take a look at
<code>index.js</code>:</p>
<p>There&rsquo;s a bunch of stuff like this in <code>index.js</code>:</p>
<pre><code>__exportStar(require(&quot;@atproto/oauth-client&quot;), exports);
__exportStar(require(&quot;./browser-oauth-client.js&quot;), exports);
__exportStar(require(&quot;./errors.js&quot;), exports);
var util_js_1 = require(&quot;./util.js&quot;);
</code></pre>
<p>This <code>require()</code> syntax is CommonJS syntax, which means that we can&rsquo;t use this
file in the browser at all, we need to use some kind of build step, and
ESBuild won&rsquo;t work either.</p>
<p>Also in this library&rsquo;s <code>package.json</code> it says <code>&quot;type&quot;: &quot;commonjs&quot;</code> which is
another way to tell it&rsquo;s CommonJS.</p>
<h3 id="how-to-use-a-commonjs-module-with-esm-sh-https-esm-sh">how to use a CommonJS module with <a href="https://esm.sh">esm.sh</a></h3>
<p>Originally I thought it was impossible to use CommonJS modules without learning
a build system, but then someone Bluesky told me about
<a href="https://esm.sh">esm.sh</a>! It&rsquo;s a CDN that will translate anything into an ES
Module. <a href="https://www.skypack.dev/">skypack.dev</a> does something similar, I&rsquo;m not
sure what the difference is but one person mentioned that if one doesn&rsquo;t work
sometimes they&rsquo;ll try the other one.</p>
<p>For <code>@atproto/oauth-client-browser</code> using it seems pretty simple, I just need to put this in my HTML:</p>
<pre><code>&lt;script type=&quot;module&quot; src=&quot;script.js&quot;&gt; &lt;/script&gt;
</code></pre>
<p>and then put this in <code>script.js</code>.</p>
<pre><code>import { BrowserOAuthClient } from &quot;https://esm.sh/@atproto/oauth-client-browser@0.3.0&quot;
</code></pre>
<p>It seems to Just Work, which is cool! Of course this is still sort of using a
build system &ndash; it&rsquo;s just that esm.sh is running the build instead of me. My
main concerns with this approach are:</p>
<ul>
<li>I don&rsquo;t really trust CDNs to keep working forever &ndash; usually I like to copy dependencies into my repository so that they don&rsquo;t go away for some reason in the future.</li>
<li>I&rsquo;ve heard of some issues with CDNs having security compromises which scares me.</li>
<li>I don&rsquo;t really understand what esm.sh is doing.</li>
</ul>
<h3 id="esbuild-can-also-convert-commonjs-modules-into-es-modules">esbuild can also convert CommonJS modules into ES modules</h3>
<p>I also learned that you can also use <code>esbuild</code> to convert a CommonJS module
into an ES module, though there are some limitations &ndash; the <code>import { BrowserOAuthClient } from</code> syntax doesn&rsquo;t work. Here&rsquo;s a <a href="https://github.com/evanw/esbuild/issues/442">github issue about that</a>.</p>
<p>I think the <code>esbuild</code> approach is probably more appealing to me than the
<code>esm.sh</code> approach because it&rsquo;s a tool that I already have on my computer so I
trust it more. I haven&rsquo;t experimented with this much yet though.</p>
<h3 id="summary-of-the-three-types-of-files">summary of the three types of files</h3>
<p>Here&rsquo;s a summary of the three types of JS files you might encounter, options
for how to use them, and how to identify them.</p>
<p>Unhelpfully a <code>.js</code> or <code>.min.js</code> file extension could be any of these 3
options, so if the file is <code>something.js</code> you need to do more detective work to
figure out what you&rsquo;re dealing with.</p>
<ol>
<li><strong>&ldquo;classic&rdquo; JS files</strong>
<ul>
<li><strong>How to use it:</strong>: <code>&lt;script src=&quot;whatever.js&quot;&gt;&lt;/script&gt;</code></li>
<li><strong>Ways to identify it:</strong>
<ul>
<li>The website has a big friendly banner in its setup instructions saying &ldquo;Use this with a CDN!&rdquo;  or something</li>
<li>A <code>.umd.js</code> extension</li>
<li>Just try to put it in a <code>&lt;script src=...</code> tag and see if it works</li>
</ul>
</li>
</ul>
</li>
<li><strong>ES Modules</strong>
<ul>
<li><strong>Ways to use it:</strong>
<ul>
<li>If there are no dependencies, just <code>import {whatever} from &quot;./my-module.js&quot;</code> directly in your code</li>
<li>If there are dependencies, create an importmap and <code>import {whatever} from &quot;my-module&quot;</code>
<ul>
<li>or use <a href="https://simonwillison.net/2023/May/2/download-esm/">download-esm</a> to remove the need for an importmap</li>
</ul>
</li>
<li>Use <a href="https://esbuild.github.io/">esbuild</a> or any ES Module bundler</li>
</ul>
</li>
<li><strong>Ways to identify it:</strong>
<ul>
<li>Look for an <code>import </code> or <code>export </code> statement. (not <code>module.exports = ...</code>, that&rsquo;s CommonJS)</li>
<li>An <code>.mjs</code> extension</li>
<li>maybe <code>&quot;type&quot;: &quot;module&quot;</code> in <code>package.json</code> (though it&rsquo;s not clear to me which file exactly this refers to)</li>
</ul>
</li>
</ul>
</li>
<li><strong>CommonJS Modules</strong>
<ul>
<li><strong>Ways to use it:</strong>
<ul>
<li>Use <a href="https://esm.sh/#docs">https://esm.sh</a> to convert it into an ES module, like <code>https://esm.sh/@atproto/oauth-client-browser@0.3.0</code></li>
<li>Use a build somehow (??)</li>
</ul>
</li>
<li><strong>Ways to identify it:</strong>
<ul>
<li>Look for <code>require()</code> or <code>module.exports = ...</code> in the code</li>
<li>A <code>.cjs</code> extension</li>
<li>maybe <code>&quot;type&quot;: &quot;commonjs&quot;</code> in <code>package.json</code> (though it&rsquo;s not clear to me which file exactly this refers to)</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="it-s-really-nice-to-have-es-modules-standardized">it&rsquo;s really nice to have ES modules standardized</h3>
<p>The main difference between CommonJS modules and ES modules from my perspective
is that ES modules are actually a standard. This makes me feel a lot more
confident using them, because browsers commit to backwards compatibility for
web standards forever &ndash; if I write some code using ES modules today, I can
feel sure that it&rsquo;ll still work the same way in 15 years.</p>
<p>It also makes me feel better about using tooling like <code>esbuild</code> because even if
the esbuild project dies, because it&rsquo;s implementing a standard it feels likely
that there will be another similar tool in the future that I can replace it
with.</p>
<h3 id="the-js-community-has-built-a-lot-of-very-cool-tools">the JS community has built a lot of very cool tools</h3>
<p>A lot of the time when I talk about this stuff I get responses like &ldquo;I hate
javascript!!! it&rsquo;s the worst!!!&rdquo;. But my experience is that there are a lot of great tools for Javascript
(I just learned about <a href="https://esm.sh">https://esm.sh</a> yesterday which seems great! I love
esbuild!), and that if I take the time to learn how things works I can take
advantage of some of those tools and make my life a lot easier.</p>
<p>So the goal of this post is definitely not to complain about Javascript, it&rsquo;s
to understand the landscape so I can use the tooling in a way that feels good
to me.</p>
<h3 id="questions-i-still-have">questions I still have</h3>
<p>Here are some questions I still have, I&rsquo;ll add the answers into the post if I
learn the answer.</p>
<ul>
<li>Is there a tool that automatically generates importmaps for an ES Module that
I have set up locally? (apparently yes: <a href="https://jspm.org/getting-started">jspm</a>)</li>
<li>How can I convert a CommonJS module into an ES module on my computer, the way
<a href="https://esm.sh">https://esm.sh</a> does? (apparently esbuild can sort of do this, though <a href="https://github.com/evanw/esbuild/issues/442">named exports don&rsquo;t work</a>)</li>
<li>When people normally build CommonJS modules into regular JS code, what&rsquo;s code is
doing that? Obviously there are tools like webpack, rollup, esbuild, etc, but
do those tools all implement their own JS parsers/static analysis? How many
JS parsers are there out there?</li>
<li>Is there any way to bundle an ES module into a single file (like
<code>atcute-client.js</code>), but so that in the browser I can still import multiple
different paths from that file (like both <code>@atcute/client/lexicons</code> and
<code>@atcute/client</code>)?</li>
</ul>
<h3 id="all-the-tools">all the tools</h3>
<p>Here&rsquo;s a list of every tool we talked about in this post:</p>
<ul>
<li>Simon Willison&rsquo;s
<a href="https://simonwillison.net/2023/May/2/download-esm/">download-esm</a> which will
download an ES module and convert the imports to point at JS files so you
don&rsquo;t need an importmap</li>
<li><a href="esm.sh">https://esm.sh/</a> and <a href="https://www.skypack.dev/">skypack.dev</a></li>
<li><a href="https://esbuild.github.io/">esbuild</a></li>
<li><a href="https://jspm.org/getting-started">JSPM</a> can generate importmaps</li>
</ul>
<p>Writing this post has made me think that even though I usually don&rsquo;t want to
have a build that I run every time I update the project, I might be willing to
have a build step (using <code>download-esm</code> or something) that I run <strong>only once</strong>
when setting up the project and never run again except maybe if I&rsquo;m updating my
dependency versions.</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>Thanks to <a href="https://polotek.net/">Marco Rogers</a> who taught me a lot of the things
in this post. I&rsquo;ve probably made some mistakes in this post and I&rsquo;d love to
know what they are &ndash; let me know on Bluesky or Mastodon!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New microblog with TILs]]></title>
    <link href="https://jvns.ca/blog/2024/11/09/new-microblog/"/>
    <updated>2024-11-09T09:24:29+00:00</updated>
    <id>https://jvns.ca/blog/2024/11/09/new-microblog/</id>
    <content type="html"><![CDATA[<p>I added a new section to this site a couple weeks ago called
<a href="https://jvns.ca/til/">TIL</a> (&ldquo;today I learned&rdquo;).</p>
<h3 id="the-goal-save-interesting-tools-facts-i-posted-on-social-media">the goal: save interesting tools &amp; facts I posted on social media</h3>
<p>One kind of thing I like to post on Mastodon/Bluesky is &ldquo;hey, here&rsquo;s a cool
thing&rdquo;, like <a href="https://github.com/dbcli/litecli">the great SQLite repl litecli</a>, or
the fact that cross compiling in Go Just Works and it&rsquo;s amazing, or
<a href="https://www.latacora.com/blog/2018/04/03/cryptographic-right-answers/">cryptographic right answers</a>,
or <a href="https://diffdiff.net/">this great diff tool</a>. Usually I don&rsquo;t want to write
a whole blog post about those things because I really don&rsquo;t have much more to
say than &ldquo;hey this is useful!&rdquo;</p>
<p>It started to bother me that I didn&rsquo;t have anywhere to put those things: for
example recently I wanted to use <a href="https://diffdiff.net/">diffdiff</a> and I just
could not remember what it was called.</p>
<h3 id="the-solution-make-a-new-section-of-this-blog">the solution: make a new section of this blog</h3>
<p>So I quickly made a new folder called <a href="https://jvns.ca/til/">/til/</a>, added some
custom styling (I wanted to style the posts to look a little bit like a tweet),
made a little Rake task to help me create new posts quickly (<code>rake new_til</code>), and
set up a separate RSS Feed for it.</p>
<p>I think this new section of the blog might be more for myself than anything,
now when I forget the link to Cryptographic Right Answers I can hopefully look
it up on the TIL page. (you might think &ldquo;julia, why not use bookmarks??&rdquo; but I
have been failing to use bookmarks for my whole life and I don&rsquo;t see that
changing ever, putting things in public is for whatever reason much easier for
me)</p>
<p>So far it&rsquo;s been working, often I can actually just make a quick post in 2
minutes which was the goal.</p>
<h3 id="inspired-by-simon-willison-s-til-blog">inspired by Simon Willison&rsquo;s TIL blog</h3>
<p>My page is inspired by <a href="https://til.simonwillison.net/">Simon Willison&rsquo;s great TIL blog</a>, though my TIL posts are a lot shorter.</p>
<h3 id="i-don-t-necessarily-want-everything-to-be-archived">I don&rsquo;t necessarily want everything to be archived</h3>
<p>This came about because I spent a lot of time on Twitter, so I&rsquo;ve been thinking
about what I want to do about all of my tweets.</p>
<p>I keep reading the advice to &ldquo;POSSE&rdquo; (&ldquo;post on your own site, syndicate
elsewhere&rdquo;), and while I find the idea appealing in principle, for me part of
the appeal of social media is that it&rsquo;s a little bit ephemeral. I can
post polls or questions or observations or jokes and then they can just kind of
fade away as they become less relevant.</p>
<p>I find it a lot easier to identify specific categories of things that I actually
want to have on a Real Website That I Own:</p>
<ul>
<li>blog posts here!</li>
<li>comics at <a href="https://wizardzines.com/comics/">https://wizardzines.com/comics/</a>!</li>
<li>now TILs at <a href="https://jvns.ca/til/">https://jvns.ca/til/</a>)</li>
</ul>
<p>and then let everything else be kind of ephemeral.</p>
<p>I really believe in the advice to make email lists though &ndash; the first two
(blog posts &amp; comics) both have email lists and RSS feeds that people can
subscribe to if they want. I might add a quick summary of any TIL posts from
that week to the &ldquo;blog posts from this week&rdquo; mailing list.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASCII control characters in my terminal]]></title>
    <link href="https://jvns.ca/blog/2024/10/31/ascii-control-characters/"/>
    <updated>2024-10-31T08:00:10+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/31/ascii-control-characters/</id>
    <content type="html"><![CDATA[<p>Hello! I&rsquo;ve been thinking about the terminal a lot and yesterday I got curious
about all these &ldquo;control codes&rdquo;, like <code>Ctrl-A</code>, <code>Ctrl-C</code>, <code>Ctrl-W</code>, etc. What&rsquo;s
the deal with all of them?</p>
<h3 id="a-table-of-ascii-control-characters">a table of ASCII control characters</h3>
<p>Here&rsquo;s a table of all 33 ASCII control characters, and what they do on my
machine (on Mac OS), more or less. There are about a million caveats, but I&rsquo;ll talk about
what it means and all the problems with this diagram that I know about.</p>
<p><a href="https://jvns.ca/ascii.html"><img src="https://jvns.ca/images/ascii-control.png"></a></p>
<p>You can also view it <a href="https://jvns.ca/ascii.html">as an HTML page</a> (I just made it an image so
it would show up in RSS).</p>
<h3 id="different-kinds-of-codes-are-mixed-together">different kinds of codes are mixed together</h3>
<p>The first surprising thing about this diagram to me is that there are 33
control codes, split into (very roughly speaking) these categories:</p>
<ol>
<li>Codes that are handled by the operating system&rsquo;s terminal driver, for
example when the OS sees a <code>3</code> (<code>Ctrl-C</code>), it&rsquo;ll send a <code>SIGINT</code> signal to
the current program</li>
<li>Everything else is passed through to the application as-is and the
application can do whatever it wants with them. Some subcategories of
those:
<ul>
<li>Codes that correspond to a literal keypress of a key on your keyboard
(<code>Enter</code>, <code>Tab</code>, <code>Backspace</code>). For example when you press <code>Enter</code>, your
terminal gets sent <code>13</code>.</li>
<li>Codes used by <code>readline</code>: &ldquo;the application can do whatever it wants&rdquo;
often means &ldquo;it&rsquo;ll do more or less what the <code>readline</code> library does,
whether the application actually uses <code>readline</code> or not&rdquo;, so I&rsquo;ve
labelled a bunch of the codes that <code>readline</code> uses</li>
<li>Other codes, for example I think <code>Ctrl-X</code> has no standard meaning in the
terminal in general but emacs uses it very heavily</li>
</ul>
</li>
</ol>
<p>There&rsquo;s no real structure to which codes are in which categories, they&rsquo;re all
just kind of randomly scattered because this evolved organically.</p>
<p>(If you&rsquo;re curious about readline, I wrote more about readline in <a href="https://jvns.ca/blog/2024/07/08/readline/">entering text in the terminal is complicated</a>, and there are a lot of
<a href="https://github.com/chzyer/readline/blob/master/doc/shortcut.md">cheat sheets out there</a>)</p>
<h3 id="there-are-only-33-control-codes">there are only 33 control codes</h3>
<p>Something else that I find a little surprising is that are only 33 control codes &ndash;
A to Z, plus 7 more (<code>@, [, \, ], ^, _, ?</code>). This means that if you want to
have for example <code>Ctrl-1</code> as a keyboard shortcut in a terminal application,
that&rsquo;s not really meaningful &ndash; on my machine at least <code>Ctrl-1</code> is exactly the
same thing as just pressing <code>1</code>, <code>Ctrl-3</code> is the same as <code>Ctrl-[</code>, etc.</p>
<p>Also <code>Ctrl+Shift+C</code> isn&rsquo;t a control code &ndash; what it does depends on your
terminal emulator. On Linux <code>Ctrl-Shift-X</code> is often used by the terminal
emulator to copy or open a new tab or paste for example, it&rsquo;s not sent to the
TTY at all.</p>
<p>Also I use <code>Ctrl+Left Arrow</code> all the time, but that isn&rsquo;t a control code,
instead it sends an ANSI escape sequence (<code>ctrl-[[1;5D</code>) which is a different
thing which we absolutely do not have space for in this post.</p>
<p>This &ldquo;there are only 33 codes&rdquo; thing is totally different from how keyboard
shortcuts work in a GUI where you can have <code>Ctrl+KEY</code> for any key you want.</p>
<h3 id="the-official-ascii-names-aren-t-very-meaningful-to-me">the official ASCII names aren&rsquo;t very meaningful to me</h3>
<p>Each of these 33 control codes has a name in ASCII (for example <code>3</code> is <code>ETX</code>).
When all of these control codes were originally defined, they weren&rsquo;t being
used for computers or terminals at all, they were used for <a href="https://falsedoor.com/doc/ascii_evolution-of-character-codes.pdf">the telegraph machine</a>.
Telegraph machines aren&rsquo;t the same as UNIX terminals so a lot of the codes were repurposed to mean something else.</p>
<p>Personally I don&rsquo;t find these ASCII names very useful, because 50% of the time
the name in ASCII has no actual relationship to what that code does on UNIX
systems today. So it feels easier to just ignore the ASCII names completely
instead of trying to figure which ones still match their original meaning.</p>
<h3 id="it-s-hard-to-use-ctrl-m-as-a-keyboard-shortcut">It&rsquo;s hard to use Ctrl-M  as a keyboard shortcut</h3>
<p>Another thing that&rsquo;s a bit weird is that <code>Ctrl-M</code> is literally the same as
<code>Enter</code>, and <code>Ctrl-I</code> is the same as <code>Tab</code>, which makes it hard to use those two as keyboard shortcuts.</p>
<p>From some quick research, it seems like some folks do still use <code>Ctrl-I</code> and
<code>Ctrl-M</code> as keyboard shortcuts (<a href="https://github.com/tmux/tmux/issues/2705">here&rsquo;s an example</a>), but to do that
you need to configure your terminal emulator to treat them differently than the
default.</p>
<p>For me the main takeaway is that if I ever write a terminal application I
should avoid <code>Ctrl-I</code> and <code>Ctrl-M</code> as keyboard shortcuts in it.</p>
<h3 id="how-to-identify-what-control-codes-get-sent">how to identify what control codes get sent</h3>
<p>While writing this I needed to do a bunch of experimenting to figure out what
various key combinations did, so I wrote this Python script
<a href="https://gist.github.com/jvns/a2ea09dbfbe03cc75b7bfb381941c742">echo-key.py</a>
that will print them out.</p>
<p>There&rsquo;s probably a more official way but I appreciated having a script I could
customize.</p>
<h3 id="caveat-on-canonical-vs-noncanonical-mode">caveat: on canonical vs noncanonical mode</h3>
<p>Two of these codes (<code>Ctrl-W</code> and <code>Ctrl-U</code>) are labelled in the table as
&ldquo;handled by the OS&rdquo;, but actually they&rsquo;re not <strong>always</strong> handled by the OS, it
depends on whether the terminal is in &ldquo;canonical&rdquo; mode or in &ldquo;noncanonical mode&rdquo;.</p>
<p>In <a href="https://www.man7.org/linux/man-pages/man3/termios.3.html">canonical mode</a>,
programs only get input when you press <code>Enter</code> (and the OS is in charge of deleting characters when you press <code>Backspace</code> or <code>Ctrl-W</code>). But in noncanonical mode the program gets
input immediately when you press a key, and the <code>Ctrl-W</code> and <code>Ctrl-U</code> codes are passed through to the program to handle any way it wants.</p>
<p>Generally in noncanonical mode the program will handle <code>Ctrl-W</code> and <code>Ctrl-U</code>
similarly to how the OS does, but there are some small differences.</p>
<p>Some examples of programs that use canonical mode:</p>
<ul>
<li>probably pretty much any noninteractive program, like <code>grep</code> or <code>cat</code></li>
<li><code>git</code>, I think</li>
</ul>
<p>Examples of programs that use noncanonical mode:</p>
<ul>
<li><code>python3</code>, <code>irb</code> and other REPLs</li>
<li>your shell</li>
<li>any full screen TUI like <code>less</code> or <code>vim</code></li>
</ul>
<h3 id="caveat-all-of-the-os-terminal-driver-codes-are-configurable-with-stty">caveat: all of the &ldquo;OS terminal driver&rdquo; codes are configurable with <code>stty</code></h3>
<p>I said that <code>Ctrl-C</code> sends <code>SIGINT</code> but technically this is not necessarily
true, if you really want to you can remap all of the codes labelled &ldquo;OS
terminal driver&rdquo;, plus Backspace, using a tool called <code>stty</code>, and you can view
the mappings with <code>stty -a</code>.</p>
<p>Here are the mappings on my machine right now:</p>
<pre><code>$ stty -a
cchars: discard = ^O; dsusp = ^Y; eof = ^D; eol = &lt;undef&gt;;
	eol2 = &lt;undef&gt;; erase = ^?; intr = ^C; kill = ^U; lnext = ^V;
	min = 1; quit = ^\; reprint = ^R; start = ^Q; status = ^T;
	stop = ^S; susp = ^Z; time = 0; werase = ^W;
</code></pre>
<p>I have personally never remapped any of these and I cannot imagine a reason I
would (I think it would be a recipe for confusion and disaster for me), but I
<a href="TODO">asked on Mastodon</a> and people said the most common reasons they used
<code>stty</code> were:</p>
<ul>
<li>fix a broken terminal with <code>stty sane</code></li>
<li>set <code>stty erase ^H</code> to change how Backspace works</li>
<li>set <code>stty ixoff</code></li>
<li>some people even map <code>SIGINT</code> to a different key, like their <code>DELETE</code> key</li>
</ul>
<h3 id="caveat-on-signals">caveat: on signals</h3>
<p>Two signals caveats:</p>
<ol>
<li>If the <code>ISIG</code> terminal mode is turned off, then the OS won&rsquo;t send signals. For example <code>vim</code> turns off <code>ISIG</code></li>
<li>Apparently on BSDs, there&rsquo;s an extra control code (<code>Ctrl-T</code>) which sends <code>SIGINFO</code></li>
</ol>
<p>You can see which terminal modes a program is setting using <code>strace</code> like this,
terminal modes are set with the <code>ioctl</code> system call:</p>
<pre><code>$ strace -tt -o out  vim
$ grep ioctl out | grep SET
</code></pre>
<p>here are the modes <code>vim</code> sets when it starts (<code>ISIG</code> and <code>ICANON</code> are
missing!):</p>
<pre><code>17:43:36.670636 ioctl(0, TCSETS, {c_iflag=IXANY|IMAXBEL|IUTF8,
c_oflag=NL0|CR0|TAB0|BS0|VT0|FF0|OPOST, c_cflag=B38400|CS8|CREAD,
c_lflag=ECHOK|ECHOCTL|ECHOKE|PENDIN, ...}) = 0
</code></pre>
<p>and it resets the modes when it exits:</p>
<pre><code>17:43:38.027284 ioctl(0, TCSETS, {c_iflag=ICRNL|IXANY|IMAXBEL|IUTF8,
c_oflag=NL0|CR0|TAB0|BS0|VT0|FF0|OPOST|ONLCR, c_cflag=B38400|CS8|CREAD,
c_lflag=ISIG|ICANON|ECHO|ECHOE|ECHOK|IEXTEN|ECHOCTL|ECHOKE|PENDIN, ...}) = 0
</code></pre>
<p>I think the specific combination of modes vim is using here might be called
&ldquo;raw mode&rdquo;, <a href="https://linux.die.net/man/3/cfmakeraw">man cfmakeraw</a> talks about
that.</p>
<h3 id="there-are-a-lot-of-conflicts">there are a lot of conflicts</h3>
<p>Related to &ldquo;there are only 33 codes&rdquo;, there are a lot of conflicts where
different parts of the system want to use the same code for different things,
for example by default <code>Ctrl-S</code> will freeze your screen, but if you turn that
off then <code>readline</code> will use <code>Ctrl-S</code> to do a forward search.</p>
<p>Another example is that on my machine sometimes <code>Ctrl-T</code> will send <code>SIGINFO</code>
and sometimes it&rsquo;ll transpose 2 characters and sometimes it&rsquo;ll do something
completely different depending on:</p>
<ul>
<li>whether the program has <code>ISIG</code> set</li>
<li>whether the program uses <code>readline</code> / imitates readline&rsquo;s behaviour</li>
</ul>
<h3 id="caveat-on-backspace-and-other-backspace">caveat: on &ldquo;backspace&rdquo; and &ldquo;other backspace&rdquo;</h3>
<p>In this diagram I&rsquo;ve labelled code 127 as &ldquo;backspace&rdquo; and 8 as &ldquo;other
backspace&rdquo;. Uh, what?</p>
<p>I think this was the single biggest topic of discussion in the replies on Mastodon &ndash; apparently there&rsquo;s a LOT of history to this and I&rsquo;d never heard of any of it before.</p>
<p>First, here&rsquo;s how it works on my machine:</p>
<ol>
<li>I press the <code>Backspace</code> key</li>
<li>The TTY gets sent the byte <code>127</code>, which is called <code>DEL</code> in ASCII</li>
<li>the OS terminal driver and readline both have <code>127</code> mapped to &ldquo;backspace&rdquo; (so it works both in canonical mode and noncanonical mode)</li>
<li>The previous character gets deleted</li>
</ol>
<p>If I press <code>Ctrl+H</code>, it has the same effect as <code>Backspace</code> if I&rsquo;m using
readline, but in a program without readline support (like <code>cat</code> for instance),
it just prints out <code>^H</code>.</p>
<p>Apparently Step 2 above is different for some folks &ndash; their <code>Backspace</code> key sends
the byte <code>8</code> instead of <code>127</code>, and so if they want Backspace to work then they
need to configure the OS (using <code>stty</code>) to set <code>erase = ^H</code>.</p>
<p>There&rsquo;s an incredible <a href="https://www.debian.org/doc/debian-policy/ch-opersys.html#keyboard-configuration">section of the Debian Policy Manual on keyboard configuration</a>
that describes how <code>Delete</code> and <code>Backspace</code> should work according to Debian
policy, which seems very similar to how it works on my Mac today.  My
understanding (via <a href="https://tech.lgbt/@Diziet/113396035847619715">this mastodon post</a>)
is that this policy was written in the 90s because there was a lot of confusion
about what <code>Backspace</code> should do in the 90s and there needed to be a standard
to get everything to work.</p>
<p>There&rsquo;s a bunch more historical terminal stuff here but that&rsquo;s all I&rsquo;ll say for
now.</p>
<h3 id="there-s-probably-a-lot-more-diversity-in-how-this-works">there&rsquo;s probably a lot more diversity in how this works</h3>
<p>I&rsquo;ve probably missed a bunch more ways that &ldquo;how it works on my machine&rdquo; might
be different from how it works on other people&rsquo;s machines, and I&rsquo;ve probably
made some mistakes about how it works on my machine too. But that&rsquo;s all I&rsquo;ve
got for today.</p>
<p>Some more stuff I know that I&rsquo;ve left out: according to <code>stty -a</code> <code>Ctrl-O</code> is
&ldquo;discard&rdquo;, <code>Ctrl-R</code> is &ldquo;reprint&rdquo;, and <code>Ctrl-Y</code> is &ldquo;dsusp&rdquo;. I have no idea how
to make those actually do anything (pressing them does not do anything
obvious, and some people have told me what they used to do historically but
it&rsquo;s not clear to me if they have a use in 2024), and a lot of the time in practice
they seem to just be passed through to the application anyway so I just
labelled <code>Ctrl-R</code> and <code>Ctrl-Y</code> as
<code>readline</code>.</p>
<h3 id="not-all-of-this-is-that-useful-to-know">not all of this is that useful to know</h3>
<p>Also I want to say that I think the contents of this post are kind of interesting
but I don&rsquo;t think they&rsquo;re necessarily that <em>useful</em>. I&rsquo;ve used the terminal
pretty successfully every day for the last 20 years without knowing literally
any of this &ndash; I just knew what <code>Ctrl-C</code>, <code>Ctrl-D</code>, <code>Ctrl-Z</code>, <code>Ctrl-R</code>,
<code>Ctrl-L</code> did in practice (plus maybe <code>Ctrl-A</code>, <code>Ctrl-E</code> and <code>Ctrl-W</code>) and did
not worry about the details for the most part, and that was
almost always totally fine except when I was <a href="https://jvns.ca/blog/2022/07/20/pseudoterminals/">trying to use xterm.js</a>.</p>
<p>But I had fun learning about it so maybe it&rsquo;ll be interesting to you too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using less memory to look up IP addresses in Mess With DNS]]></title>
    <link href="https://jvns.ca/blog/2024/10/27/asn-ip-address-memory/"/>
    <updated>2024-10-27T07:47:04+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/27/asn-ip-address-memory/</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been having problems for the last 3 years or so where <a href="https://messwithdns.net/">Mess With DNS</a>
periodically runs out of memory and gets OOM killed.</p>
<p>This hasn&rsquo;t been a big priority for me: usually it just goes down for a few
minutes while it restarts, and it only happens once a day at most, so I&rsquo;ve just
been ignoring. But last week it started actually causing a problem so I decided
to look into it.</p>
<p>This was kind of winding road where I learned a lot so here&rsquo;s a table of contents:</p>
<ul>
<li><a href="#there-s-about-100mb-of-memory-available">there&rsquo;s about 100MB of memory available</a></li>
<li><a href="#the-problem-oom-killing-the-backup-script">the problem: OOM killing the backup script</a></li>
<li><a href="#attempt-1-use-sqlite">attempt 1: use SQLite</a>
<ul>
<li><a href="#problem-how-to-store-ipv6-addresses">problem: how to store IPv6 addresses</a></li>
<li><a href="#problem-it-s-500x-slower">problem: it&rsquo;s 500x slower</a></li>
<li><a href="#time-for-explain-query-plan">time for EXPLAIN QUERY PLAN</a></li>
</ul>
</li>
<li><a href="#attempt-2-use-a-trie">attempt 2: use a trie</a>
<ul>
<li><a href="#some-notes-on-memory-profiling">some notes on memory profiling</a></li>
</ul>
</li>
<li><a href="#attempt-3-make-my-array-use-less-memory">attempt 3: make my array use less memory</a>
<ul>
<li><a href="#idea-3-1-deduplicate-the-name-and-country">idea 3.1: deduplicate the Name and Country</a></li>
<li><a href="#how-big-are-asns">how big are ASNs?</a></li>
<li><a href="#idea-3-2-use-netip-addr-instead-of-net-ip">idea 3.2: use netip.Addr instead of net.IP</a></li>
<li><a href="#the-result-saved-70mb-of-memory">the result: saved 70MB of memory!</a></li>
</ul>
</li>
</ul>
<h3 id="there-s-about-100mb-of-memory-available">there&rsquo;s about 100MB of memory available</h3>
<p>I run Mess With DNS on a VM without about 465MB of RAM, which according to
<code>ps aux</code> (the <code>RSS</code> column) is split up something like:</p>
<ul>
<li>100MB for PowerDNS</li>
<li>200MB for Mess With DNS</li>
<li>40MB for <a href="https://fly.io/blog/ssh-and-user-mode-ip-wireguard/">hallpass</a></li>
</ul>
<p>That leaves about 110MB of memory free.</p>
<p>A while back I set <a href="https://tip.golang.org/doc/gc-guide">GOMEMLIMIT</a> to 250MB
to try to make sure the garbage collector ran if Mess With DNS used more than
250MB of memory, and I think this helped but it didn&rsquo;t solve everything.</p>
<h3 id="the-problem-oom-killing-the-backup-script">the problem: OOM killing the backup script</h3>
<p>A few weeks ago I started backing up Mess With DNS&rsquo;s database for the first time <a href="https://jvns.ca/til/restic-for-backing-up-sqlite-dbs/">using restic</a>.</p>
<p>This has been working okay, but since Mess With DNS operates without much extra
memory I think <code>restic</code> sometimes needed more memory than was available on the
system, and so the backup script sometimes got OOM killed.</p>
<p>This was a problem because</p>
<ol>
<li>backups might be corrupted sometimes</li>
<li>more importantly, restic takes out a lock when it runs, and so I&rsquo;d have to manually do an
unlock if I wanted the backups to continue working. Doing manual work like
this is the #1 thing I try to avoid with all my web services (who has time
for that!) so I really wanted to do something about it.</li>
</ol>
<p>There&rsquo;s probably more than one solution to this, but I decided to try to make
Mess With DNS use less memory so that there was more available memory on the
system, mostly because it seemed like a fun problem to try to solve.</p>
<h3 id="what-s-using-memory-ip-addresses">what&rsquo;s using memory: IP addresses</h3>
<p>I&rsquo;d run a memory profile of Mess With DNS a bunch of times in the past, so I
knew exactly what was using most of Mess With DNS&rsquo;s memory: IP addresses.</p>
<p>When it starts, Mess With DNS loads this <a href="https://iptoasn.com/">database where you can look up the
ASN of every IP address</a> into memory, so that when it
receives a DNS query it can take the source IP address like <code>74.125.16.248</code> and
tell you that IP address belongs to <code>GOOGLE</code>.</p>
<p>This database by itself used about 117MB of memory, and a simple <code>du</code> told me
that was too much &ndash; the original text files were only 37MB!</p>
<pre><code>$ du -sh *.tsv
26M	ip2asn-v4.tsv
11M	ip2asn-v6.tsv
</code></pre>
<p>The way it worked originally is that I had an array of these:</p>
<pre><code>type IPRange struct {
	StartIP net.IP
	EndIP   net.IP
	Num     int
	Name    string
	Country string
}
</code></pre>
<p>and I searched through it with a binary search to figure out if any of the
ranges contained the IP I was looking for. Basically the simplest possible
thing and it&rsquo;s super fast, my machine can do about 9 million lookups per
second.</p>
<h3 id="attempt-1-use-sqlite">attempt 1: use SQLite</h3>
<p>I&rsquo;ve been using SQLite recently, so my first thought was &ndash; maybe I can store
all of this data on disk in an SQLite database, give the tables an index, and
that&rsquo;ll use less memory.</p>
<p>So I:</p>
<ul>
<li>wrote a quick Python script using <a href="https://sqlite-utils.datasette.io/en/stable/">sqlite-utils</a> to import the TSV files into an SQLite database</li>
<li>adjusted my code to select from the database instead</li>
</ul>
<p>This did solve the initial memory goal (after a GC it now hardly used any
memory at all because the table was on disk!), though I&rsquo;m not sure how much GC
churn this solution would cause if we needed to do a lot of queries at once. I
did a quick memory profile and it seemed to allocate about 1KB of memory per
lookup.</p>
<p>Let&rsquo;s talk about the issues I ran into with using SQLite though.</p>
<h3 id="problem-how-to-store-ipv6-addresses">problem: how to store IPv6 addresses</h3>
<p>SQLite doesn&rsquo;t have support for big integers and IPv6 addresses are 128 bits,
so I decided to store them as text. I think <code>BLOB</code> might have been better, I
originally thought <code>BLOB</code>s couldn&rsquo;t be compared but the <a href="https://www.sqlite.org/datatype3.html#sort_order">sqlite docs</a> say they can.</p>
<p>I ended up with this schema:</p>
<pre><code>CREATE TABLE ipv4_ranges (
   start_ip INTEGER NOT NULL,
   end_ip INTEGER NOT NULL,
   asn INTEGER NOT NULL,
   country TEXT NOT NULL,
   name TEXT NOT NULL
);
CREATE TABLE ipv6_ranges (
   start_ip TEXT NOT NULL,
   end_ip TEXT NOT NULL,
   asn INTEGER,
   country TEXT,
   name TEXT
);
CREATE INDEX idx_ipv4_ranges_start_ip ON ipv4_ranges (start_ip);
CREATE INDEX idx_ipv6_ranges_start_ip ON ipv6_ranges (start_ip);
CREATE INDEX idx_ipv4_ranges_end_ip ON ipv4_ranges (end_ip);
CREATE INDEX idx_ipv6_ranges_end_ip ON ipv6_ranges (end_ip);
</code></pre>
<p>Also I learned that Python has an <code>ipaddress</code> module, so I could use
<code>ipaddress.ip_address(s).exploded</code> to make sure that the IPv6 addresses were
expanded so that a string comparison would compare them properly.</p>
<h3 id="problem-it-s-500x-slower">problem: it&rsquo;s 500x slower</h3>
<p>I ran a quick microbenchmark, something like this. It printed out that it could
look up 17,000 IPv6 addresses per second, and similarly for IPv4 addresses.</p>
<p>This was pretty discouraging &ndash; being able to look up 17k addresses per section
is kind of fine (Mess With DNS does not get a lot of traffic), but I compared it to
the original binary search code and the original code could do 9 million per second.</p>
<pre><code>	ips := []net.IP{}
	count := 20000
	for i := 0; i &lt; count; i++ {
		// create a random IPv6 address
		bytes := randomBytes()
		ip := net.IP(bytes[:])
		ips = append(ips, ip)
	}
	now := time.Now()
	success := 0
	for _, ip := range ips {
		_, err := ranges.FindASN(ip)
		if err == nil {
			success++
		}
	}
	fmt.Println(success)
	elapsed := time.Since(now)
	fmt.Println(&quot;number per second&quot;, float64(count)/elapsed.Seconds())
</code></pre>
<h3 id="time-for-explain-query-plan">time for EXPLAIN QUERY PLAN</h3>
<p>I&rsquo;d never really done an EXPLAIN in sqlite, so I thought it would be a fun
opportunity to see what the query plan was doing.</p>
<pre><code>sqlite&gt; explain query plan select * from ipv6_ranges where '2607:f8b0:4006:0824:0000:0000:0000:200e' BETWEEN start_ip and end_ip;
QUERY PLAN
`--SEARCH ipv6_ranges USING INDEX idx_ipv6_ranges_end_ip (end_ip&gt;?)
</code></pre>
<p>It looks like it&rsquo;s just using the <code>end_ip</code> index and not the <code>start_ip</code> index,
so maybe it makes sense that it&rsquo;s slower than the binary search.</p>
<p>I tried to figure out if there was a way to make SQLite use both indexes, but I
couldn&rsquo;t find one and maybe it knows best anyway.</p>
<p>At this point I gave up on the SQLite solution, I didn&rsquo;t love that it was
slower and also it&rsquo;s a lot more complex than just doing a binary search. I felt
like I&rsquo;d rather keep something much more similar to the binary search.</p>
<p>A few things I tried with SQLite that did not cause it to use both indexes:</p>
<ul>
<li>using a compound index instead of two separate indexes</li>
<li>running <code>ANALYZE</code></li>
<li>using <code>INTERSECT</code> to intersect the results of <code>start_ip &lt; ?</code> and <code>? &lt; end_ip</code>. This did make it use both indexes, but it also seemed to make the
query literally 1000x slower, probably because it needed to create the
results of both subqueries in memory and intersect them.</li>
</ul>
<h3 id="attempt-2-use-a-trie">attempt 2: use a trie</h3>
<p>My next idea was to use a
<a href="https://medium.com/basecs/trying-to-understand-tries-3ec6bede0014">trie</a>,
because I had some vague idea that maybe a trie would use less memory, and
I found this library called
<a href="https://github.com/seancfoley/ipaddress-go">ipaddress-go</a> that lets you look up IP addresses using a trie.</p>
<p>I tried using it <a href="https://gist.github.com/jvns/3ce617796b22127017590ac62c57fddd">here&rsquo;s the code</a>, but I
think I was doing something wildly wrong because, compared to my naive array + binary search:</p>
<ul>
<li>it used WAY more memory (800MB to store just the IPv4 addresses)</li>
<li>it was a lot slower to do the lookups (it could do only 100K/second instead of 9 million/second)</li>
</ul>
<p>I&rsquo;m not really sure what went wrong here but I gave up on this approach and
decided to just try to make my array use less memory and stick to a simple
binary search.</p>
<h3 id="some-notes-on-memory-profiling">some notes on memory profiling</h3>
<p>One thing I learned about memory profiling is that you can use <code>runtime</code>
package to see how much memory is currently allocated in the program. That&rsquo;s
how I got all the memory numbers in this post. Here&rsquo;s the code:</p>
<pre><code>func memusage() {
	runtime.GC()
	var m runtime.MemStats
	runtime.ReadMemStats(&amp;m)
	fmt.Printf(&quot;Alloc = %v MiB\n&quot;, m.Alloc/1024/1024)
	// write mem.prof
	f, err := os.Create(&quot;mem.prof&quot;)
	if err != nil {
		log.Fatal(err)
	}
	pprof.WriteHeapProfile(f)
	f.Close()
}
</code></pre>
<p>Also I learned that if you use <code>pprof</code> to analyze a heap profile there are two
ways to analyze it: you can pass either <code>--alloc-space</code> or <code>--inuse-space</code> to
<code>go tool pprof</code>. I don&rsquo;t know how I didn&rsquo;t realize this before but
<code>alloc-space</code> will tell you about everything that was allocated, and
<code>inuse-space</code> will just include memory that&rsquo;s currently in use.</p>
<p>Anyway I ran <code>go tool pprof -pdf --inuse_space mem.prof &gt; mem.pdf</code> a lot. Also
every time I use pprof I find myself referring to <a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/">my own intro to pprof</a>, it&rsquo;s probably
the blog post I wrote that I use the most often. I should add <code>--alloc-space</code>
and <code>--inuse-space</code> to it.</p>
<h3 id="attempt-3-make-my-array-use-less-memory">attempt 3: make my array use less memory</h3>
<p>I was storing my ip2asn entries like this:</p>
<pre><code>type IPRange struct {
	StartIP net.IP
	EndIP   net.IP
	Num     int
	Name    string
	Country string
}
</code></pre>
<p>I had 3 ideas for ways to improve this:</p>
<ol>
<li>There was a lot of repetition of <code>Name</code> and the <code>Country</code>, because a lot of IP ranges belong to the same ASN</li>
<li><code>net.IP</code> is an <code>[]byte</code> under the hood, which felt like it involved an unnecessary pointer, was there a way to inline it into the struct?</li>
<li>Maybe I didn&rsquo;t need both the start IP and the end IP, often the ranges were consecutive so maybe I could rearrange things so that I only had the start IP</li>
</ol>
<h3 id="idea-3-1-deduplicate-the-name-and-country">idea 3.1: deduplicate the Name and Country</h3>
<p>I figured I could store the ASN info in an array, and then just store the index
into the array in my <code>IPRange</code> struct. Here are the structs so you can see what
I mean:</p>
<pre><code>type IPRange struct {
	StartIP netip.Addr
	EndIP   netip.Addr
	ASN     uint32
	Idx     uint32
}

type ASNInfo struct {
	Country string
	Name    string
}

type ASNPool struct {
	asns   []ASNInfo
	lookup map[ASNInfo]uint32
}
</code></pre>
<p>This worked! It brought memory usage from 117MB to 65MB &ndash; a 50MB savings. I felt good about this.</p>
<p><a href="https://github.com/jvns/mess-with-dns/blob/94f77b4bb1597b5e2a6768e33bd6c285919aa1bf/api/streamer/ip2asn/ip2asn.go#L18-L54">Here&rsquo;s all of the code for that part</a>.</p>
<h3 id="how-big-are-asns">how big are ASNs?</h3>
<p>As an aside &ndash; I&rsquo;m storing the ASN in a <code>uint32</code>, is that right? I looked in the ip2asn
file and the biggest one seems to be 401307, though there are a few lines that
say <code>4294901931</code> which is much bigger, but also are just inside the range of a
uint32. So I can definitely use a <code>uint32</code>.</p>
<pre><code>59.101.179.0	59.101.179.255	4294901931	Unknown	AS4294901931
</code></pre>
<h3 id="idea-3-2-use-netip-addr-instead-of-net-ip">idea 3.2: use <code>netip.Addr</code> instead of <code>net.IP</code></h3>
<p>It turns out that I&rsquo;m not the only one who felt that <code>net.IP</code> was using an
unnecessary amount of memory &ndash; in 2021 the folks at Tailscale released a new
IP address library for Go which solves this and many other issues. <a href="https://tailscale.com/blog/netaddr-new-ip-type-for-go">They wrote a great blog post about it</a>.</p>
<p>I discovered (to my delight) that not only does this new IP address library exist and do exactly what I want, it&rsquo;s also now in the Go
standard library as <a href="https://pkg.go.dev/net/netip#Addr">netip.Addr</a>. Switching to <code>netip.Addr</code> was
very easy and saved another 20MB of memory, bringing us to 46MB.</p>
<p>I didn&rsquo;t try my third idea (remove the end IP from the struct) because I&rsquo;d
already been programming for long enough on a Saturday morning and I was happy
with my progress.</p>
<p>It&rsquo;s always such a great feeling when I think &ldquo;hey, I don&rsquo;t like this, there
must be a better way&rdquo; and then immediately discover that someone has already
made the exact thing I want, thought about it a lot more than me, and
implemented it much better than I would have.</p>
<h3 id="all-of-this-was-messier-in-real-life">all of this was messier in real life</h3>
<p>Even though I tried to explain this in a simple linear way &ldquo;I tried X, then I
tried Y, then I tried Z&rdquo;, that&rsquo;s kind of a lie &ndash; I always try to take my
actual debugging process (total chaos) and make it seem more linear and
understandable because the reality is just too annoying to write down. It&rsquo;s
more like:</p>
<ul>
<li>try sqlite</li>
<li>try a trie</li>
<li>second guess everything that I concluded about sqlite, go back and look at
the results again</li>
<li>wait what about indexes</li>
<li>very very belatedly realize that I can use <code>runtime</code> to check how much
memory everything is using, start doing that</li>
<li>look at the trie again, maybe I misunderstood everything</li>
<li>give up and go back to binary search</li>
<li>look at all of the numbers for tries/sqlite again to make sure I didn&rsquo;t misunderstand</li>
</ul>
<h3 id="a-note-on-using-512mb-of-memory">A note on using 512MB of memory</h3>
<p>Someone asked why I don&rsquo;t just give the VM more memory. I could very easily
afford to pay for a VM with 1GB of memory, but I feel like 512MB really
<em>should</em> be enough (and really that 256MB should be enough!) so I&rsquo;d rather stay
inside that constraint. It&rsquo;s kind of a fun puzzle.</p>
<h3 id="a-few-ideas-from-the-replies">a few ideas from the replies</h3>
<p>Folks had a lot of good ideas I hadn&rsquo;t thought of. Recording them as
inspiration if I feel like having another Fun Performance Day at some point.</p>
<ul>
<li>Try Go&rsquo;s <a href="https://pkg.go.dev/unique">unique</a> package for the <code>ASNPool</code>. Someone tried this and it uses more memory, probably because Go&rsquo;s pointers are 64 bits</li>
<li>Try compiling with <code>GOARCH=386</code> to use 32-bit pointers to sace space (maybe in combination with using <code>unique</code>!)</li>
<li>It should be possible to store all of the IPv6 addresses in just 64 bits, because only the first 64 bits of the address are public</li>
<li><a href="https://en.m.wikipedia.org/wiki/Interpolation_search">Interpolation search</a> might be faster than binary search since IP addresses are numeric</li>
<li>Try the MaxMind db format with <a href="https://github.com/maxmind/mmdbwriter">mmdbwriter</a> or <a href="https://github.com/ipinfo/mmdbctl">mmdbctl</a></li>
<li>Tailscale&rsquo;s <a href="https://github.com/tailscale/art">art</a> routing table package</li>
</ul>
<h3 id="the-result-saved-70mb-of-memory">the result: saved 70MB of memory!</h3>
<p>I deployed the new version and now Mess With DNS is using less memory! Hooray!</p>
<p>A few other notes:</p>
<ul>
<li>lookups are a little slower &ndash; in my microbenchmark they went from 9 million
lookups/second to 6 million, maybe because I added a little indirection.
Using less memory and a little more CPU seemed like a good tradeoff though.</li>
<li>it&rsquo;s still using more memory than the raw text files do (46MB vs 37MB), I
guess pointers take up space and that&rsquo;s okay.</li>
</ul>
<p>I&rsquo;m honestly not sure if this will solve all my memory problems, probably not!
But I had fun, I learned a few things about SQLite, I still don&rsquo;t know what to
think about tries, and it made me love binary search even more than I already
did.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some notes on upgrading Hugo]]></title>
    <link href="https://jvns.ca/blog/2024/10/07/some-notes-on-upgrading-hugo/"/>
    <updated>2024-10-07T09:19:57+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/07/some-notes-on-upgrading-hugo/</id>
    <content type="html"><![CDATA[<p>Warning: this is a post about very boring yakshaving, probably only of interest
to people who are trying to upgrade Hugo from a very old version to a new
version. But what are blogs for if not documenting one&rsquo;s very boring yakshaves
from time to time?</p>
<p>So yesterday I decided to try to upgrade Hugo. There&rsquo;s no real reason to do
this &ndash; I&rsquo;ve been using Hugo version 0.40 to generate this blog since 2018, it
works fine, and I don&rsquo;t have any problems with it. But I thought &ndash; maybe it
won&rsquo;t be as hard as I think, and I kind of like a tedious computer task sometimes!</p>
<p>I thought I&rsquo;d document what I learned along the way in case it&rsquo;s useful to
anyone else doing this very specific migration. I upgraded from Hugo v0.40
(from 2018) to v0.135 (from 2024).</p>
<p>Here are most of the changes I had to make:</p>
<h3 id="change-1-template-theme-partials-thing-html-is-now-partial-thing-html">change 1: <code>template &quot;theme/partials/thing.html</code> is now <code>partial thing.html</code></h3>
<p>I had to replace a bunch of instances of <code>{{ template &quot;theme/partials/header.html&quot; . }}</code> with <code>{{ partial &quot;header.html&quot; . }}</code>.</p>
<p>This happened in <a href="https://github.com/gohugoio/hugo/releases/tag/v0.42">v0.42</a>:</p>
<blockquote>
<p>We have now virtualized the filesystems for project and theme files. This
makes everything simpler, faster and more powerful. But it also means that
template lookups on the form {{ template “theme/partials/pagination.html” .
}} will not work anymore. That syntax has never been documented, so it&rsquo;s not
expected to be in wide use.</p>
</blockquote>
<h3 id="change-2-data-pages-is-now-site-regularpages">change 2: <code>.Data.Pages</code> is now <code>site.RegularPages</code></h3>
<p>This seems to be discussed in the <a href="https://github.com/gohugoio/hugo/releases/tag/v0.57.2">release notes for 0.57.2</a></p>
<p>I just needed to replace <code>.Data.Pages</code> with <code>site.RegularPages</code> in the template on the homepage as well as in my RSS feed template.</p>
<h3 id="change-3-next-and-prev-got-flipped">change 3:  <code>.Next</code> and <code>.Prev</code> got flipped</h3>
<p>I had this comment in the part of my theme where I link to the next/previous blog post:</p>
<blockquote>
<p>&ldquo;next&rdquo; and &ldquo;previous&rdquo; in hugo apparently mean the opposite of what I&rsquo;d think
they&rsquo;d mean intuitively. I&rsquo;d expect &ldquo;next&rdquo; to mean &ldquo;in the future&rdquo; and
&ldquo;previous&rdquo; to mean &ldquo;in the past&rdquo; but it&rsquo;s the opposite</p>
</blockquote>
<p>It looks they changed this in
<a href="https://github.com/gohugoio/hugo/commit/ad705aac0649fa3102f7639bc4db65d45e108ee2">ad705aac064</a>
so that &ldquo;next&rdquo; actually is in the future and &ldquo;prev&rdquo; actually is in the past. I
definitely find the new behaviour more intuitive.</p>
<h3 id="downloading-the-hugo-changelogs-with-a-script">downloading the Hugo changelogs with a script</h3>
<p>Figuring out why/when all of these changes happened was a little difficult. I
ended up hacking together a bash script to <a href="https://gist.github.com/jvns/dbe4bd9271a56f1f8562bfe329c2aa9e">download all of the changelogs from github as text files</a>, which I
could then grep to try to figure out what happened. It turns out it&rsquo;s pretty
easy to get all of the changelogs from the GitHub API.</p>
<p>So far everything was not so bad &ndash; there was also a change around taxonomies
that&rsquo;s I can&rsquo;t quite explain, but it was all pretty manageable, but then we got
to the really tough one: the markdown renderer.</p>
<h3 id="change-4-the-markdown-renderer-blackfriday-goldmark">change 4: the markdown renderer (blackfriday -&gt; goldmark)</h3>
<p>The blackfriday markdown renderer (which was previously the default) was removed in <a href="https://github.com/gohugoio/hugo/releases/tag/v0.100.0">v0.100.0</a>. This seems pretty reasonable:</p>
<blockquote>
<p>It has been deprecated for a long time, its v1 version is not maintained
anymore, and there are many known issues. Goldmark should be a mature
replacement by now.</p>
</blockquote>
<p>Fixing all my Markdown changes was a huge pain &ndash; I ended up having to update
80 different Markdown files (out of 700) so that they would render properly, and I&rsquo;m not totally sure</p>
<h3 id="why-bother-switching-renderers">why bother switching renderers?</h3>
<p>The obvious question here is &ndash; why bother even trying to upgrade Hugo at all
if I have to switch Markdown renderers?
My old site was running totally fine and I think it wasn&rsquo;t necessarily a <em>good</em>
use of time, but the one reason I think it might be useful in the future is
that the new renderer (goldmark) uses the <a href="https://commonmark.org/">CommonMark markdown standard</a>, which I&rsquo;m hoping will be somewhat
more futureproof. So maybe I won&rsquo;t have to go through this again? We&rsquo;ll see.</p>
<p>Also it turned out that the new Goldmark renderer does fix some problems I had
(but didn&rsquo;t know that I had) with smart quotes and how lists/blockquotes
interact.</p>
<h3 id="finding-all-the-markdown-problems-the-process">finding all the Markdown problems: the process</h3>
<p>The hard part of this Markdown change was even figuring out what changed.
Almost all of the problems (including #2 and #3 above) just silently broke the
site, they didn&rsquo;t cause any errors or anything. So I had to diff the HTML to
hunt them down.</p>
<p>Here&rsquo;s what I ended up doing:</p>
<ol>
<li>Generate the site with the old version, put it in <code>public_old</code></li>
<li>Generate the new version, put it in <code>public</code></li>
<li>Diff every single HTML file in <code>public/</code> and <code>public_old</code> with <a href="https://gist.github.com/jvns/c7272cfb906e3ed0a3e9f8d361c5b5fc">this diff.sh script</a> and put the results in a <code>diffs/</code> folder</li>
<li>Run variations on <code>find diffs -type f | xargs cat | grep -C 5 '(31m|32m)' | less -r</code> over and over again to look at every single change until I found something that seemed wrong</li>
<li>Update the Markdown to fix the problem</li>
<li>Repeat until everything seemed okay</li>
</ol>
<p>(the <code>grep 31m|32m</code> thing is searching for red/green text in the diff)</p>
<p>This was very time consuming but it was a little bit fun for some reason so I
kept doing it until it seemed like nothing too horrible was left.</p>
<h3 id="the-new-markdown-rules">the new markdown rules</h3>
<p>Here&rsquo;s a list of every type of Markdown change I had to make. It&rsquo;s very
possible these are all extremely specific to me but it took me a long time to
figure them all out so maybe this will be helpful to one other person who finds
this in the future.</p>
<h4 id="4-1-mixing-html-and-markdown">4.1: mixing HTML and markdown</h4>
<p>This doesn&rsquo;t work anymore (it doesn&rsquo;t expand the link):</p>
<pre><code>&lt;small&gt;
[a link](https://example.com)
&lt;/small&gt;
</code></pre>
<p>I need to do this instead:</p>
<pre><code>&lt;small&gt;

[a link](https://example.com)

&lt;/small&gt;
</code></pre>
<p>This works too:</p>
<pre><code>&lt;small&gt; [a link](https://example.com) &lt;/small&gt;
</code></pre>
<h4 id="4-2-is-changed-into">4.2: <code>&lt;&lt;</code> is changed into «</h4>
<p>I didn&rsquo;t want this so I needed to configure:</p>
<pre><code>markup:
  goldmark:
    extensions:
      typographer:
        leftAngleQuote: '&amp;lt;&amp;lt;'
        rightAngleQuote: '&amp;gt;&amp;gt;'
</code></pre>
<h4 id="4-3-nested-lists-sometimes-need-4-space-indents">4.3: nested lists sometimes need 4 space indents</h4>
<p>This doesn&rsquo;t render as a nested list anymore if I only indent by 2 spaces, I need to put 4 spaces.</p>
<pre><code>1. a
  * b
  * c
2. b
</code></pre>
<p>The problem is that the amount of indent needed depends on the size of the list
markers. <a href="https://spec.commonmark.org/0.29/#example-263">Here&rsquo;s a reference in CommonMark for this</a>.</p>
<h4 id="4-4-blockquotes-inside-lists-work-better">4.4: blockquotes inside lists work better</h4>
<p>Previously the <code>&gt; quote</code> here didn&rsquo;t render as a blockquote, and with the new renderer it does.</p>
<pre><code>* something
&gt; quote
* something else
</code></pre>
<p>I found a bunch of Markdown that had been kind of broken (which I hadn&rsquo;t
noticed) that works better with the new renderer, and this is an example of
that.</p>
<p>Lists inside blockquotes also seem to work better.</p>
<h4 id="4-5-headings-inside-lists">4.5: headings inside lists</h4>
<p>Previously this didn&rsquo;t render as a heading, but now it does. So I needed to
replace the <code>#</code> with <code>&amp;num;</code>.</p>
<pre><code>* # passengers: 20
</code></pre>
<h4 id="4-6-or-1-at-the-beginning-of-the-line-makes-it-a-list">4.6:  <code>+</code> or <code>1)</code> at the beginning of the line makes it a list</h4>
<p>I had something which looked like this:</p>
<pre><code>`1 / (1
+ exp(-1)) = 0.73`
</code></pre>
<p>With Blackfriday it rendered like this:</p>
<pre><code>&lt;p&gt;&lt;code&gt;1 / (1
+ exp(-1)) = 0.73&lt;/code&gt;&lt;/p&gt;
</code></pre>
<p>and with Goldmark it rendered like this:</p>
<pre><code>&lt;p&gt;`1 / (1&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;exp(-1)) = 0.73`&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>Same thing if there was an accidental <code>1)</code> at the beginning of a line, like in this Markdown snippet</p>
<pre><code>I set up a small Hadoop cluster (1 master, 2 workers, replication set to 
1) on 
</code></pre>
<p>To fix this I just had to rewrap the line so that the <code>+</code> wasn&rsquo;t the first character.</p>
<p>The Markdown is formatted this way because I wrap my Markdown to 80 characters
a lot and the wrapping isn&rsquo;t very context sensitive.</p>
<h4 id="4-7-no-more-smart-quotes-in-code-blocks">4.7: no more smart quotes in code blocks</h4>
<p>There were a bunch of places where the old renderer (Blackfriday) was doing
unwanted things in code blocks like replacing <code>...</code> with <code>…</code> or replacing
quotes with smart quotes. I hadn&rsquo;t realized this was happening and I was very
happy to have it fixed.</p>
<h4 id="4-8-better-quote-management">4.8: better quote management</h4>
<p>The way this gets rendered got better:</p>
<pre><code>&quot;Oh, *interesting*!&quot;
</code></pre>
<ul>
<li>old: “Oh, <em>interesting</em>!“</li>
<li>new: “Oh, <em>interesting</em>!”</li>
</ul>
<p>Before there were two left smart quotes, now the quotes match.</p>
<h4 id="4-9-images-are-no-longer-wrapped-in-a-p-tag">4.9: images are no longer wrapped in a <code>p</code> tag</h4>
<p>Previously if I had an image like this:</p>
<pre><code>&lt;img src=&quot;https://jvns.ca/images/rustboot1.png&quot;&gt;
</code></pre>
<p>it would get wrapped in a <code>&lt;p&gt;</code> tag, now it doesn&rsquo;t anymore. I dealt with this
just by adding a <code>margin-bottom: 0.75em</code> to images in the CSS, hopefully
that&rsquo;ll make them display well enough.</p>
<h4 id="4-10-br-is-now-wrapped-in-a-p-tag">4.10: <code>&lt;br&gt;</code> is now wrapped in a <code>p</code> tag</h4>
<p>Previously this wouldn&rsquo;t get wrapped in a <code>p</code> tag, but now it seems to:</p>
<pre><code>&lt;br&gt;&lt;br&gt;
</code></pre>
<p>I just gave up on fixing this though and resigned myself to maybe having some
extra space in some cases. Maybe I&rsquo;ll try to fix it later if I feel like
another yakshave.</p>
<h4 id="4-11-some-more-goldmark-settings">4.11: some more goldmark settings</h4>
<p>I also needed to</p>
<ul>
<li>turn off code highlighting (because it wasn&rsquo;t working properly and I didn&rsquo;t have it before anyway)</li>
<li>use the old &ldquo;blackfriday&rdquo; method to generate heading IDs so they didn&rsquo;t change</li>
<li>allow raw HTML in my markdown</li>
</ul>
<p>Here&rsquo;s what I needed to add to my <code>config.yaml</code> to do all that:</p>
<pre><code>markup:
  highlight:
    codeFences: false
  goldmark:
    renderer:
      unsafe: true
    parser:
      autoHeadingIDType: blackfriday
</code></pre>
<p>Maybe I&rsquo;ll try to get syntax highlighting working one day, who knows. I might
prefer having it off though.</p>
<h3 id="a-little-script-to-compare-blackfriday-and-goldmark">a little script to compare blackfriday and goldmark</h3>
<p>I also wrote a little program to compare the Blackfriday and Goldmark output
for various markdown snippets, <a href="https://gist.github.com/jvns/9cc3024ff98433ced5e3a2304c5fc5e4">here it is in a gist</a>.</p>
<p>It&rsquo;s not really configured the exact same way Blackfriday and Goldmark were in
my Hugo versions, but it was still helpful to have to help me understand what
was going on.</p>
<h3 id="a-quick-note-on-maintaining-themes">a quick note on maintaining themes</h3>
<p>My approach to themes in Hugo has been:</p>
<ol>
<li>pay someone to make a nice design for the site (for example wizardzines.com was designed by <a href="https://melody.dev/">Melody Starling</a>)</li>
<li>use a totally custom theme</li>
<li>commit that theme to the same Github repo as the site</li>
</ol>
<p>So I just need to edit the theme files to fix any problems. Also I wrote a lot
of the theme myself so I&rsquo;m pretty familiar with how it works.</p>
<p>Relying on someone else to keep a theme updated feels kind of scary to me, I
think if I were using a third-party theme I&rsquo;d just copy the code into my site&rsquo;s
github repo and then maintain it myself.</p>
<h3 id="which-static-site-generators-have-better-backwards-compatibility">which static site generators have better backwards compatibility?</h3>
<p>I <a href="https://social.jvns.ca/@b0rk/113260718682453232">asked on Mastodon</a> if
anyone had used a static site generator with good backwards compatibility.</p>
<p>The main answers seemed to be Jekyll and 11ty. Several people said they&rsquo;d been
using Jekyll for 10 years without any issues, and 11ty says it has
<a href="https://www.11ty.dev/blog/stability/">stability as a core goal</a>.</p>
<p>I think a big factor in how appealing Jekyll/11ty are is how easy it is for you
to maintain a working Ruby / Node environment on your computer: part of the
reason I stopped using Jekyll was that I got tired of having to maintain a
working Ruby installation. But I imagine this wouldn&rsquo;t be a problem for a Ruby
or Node developer.</p>
<p>Several people said that they don&rsquo;t build their Jekyll site locally at all &ndash;
they just use GitHub Pages to build it.</p>
<h3 id="that-s-it">that&rsquo;s it!</h3>
<p>Overall I&rsquo;ve been happy with Hugo &ndash; I <a href="https://jvns.ca/blog/2016/10/09/switching-to-hugo/">started using it</a> because it had fast
build times and it was a static binary, and both of those things are still
extremely useful to me. I might have spent 10 hours on this upgrade, but I&rsquo;ve
probably spent 1000+ hours writing blog posts without thinking about Hugo at
all so that seems like an extremely reasonable ratio.</p>
<p>I find it hard to be too mad about the backwards incompatible changes, most of
them were quite a long time ago, Hugo does a great job of making their old
releases available so you can use the old release if you want, and the most
difficult one is removing support for the <code>blackfriday</code> Markdown renderer in
favour of using something CommonMark-compliant which seems pretty reasonable to
me even if it is a huge pain.</p>
<p>But it did take a long time and I don&rsquo;t think I&rsquo;d particularly recommend moving
700 blog posts to a new Markdown renderer unless you&rsquo;re really in the mood for
a lot of computer suffering for some reason.</p>
<p>The new renderer did fix a bunch of problems so I think overall it might be a
good thing, even if I&rsquo;ll have to remember to make 2 changes to how I write
Markdown (4.1 and 4.3).</p>
<p>Also I&rsquo;m still using Hugo 0.54 for <a href="https://wizardzines.com">https://wizardzines.com</a> so maybe these notes
will be useful to Future Me if I ever feel like upgrading Hugo for that site.</p>
<p>Hopefully I didn&rsquo;t break too many things on the blog by doing this, let me know
if you see anything broken!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Terminal colours are tricky]]></title>
    <link href="https://jvns.ca/blog/2024/10/01/terminal-colours/"/>
    <updated>2024-10-01T10:01:44+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/01/terminal-colours/</id>
    <content type="html"><![CDATA[<p>Yesterday I was thinking about how long it took me to get a colorscheme in my
terminal that I was mostly happy with (SO MANY YEARS), and it made me wonder
what about terminal colours made it so hard.</p>
<p>So I <a href="https://social.jvns.ca/@b0rk/113226972156366201">asked people on Mastodon</a> what problems
they&rsquo;ve run into with colours in the terminal, and I got a ton of interesting
responses! Let&rsquo;s talk about some of the problems and a few possible ways to fix
them.</p>
<h3 id="problem-1-blue-on-black">problem 1: blue on black</h3>
<p>One of the top complaints was &ldquo;blue on black is hard to read&rdquo;. Here&rsquo;s an
example of that: if I open Terminal.app, set the background to black, and run
<code>ls</code>, the directories are displayed in a blue that isn&rsquo;t that easy to read:</p>
<img src="https://jvns.ca/images/terminal-blue.png" style="max-width: 400px">
<p>To understand why we&rsquo;re seeing this blue, let&rsquo;s talk about ANSI colours!</p>
<h3 id="the-16-ansi-colours">the 16 ANSI colours</h3>
<p>Your terminal has 16 numbered colours &ndash; black, red, green, yellow, blue,
magenta, cyan, white, and &ldquo;bright&rdquo; version of each of those.</p>
<p>Programs can use them by printing out an &ldquo;ANSI escape code&rdquo; &ndash; for example if
you want to see each of the 16 colours in your terminal, you can run this
Python program:</p>
<pre><code class="language-python">def color(num, text):
    return f&quot;\033[38;5;{num}m{text}\033[0m&quot;

for i in range(16):
    print(color(i, f&quot;number {i:02}&quot;))
</code></pre>
<h3 id="what-are-the-ansi-colours">what are the ANSI colours?</h3>
<p>This made me wonder &ndash; if blue is colour number 5, who decides what hex color
that should correspond to?</p>
<p>The answer seems to be &ldquo;there&rsquo;s no standard, terminal emulators just choose
colours and it&rsquo;s not very consistent&rdquo;. Here&rsquo;s a <a href="https://en.m.wikipedia.org/wiki/ANSI_escape_code#Colors">screenshot of a table from Wikipedia</a>, where you
can see that there&rsquo;s a lot of variation:</p>
<img src="https://jvns.ca/images/wikipedia.png"> 
<h3 id="problem-1-5-bright-yellow-on-white">problem 1.5: bright yellow on white</h3>
<p>Bright yellow on white is even worse than blue on black, here&rsquo;s what I get in
a terminal with the default settings:</p>
<img src="https://jvns.ca/images/terminal-yellow.png" style="max-height: 40px">
<p>That&rsquo;s almost impossible to read (and some other colours like light green cause
similar issues), so let&rsquo;s talk about solutions!</p>
<h3 id="two-ways-to-reconfigure-your-colours">two ways to reconfigure your colours</h3>
<p>If you&rsquo;re annoyed by these colour contrast issues (or maybe you just think the
default ANSI colours are ugly), you might think &ndash; well, I&rsquo;ll just choose a
different &ldquo;blue&rdquo; and pick something I like better!</p>
<p>There are two ways you can do this:</p>
<p><strong>Way 1: Configure your terminal emulator</strong>: I think most modern terminal emulators
have a way to reconfigure the colours, and some of them even come with some
preinstalled themes that you might like better than the defaults.</p>
<p><strong>Way 2: Run a shell script</strong>: There are ANSI escape codes that you can print
out to tell your terminal emulator to reconfigure its colours. <a href="https://github.com/chriskempson/base16-shell/blob/master/scripts/base16-solarized-light.sh">Here&rsquo;s a shell script that does that</a>,
from the <a href="https://github.com/chriskempson/base16-shell">base16-shell</a> project.
You can see that it has a few different conventions for changing the colours &ndash;
I guess different terminal emulators have different escape codes for changing
their colour palette, and so the script is trying to pick the right style of
escape code based on the <code>TERM</code> environment variable.</p>
<h3 id="what-are-the-pros-and-cons-of-the-2-ways-of-configuring-your-colours">what are the pros and cons of the 2 ways of configuring your colours?</h3>
<p>I prefer to use the &ldquo;shell script&rdquo; method, because:</p>
<ul>
<li>if I switch terminal emulators for some reason, I don&rsquo;t need to a different configuration system, my colours still Just Work</li>
<li>I use <a href="https://github.com/chriskempson/base16-shell">base16-shell</a> with base16-vim to make my vim colours match my terminal colours, which is convenient</li>
</ul>
<p>some advantages of configuring colours in your terminal emulator:</p>
<ul>
<li>if you use a popular terminal emulator, there are probably a lot more nice terminal themes out there that you can choose from</li>
<li>not all terminal emulators support the &ldquo;shell script method&rdquo;, and even if
they do, the results can be a little inconsistent</li>
</ul>
<p>This is what my shell has looked like for probably the last 5 years (using the
solarized light base16 theme), and I&rsquo;m pretty happy with it. Here&rsquo;s <code>htop</code>:</p>
<img src="https://jvns.ca/images/terminal-my-colours.png" style="max-width: 400px">
<p>Okay, so let&rsquo;s say you&rsquo;ve found a terminal colorscheme that you like. What else
can go wrong?</p>
<h3 id="problem-2-programs-using-256-colours">problem 2: programs using 256 colours</h3>
<p>Here&rsquo;s what some output of <code>fd</code>, a <code>find</code> alternative, looks like in my
colorscheme:</p>
<img src="https://jvns.ca/images/terminal-problem-fd.png" style="max-width: 400px">
<p>The contrast is pretty bad here, and I definitely don&rsquo;t have that lime green in
my normal colorscheme. What&rsquo;s going on?</p>
<p>We can see what color codes <code>fd</code> is using using the <code>unbuffer</code> program to
capture its output including the color codes:</p>
<pre><code>$ unbuffer fd . &gt; out
$ vim out
^[[38;5;48mbad-again.sh^[[0m
^[[38;5;48mbad.sh^[[0m
^[[38;5;48mbetter.sh^[[0m
out
</code></pre>
<p><code>^[[38;5;48</code> means &ldquo;set the foreground color to color <code>48</code>&rdquo;. Terminals don&rsquo;t
only have 16 colours &ndash; many terminals these days actually have 3 ways of
specifying colours:</p>
<ol>
<li>the 16 ANSI colours we already talked about</li>
<li>an extended set of 256 colours</li>
<li>a further extended set of 24-bit hex colours, like <code>#ffea03</code></li>
</ol>
<p>So <code>fd</code> is using one of the colours from the extended 256-color set. <code>bat</code> (a
<code>cat</code> alternative) does something similar &ndash; here&rsquo;s what it looks like by
default in my terminal.</p>
<img src="https://jvns.ca/images/terminal-bat.png" style="max-width: 400px">
<p>This looks fine though and it really seems like it&rsquo;s trying to work well with a
variety of terminal themes.</p>
<h3 id="some-newer-tools-seem-to-have-theme-support">some newer tools seem to have theme support</h3>
<p>I think it&rsquo;s interesting that some of these newer terminal tools (<code>fd</code>, <code>cat</code>,
<code>delta</code>, and probably more) have support for arbitrary custom themes. I guess
the downside of this approach is that the default theme might clash with your
terminal&rsquo;s background, but the upside is that it gives you a lot more control
over theming the tool&rsquo;s output than just choosing 16 ANSI colours.</p>
<p>I don&rsquo;t really use <code>bat</code>, but if I did I&rsquo;d probably use <code>bat --theme ansi</code> to
just use the ANSI colours that I have set in my normal terminal colorscheme.</p>
<h3 id="problem-3-the-grays-in-solarized">problem 3: the grays in Solarized</h3>
<p>A bunch of people on Mastodon mentioned a specific issue with grays in the
Solarized theme: when I list a directory, the base16 Solarized Light theme
looks like this:</p>
<img src="https://jvns.ca/images/terminal-solarized-base16.png" style="max-width: 400px">
<p>but iTerm&rsquo;s default Solarized Light theme looks like this:</p>
<img src="https://jvns.ca/images/terminal-solarized-iterm.png" style="max-width: 400px">
<p>This is because in the iTerm theme (which is the <a href="https://ethanschoonover.com/solarized/#the-values">original Solarized design</a>), colors 9-14 (the &ldquo;bright blue&rdquo;, &ldquo;bright
red&rdquo;, etc) are mapped to a series of grays, and when I run <code>ls</code>, it&rsquo;s trying to
use those &ldquo;bright&rdquo; colours to color my directories and executables.</p>
<p>My best guess for why the original Solarized theme is designed this way is to
make the grays available to the <a href="https://github.com/altercation/vim-colors-solarized/blob/528a59f26d12278698bb946f8fb82a63711eec21/colors/solarized.vim">vim Solarized colorscheme</a>.</p>
<p>I&rsquo;m pretty sure I prefer the modified base16 version I use where the &ldquo;bright&rdquo;
colours are actually colours instead of all being shades of gray though. (I
didn&rsquo;t actually realize the version I was using wasn&rsquo;t the &ldquo;original&rdquo; Solarized
theme until I wrote this post)</p>
<p>In any case I really love Solarized and I&rsquo;m very happy it exists so that I can
use a modified version of it.</p>
<h3 id="problem-4-a-vim-theme-that-doesn-t-match-the-terminal-background">problem 4: a vim theme that doesn&rsquo;t match the terminal background</h3>
<p>If I my vim theme has a different background colour than my terminal theme, I
get this ugly border, like this:</p>
<img src="https://jvns.ca/images/terminal-vim-black-bg.png" style="max-width: 400px">
<p>This one is a pretty minor issue though and I think making your terminal
background match your vim background is pretty straightforward.</p>
<h3 id="problem-5-programs-setting-a-background-color">problem 5: programs setting a background color</h3>
<p>A few people mentioned problems with terminal applications setting an
unwanted background colour, so let&rsquo;s look at an example of that.</p>
<p>Here <code>ngrok</code> has set the background to color #16 (&ldquo;black&rdquo;), but the
<code>base16-shell</code> script I use sets color 16 to be bright orange, so I get this,
which is pretty bad:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized.png" style="max-width: 400px">
<p>I think the intention is for ngrok to look something like this:</p>
<img src="https://jvns.ca/images/terminal-ngrok-regular.png" style="max-width: 400px">
<p>I think <code>base16-shell</code> sets color #16 to orange (instead of black)
so that it can provide extra colours for use by <a href="https://github.com/chriskempson/base16-vim/blob/3be3cd82cd31acfcab9a41bad853d9c68d30478d/colors/base16-solarized-light.vim">base16-vim</a>.
This feels reasonable to me &ndash; I use <code>base16-vim</code> in the terminal, so I guess I&rsquo;m
using that feature and it&rsquo;s probably more important to me than <code>ngrok</code> (which I
rarely use) behaving a bit weirdly.</p>
<p>This particular issue is a maybe obscure clash between ngrok and my colorschem,
but I think this kind of clash is pretty common when a program sets an ANSI
background color that the user has remapped for some reason.</p>
<h3 id="a-nice-solution-to-contrast-issues-minimum-contrast">a nice solution to contrast issues: &ldquo;minimum contrast&rdquo;</h3>
<p>A bunch of terminals (iTerm2, <a href="https://github.com/Eugeny/tabby">tabby</a>, kitty&rsquo;s <a href="https://sw.kovidgoyal.net/kitty/conf/#opt-kitty.text_fg_override_threshold">text_fg_override_threshold</a>, and
folks tell me also Ghostty and Windows Terminal) have a &ldquo;minimum
contrast&rdquo; feature that will automatically adjust colours to make sure they have enough contrast.</p>
<p>Here&rsquo;s an example from iTerm. This ngrok accident from before has pretty bad
contrast, I find it pretty difficult to read:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized.png" style="max-width: 400px">
<p>With &ldquo;minimum contrast&rdquo; set to 40 in iTerm, it looks like this instead:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized-contrast.png" style="max-width: 400px">
<p>I didn&rsquo;t have minimum contrast turned on before but I just turned it on today
because it makes such a big difference when something goes wrong with colours
in the terminal.</p>
<h3 id="problem-6-term-being-set-to-the-wrong-thing">problem 6: <code>TERM</code> being set to the wrong thing</h3>
<p>A few people mentioned that they&rsquo;ll SSH into a system that doesn&rsquo;t support the
<code>TERM</code> environment variable that they have set locally, and then the colours
won&rsquo;t work.</p>
<p>I think the way <code>TERM</code> works is that systems have a <code>terminfo</code> database, so if
the value of the <code>TERM</code> environment variable isn&rsquo;t in the system&rsquo;s terminfo
database, then it won&rsquo;t know how to output colours for that terminal. I don&rsquo;t
know too much about terminfo, but someone linked me to this <a href="https://twoot.site/@bean/113056942625234032">terminfo rant</a> that talks about a few other
issues with terminfo.</p>
<p>I don&rsquo;t have a system on hand to reproduce this one so I can&rsquo;t say for sure how
to fix it, but <a href="https://unix.stackexchange.com/questions/67537/prevent-ssh-client-passing-term-environment-variable-to-server">this stackoverflow question</a>
suggests running something like <code>TERM=xterm ssh</code> instead of <code>ssh</code>.</p>
<h3 id="problem-7-picking-good-colours-is-hard">problem 7: picking &ldquo;good&rdquo; colours is hard</h3>
<p>A couple of problems people mentioned with designing / finding terminal colorschemes:</p>
<ul>
<li>some folks are colorblind and have trouble finding an appropriate colorscheme</li>
<li>accidentally making the background color too close to the cursor or selection color, so they&rsquo;re hard to find</li>
<li>generally finding colours that work with every program is a struggle (for example you can see me having a problem with this with ngrok above!)</li>
</ul>
<h3 id="problem-8-making-nethack-mc-look-right">problem 8: making nethack/mc look right</h3>
<p>Another problem people mentioned is using a program like nethack or midnight
commander which you might expect to have a specific colourscheme based on the
default ANSI terminal colours.</p>
<p>For example, midnight commander has a really specific classic look:</p>
<img src="https://jvns.ca/images/terminal-mc-normal.png" style="max-width: 200px">
<p>But in my Solarized theme, midnight commander looks like this:</p>
<img src="https://jvns.ca/images/terminal-mc-solarized.png" style="max-width: 200px">
<p>The Solarized version feels like it could be disorienting if you&rsquo;re
very used to the &ldquo;classic&rdquo; look.</p>
<p>One solution Simon Tatham mentioned to this is using some palette customization
ANSI codes (like the ones base16 uses that I talked about earlier) to change
the color palette right before starting the program, for example remapping
yellow to a brighter yellow before starting Nethack so that the yellow
characters look better.</p>
<h3 id="problem-9-commands-disabling-colours-when-writing-to-a-pipe">problem 9: commands disabling colours when writing to a pipe</h3>
<p>If I run <code>fd | less</code>, I see something like this, with the colours disabled.</p>
<img src="https://jvns.ca/images/terminal-fd-bw.png" style="max-width: 300px">
<p>In general I find this useful &ndash; if I pipe a command to <code>grep</code>, I don&rsquo;t want it
to print out all those color escape codes, I just want the plain text. But what if you want to see the colours?</p>
<p>To see the colours, you can run <code>unbuffer fd | less -r</code>! I just learned about
<code>unbuffer</code> recently and I think it&rsquo;s really cool, <code>unbuffer</code> opens a tty for the
command to write to so that it thinks it&rsquo;s writing to a TTY. It also fixes
issues with programs buffering their output when writing to a pipe, which is
why it&rsquo;s called <code>unbuffer</code>.</p>
<p>Here&rsquo;s what the output of <code>unbuffer fd | less -r</code> looks like for me:</p>
<img src="https://jvns.ca/images/terminal-fd-color.png" style="max-width: 300px">
<p>Also some commands (including <code>fd</code>) support a <code>--color=always</code> flag which will
force them to always print out the colours.</p>
<h3 id="problem-10-unwanted-colour-in-ls-and-other-commands">problem 10: unwanted colour in <code>ls</code> and other commands</h3>
<p>Some people mentioned that they don&rsquo;t want <code>ls</code> to use colour at all, perhaps
because <code>ls</code> uses blue, it&rsquo;s hard to read on black, and maybe they don&rsquo;t feel like
customizing their terminal&rsquo;s colourscheme to make the blue more readable or
just don&rsquo;t find the use of colour helpful.</p>
<p>Some possible solutions to this one:</p>
<ul>
<li>you can run <code>ls --color=never</code>, which is probably easiest</li>
<li>you can also set <code>LS_COLORS</code> to customize the colours used by <code>ls</code>. I think some other programs other than <code>ls</code> support the <code>LS_COLORS</code> environment variable too.</li>
<li>also some programs support setting <code>NO_COLOR=true</code> (there&rsquo;s a <a href="https://no-color.org/">list here</a>)</li>
</ul>
<p>Here&rsquo;s an example of running <code>LS_COLORS=&quot;fi=0:di=0:ln=0:pi=0:so=0:bd=0:cd=0:or=0:ex=0&quot; ls</code>:</p>
<img src="https://jvns.ca/images/terminal-ls-colors.png" style="max-width: 500px">
<h3 id="problem-11-the-colours-in-vim">problem 11: the colours in vim</h3>
<p>I used to have a lot of problems with configuring my colours in vim &ndash; I&rsquo;d set
up my terminal colours in a way that I thought was okay, and then I&rsquo;d start vim
and it would just be a disaster.</p>
<p>I think what was going on here is that today, there are two ways to set up a vim colorscheme in the terminal:</p>
<ol>
<li>using your ANSI terminal colours &ndash; you tell vim which ANSI colour number to use for the background, for functions, etc.</li>
<li>using 24-bit hex colours &ndash; instead of ANSI terminal colours, the vim colorscheme can use hex codes like #faea99 directly</li>
</ol>
<p>20 years ago when I started using vim, terminals with 24-bit hex color support
were a lot less common (or maybe they didn&rsquo;t exist at all), and vim certainly
didn&rsquo;t have support for using 24-bit colour in the terminal. From some quick
searching through git, it looks like <a href="https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd">vim added support for 24-bit colour in 2016</a>
&ndash; just 8 years ago!</p>
<p>So to get colours to work properly in vim before 2016, you needed to synchronize
your terminal colorscheme and your vim colorscheme. <a href="https://github.com/chriskempson/base16-vim/blob/3be3cd82cd31acfcab9a41bad853d9c68d30478d/colors/base16-solarized-light.vim#L52-L71">Here&rsquo;s what that looked like</a>,
the colorscheme needed to map the vim color classes like <code>cterm05</code> to ANSI colour numbers.</p>
<p>But in 2024, the story is really different! Vim (and Neovim, which I use now)
support 24-bit colours, and as of Neovim 0.10 (released in May 2024), the
<code>termguicolors</code> setting (which tells Vim to use 24-bit hex colours for
colorschemes) is <a href="https://neovim.io/doc/user/news-0.10.html">turned on by default</a> in any terminal with 24-bit
color support.</p>
<p>So this &ldquo;you need to synchronize your terminal colorscheme and your vim
colorscheme&rdquo; problem is not an issue anymore for me in 2024, since I
don&rsquo;t plan to use terminals without 24-bit color support in the future.</p>
<p>The biggest consequence for me of this whole thing is that I don&rsquo;t need base16
to set colors 16-21 to weird stuff anymore to integrate with vim &ndash; I can just
use a terminal theme and a vim theme, and as long as the two themes use similar
colours (so it&rsquo;s not jarring for me to switch between them) there&rsquo;s no problem.
I think I can just remove those parts from my <code>base16</code> shell script and totally
avoid the problem with ngrok and the weird orange background I talked about
above.</p>
<h3 id="some-more-problems-i-left-out">some more problems I left out</h3>
<p>I think there are a lot of issues around the intersection of multiple programs,
like using some combination tmux/ssh/vim that I couldn&rsquo;t figure out how to
reproduce well enough to talk about them. Also I&rsquo;m sure I missed a lot of other
things too.</p>
<h3 id="base16-has-really-worked-for-me">base16 has really worked for me</h3>
<p>I&rsquo;ve personally had a lot of success with using
<a href="https://github.com/chriskempson/base16-shell">base16-shell</a> with
<a href="https://github.com/chriskempson/base16-vim">base16-vim</a> &ndash; I just need to add <a href="https://github.com/chriskempson/base16-shell?tab=readme-ov-file#fish">a couple of lines</a> to my
fish config to set it up (+ a few <code>.vimrc</code> lines) and then I can move on and
accept any remaining problems that that doesn&rsquo;t solve.</p>
<p>I don&rsquo;t think base16 is for everyone though, some limitations I&rsquo;m aware
of with base16 that might make it not work for you:</p>
<ul>
<li>it comes with a limited set of builtin themes and you might not like any of them</li>
<li>the Solarized base16 theme (and maybe all of the themes?) sets the &ldquo;bright&rdquo;
ANSI colours to be exactly the same as the normal colours, which might cause
a problem if you&rsquo;re relying on the &ldquo;bright&rdquo; colours to be different from the
regular ones</li>
<li>it sets colours 16-21 in order to give the vim colorschemes from <code>base16-vim</code>
access to more colours, which might not be relevant if you always use a
terminal with 24-bit color support, and can cause problems like the ngrok
issue above</li>
<li>also the way it sets colours 16-21 could be a problem in terminals that don&rsquo;t
have 256-color support, like the linux framebuffer terminal</li>
</ul>
<p>Apparently there&rsquo;s a community fork of base16 called
<a href="https://github.com/tinted-theming/home">tinted-theming</a>, which I haven&rsquo;t
looked into much yet.</p>
<h3 id="some-other-colorscheme-tools">some other colorscheme tools</h3>
<p>Just one so far but I&rsquo;ll link more if people tell me about them:</p>
<ul>
<li><a href="https://rootloops.sh/">rootloops.sh</a> for generating colorschemes (and <a href="https://hamvocke.com/blog/lets-create-a-terminal-color-scheme/">&ldquo;let&rsquo;s create a terminal color scheme&rdquo;</a>)</li>
<li>Some popular colorschemes (according to people I asked on Mastodon): <a href="https://catppuccin.com/">catpuccin</a>, Monokai, Gruvbox, <a href="https://github.com/dracula">Dracula</a>, <a href="https://protesilaos.com/emacs/modus-themes">Modus (a high contrast theme)</a>, <a href="https://github.com/folke/tokyonight.nvim">Tokyo Night</a>, <a href="https://www.nordtheme.com/">Nord</a>, <a href="https://rosepinetheme.com/">Rosé Pine</a></li>
</ul>
<h3 id="okay-that-was-a-lot">okay, that was a lot</h3>
<p>We talked about a lot in this post and  while I think learning about all these
details is kind of fun if I&rsquo;m in the mood to do a deep dive, I find it SO
FRUSTRATING to deal with it when I just want my colours to work! Being
surprised by unreadable text and having to find a workaround is just not my
idea of a good day.</p>
<p>Personally I&rsquo;m a zero-configuration kind of person and it&rsquo;s not that appealing
to me to have to put together a lot of custom configuration just to make my
colours in the terminal look acceptable. I&rsquo;d much rather just have some
reasonable defaults that I don&rsquo;t have to change.</p>
<h3 id="minimum-contrast-seems-like-an-amazing-feature">minimum contrast seems like an amazing feature</h3>
<p>My one big takeaway from writing this was to turn on &ldquo;minimum contrast&rdquo; in my
terminal, I think it&rsquo;s going to fix most of the occasional accidental
unreadable text issues I run into and I&rsquo;m pretty excited about it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some Go web dev notes]]></title>
    <link href="https://jvns.ca/blog/2024/09/27/some-go-web-dev-notes/"/>
    <updated>2024-09-27T11:16:00+00:00</updated>
    <id>https://jvns.ca/blog/2024/09/27/some-go-web-dev-notes/</id>
    <content type="html"><![CDATA[<p>I spent a lot of time in the past couple of weeks working on a website in Go
that may or may not ever see the light of day, but I learned a couple of things
along the way I wanted to write down. Here they are:</p>
<h3 id="go-1-22-now-has-better-routing">go 1.22 now has better routing</h3>
<p>I&rsquo;ve never felt motivated to learn any of the Go routing libraries
(gorilla/mux, chi, etc), so I&rsquo;ve been doing all my routing by hand, like this.</p>
<pre><code>	// DELETE /records:
	case r.Method == &quot;DELETE&quot; &amp;&amp; n == 1 &amp;&amp; p[0] == &quot;records&quot;:
		if !requireLogin(username, r.URL.Path, r, w) {
			return
		}
		deleteAllRecords(ctx, username, rs, w, r)
	// POST /records/&lt;ID&gt;
	case r.Method == &quot;POST&quot; &amp;&amp; n == 2 &amp;&amp; p[0] == &quot;records&quot; &amp;&amp; len(p[1]) &gt; 0:
		if !requireLogin(username, r.URL.Path, r, w) {
			return
		}
		updateRecord(ctx, username, p[1], rs, w, r)

</code></pre>
<p>But apparently <a href="https://go.dev/blog/routing-enhancements">as of Go 1.22</a>, Go
now has better support for routing in the standard library, so that code can be
rewritten something like this:</p>
<pre><code>	mux.HandleFunc(&quot;DELETE /records/&quot;, app.deleteAllRecords)
	mux.HandleFunc(&quot;POST /records/{record_id}&quot;, app.updateRecord)
</code></pre>
<p>Though it would also need a login middleware, so maybe something more like
this, with a <code>requireLogin</code> middleware.</p>
<pre><code>	mux.Handle(&quot;DELETE /records/&quot;, requireLogin(http.HandlerFunc(app.deleteAllRecords)))
</code></pre>
<h3 id="a-gotcha-with-the-built-in-router-redirects-with-trailing-slashes">a gotcha with the built-in router: redirects with trailing slashes</h3>
<p>One annoying gotcha I ran into was: if I make a route for <code>/records/</code>, then a
request for <code>/records</code> <a href="https://pkg.go.dev/net/http#hdr-Trailing_slash_redirection-ServeMux">will be redirected</a> to <code>/records/</code>.</p>
<p>I ran into an issue with this where sending a POST request to <code>/records</code>
redirected to a GET request for <code>/records/</code>, which broke the POST request
because it removed the request body. Thankfully <a href="https://xeiaso.net/blog/go-servemux-slash-2021-11-04/">Xe Iaso wrote a blog post about the exact same issue</a> which made it
easier to debug.</p>
<p>I think the solution to this is just to use API endpoints like <code>POST /records</code>
instead of <code>POST /records/</code>, which seems like a more normal design anyway.</p>
<h3 id="sqlc-automatically-generates-code-for-my-db-queries">sqlc automatically generates code for my db queries</h3>
<p>I got a little bit tired of writing so much boilerplate for my SQL queries, but
I didn&rsquo;t really feel like learning an ORM, because I know what SQL queries I
want to write, and I didn&rsquo;t feel like learning the ORM&rsquo;s conventions for
translating things into SQL queries.</p>
<p>But then I found <a href="https://sqlc.dev/">sqlc</a>, which will compile a query like this:</p>
<pre><code>
-- name: GetVariant :one
SELECT *
FROM variants
WHERE id = ?;

</code></pre>
<p>into Go code like this:</p>
<pre><code>const getVariant = `-- name: GetVariant :one
SELECT id, created_at, updated_at, disabled, product_name, variant_name
FROM variants
WHERE id = ?
`

func (q *Queries) GetVariant(ctx context.Context, id int64) (Variant, error) {
	row := q.db.QueryRowContext(ctx, getVariant, id)
	var i Variant
	err := row.Scan(
		&amp;i.ID,
		&amp;i.CreatedAt,
		&amp;i.UpdatedAt,
		&amp;i.Disabled,
		&amp;i.ProductName,
		&amp;i.VariantName,
	)
	return i, err
}
</code></pre>
<p>What I like about this is that if I&rsquo;m ever unsure about what Go code to write
for a given SQL query, I can just write the query I want, read the generated
function and it&rsquo;ll tell me exactly what to do to call it. It feels much easier
to me than trying to dig through the ORM&rsquo;s documentation to figure out how to
construct the SQL query I want.</p>
<p>Reading <a href="https://brandur.org/fragments/sqlc-2024">Brandur&rsquo;s sqlc notes from 2024</a> also gave me some confidence
that this is a workable path for my tiny programs. That post gives a really
helpful example of how to conditionally update fields in a table using CASE
statements (for example if you have a table with 20 columns and you only want
to update 3 of them).</p>
<h3 id="sqlite-tips">sqlite tips</h3>
<p>Someone on Mastodon linked me to this post called <a href="https://kerkour.com/sqlite-for-servers">Optimizing sqlite for servers</a>. My projects are small and I&rsquo;m
not so concerned about performance, but my main takeaways were:</p>
<ul>
<li>have a dedicated object for <strong>writing</strong> to the database, and run
<code>db.SetMaxOpenConns(1)</code> on it. I learned the hard way that if I don&rsquo;t do this
then I&rsquo;ll get <code>SQLITE_BUSY</code> errors from two threads trying to write to the db
at the same time.</li>
<li>if I want to make reads faster, I could have 2 separate db objects, one for writing and one for reading</li>
</ul>
<p>There are a more tips in that post that seem useful (like &ldquo;COUNT queries are
slow&rdquo; and &ldquo;Use STRICT tables&rdquo;), but I haven&rsquo;t done those yet.</p>
<p>Also sometimes if I have two tables where I know I&rsquo;ll never need to do a <code>JOIN</code>
beteween them, I&rsquo;ll just put them in separate databases so that I can connect
to them independently.</p>
<h3 id="go-1-19-introduced-a-way-to-set-a-gc-memory-limit">Go 1.19 introduced a way to set a GC memory limit</h3>
<p>I run all of my Go projects in VMs with relatively little memory, like 256MB or
512MB. I ran into an issue where my application kept getting OOM killed and it
was confusing &ndash; did I have a memory leak? What?</p>
<p>After some Googling, I realized that maybe I didn&rsquo;t have a memory leak, maybe I
just needed to reconfigure the garbage collector! It turns out that by default (according to <a href="https://tip.golang.org/doc/gc-guide">A Guide to the Go Garbage Collector</a>), Go&rsquo;s garbage collector will
let the application allocate memory up to <strong>2x</strong> the current heap size.</p>
<p><a href="https://messwithdns.net">Mess With DNS</a>&rsquo;s base heap size is around 170MB and
the amount of memory free on the VM is around 160MB right now, so if its memory
doubled, it&rsquo;ll get OOM killed.</p>
<p>In Go 1.19, they added a way to tell Go &ldquo;hey, if the application starts using
this much memory, run a GC&rdquo;. So I set the GC memory limit to 250MB and it seems
to have resulted in the application getting OOM killed less often:</p>
<pre><code>export GOMEMLIMIT=250MiB
</code></pre>
<h3 id="some-reasons-i-like-making-websites-in-go">some reasons I like making websites in Go</h3>
<p>I&rsquo;ve been making tiny websites (like the <a href="https://nginx-playground.wizardzines.com/">nginx playground</a>) in Go on and off for the last 4 years or so and it&rsquo;s really been working for me. I think I like it because:</p>
<ul>
<li>there&rsquo;s just 1 static binary, all I need to do to deploy it is copy the binary. If there are static files I can just embed them in the binary with <a href="https://pkg.go.dev/embed">embed</a>.</li>
<li>there&rsquo;s a built-in webserver that&rsquo;s okay to use in production, so I don&rsquo;t need to configure WSGI or whatever to get it to work. I can just put it behind <a href="https://caddyserver.com/">Caddy</a> or run it on fly.io or whatever.</li>
<li>Go&rsquo;s toolchain is very easy to install, I can just do <code>apt-get install golang-go</code> or whatever and then a <code>go build</code> will build my project</li>
<li>it feels like there&rsquo;s very little to remember to start sending HTTP responses
&ndash; basically all there is are functions like <code>Serve(w http.ResponseWriter, r *http.Request)</code> which read the request and send a response. If I need to
remember some detail of how exactly that&rsquo;s accomplished, I just have to read
the function!</li>
<li>also <code>net/http</code> is in the standard library, so you can start making websites
without installing any libraries at all. I really appreciate this one.</li>
<li>Go is a pretty systems-y language, so if I need to run an <code>ioctl</code> or
something that&rsquo;s easy to do</li>
</ul>
<p>In general everything about it feels like it makes projects easy to work on for
5 days, abandon for 2 years, and then get back into writing code without a lot
of problems.</p>
<p>For contrast, I&rsquo;ve tried to learn Rails a couple of times and I really <em>want</em>
to love Rails &ndash; I&rsquo;ve made a couple of toy websites in Rails and it&rsquo;s always
felt like a really magical experience. But ultimately when I come back to those
projects I can&rsquo;t remember how anything works and I just end up giving up. It
feels easier to me to come back to my Go projects that are full of a lot of
repetitive boilerplate, because at least I can read the code and figure out how
it works.</p>
<h3 id="things-i-haven-t-figured-out-yet">things I haven&rsquo;t figured out yet</h3>
<p>some things I haven&rsquo;t done much of yet in Go:</p>
<ul>
<li>rendering HTML templates: usually my Go servers are just APIs and I make the
frontend a single-page app with Vue. I&rsquo;ve used <code>html/template</code> a lot in Hugo (which I&rsquo;ve used for this blog for the last 8 years)
but I&rsquo;m still not sure how I feel about it.</li>
<li>I&rsquo;ve never made a real login system, usually my servers don&rsquo;t have users at all.</li>
<li>I&rsquo;ve never tried to implement CSRF</li>
</ul>
<p>In general I&rsquo;m not sure how to implement security-sensitive features so I don&rsquo;t
start projects which need login/CSRF/etc. I imagine this is where a framework
would help.</p>
<h3 id="it-s-cool-to-see-the-new-features-go-has-been-adding">it&rsquo;s cool to see the new features Go has been adding</h3>
<p>Both of the Go features I mentioned in this post (<code>GOMEMLIMIT</code> and the routing)
are new in the last couple of years and I didn&rsquo;t notice when they came out. It
makes me think I should pay closer attention to the release notes for new Go
versions.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reasons I still love the fish shell]]></title>
    <link href="https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/"/>
    <updated>2024-09-12T15:09:12+00:00</updated>
    <id>https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/</id>
    <content type="html"><![CDATA[<p>I wrote about how much I love <a href="https://fishshell.com/">fish</a> in <a href="https://jvns.ca/blog/2017/04/23/the-fish-shell-is-awesome/">this blog post from 2017</a> and, 7 years
of using it every day later, I&rsquo;ve found even more reasons to love it. So I
thought I&rsquo;d write a new post with both the old reasons I loved it and some
reasons.</p>
<p>This came up today because I was trying to figure out why my terminal doesn&rsquo;t
break anymore when I cat a binary to my terminal, the answer was &ldquo;fish fixes
the terminal!&rdquo;, and I just thought that was really nice.</p>
<h3 id="1-no-configuration">1. no configuration</h3>
<p>In 10 years of using fish I have never found a single thing I wanted to configure. It just works the way I want. My fish config file just has:</p>
<ul>
<li>environment variables</li>
<li>aliases (<code>alias ls eza</code>, <code>alias vim nvim</code>, etc)</li>
<li>the occasional <code>direnv hook fish | source</code> to integrate a tool like direnv</li>
<li>a script I run to set up my <a href="https://github.com/chriskempson/base16-shell/blob/588691ba71b47e75793ed9edfcfaa058326a6f41/scripts/base16-solarized-light.sh">terminal colours</a></li>
</ul>
<p>I&rsquo;ve been told that configuring things in fish is really easy if you ever do
want to configure something though.</p>
<h3 id="2-autosuggestions-from-my-shell-history">2. autosuggestions from my shell history</h3>
<p>My absolute favourite thing about fish is that I type, it’ll automatically
suggest (in light grey) a matching command that I ran recently. I can press the
right arrow key to accept the completion, or keep typing to ignore it.</p>
<p>Here’s what that looks like. In this example I just typed the “v” key and it
guessed that I want to run the previous vim command again.</p>
<img src="https://jvns.ca/images/fish-2024.png">
<h3 id="2-5-smart-shell-autosuggestions">2.5 &ldquo;smart&rdquo; shell autosuggestions</h3>
<p>One of my favourite subtle autocomplete features is how fish handles autocompleting commands that contain paths in them. For example, if I run:</p>
<pre><code>$ ls blah.txt
</code></pre>
<p>that command will only be autocompleted in directories that contain <code>blah.txt</code> &ndash; it won&rsquo;t show up in a different directory. (here&rsquo;s <a href="https://github.com/fish-shell/fish-shell/issues/120#issuecomment-6376019">a short comment about how it works</a>)</p>
<p>As an example, if in this directory I type <code>bash scripts/</code>, it&rsquo;ll only suggest
history commands including files that <em>actually exist</em> in my blog&rsquo;s scripts
folder, and not the dozens of other irrelevant <code>scripts/</code> commands I&rsquo;ve run in
other folders.</p>
<p>I didn&rsquo;t understand exactly how this worked until last week, it just felt like fish was
magically able to suggest the right commands. It still feels a little like magic and I love it.</p>
<h3 id="3-pasting-multiline-commands">3. pasting multiline commands</h3>
<p>If I copy and paste multiple lines, bash will run them all, like this:</p>
<pre><code>[bork@grapefruit linux-playground (main)]$ echo hi
hi
[bork@grapefruit linux-playground (main)]$ touch blah
[bork@grapefruit linux-playground (main)]$ echo hi
hi
</code></pre>
<p>This is a bit alarming &ndash; what if I didn&rsquo;t actually <em>want</em> to run all those
commands?</p>
<p>Fish will paste them all at a single prompt, so that I can press Enter if I
actually want to run them. Much less scary.</p>
<pre><code>bork@grapefruit ~/work/&gt; echo hi

                         touch blah
                         echo hi
</code></pre>
<h3 id="4-nice-tab-completion">4. nice tab completion</h3>
<p>If I run <code>ls</code> and press tab, it&rsquo;ll display all the filenames in a nice grid. I can use either Tab, Shift+Tab, or the arrow keys to navigate the grid.</p>
<p>Also, I can tab complete from the <strong>middle</strong> of a filename &ndash; if the filename
starts with a weird character (or if it&rsquo;s just not very unique), I can type
some characters from the middle and press tab.</p>
<p>Here&rsquo;s what the tab completion looks like:</p>
<pre><code>bork@grapefruit ~/work/&gt; ls 
api/  blah.py     fly.toml   README.md
blah  Dockerfile  frontend/  test_websocket.sh
</code></pre>
<p>I honestly don&rsquo;t complete things other than filenames very much so I can&rsquo;t
speak to that, but I&rsquo;ve found the experience of tab completing filenames to be
very good.</p>
<h3 id="5-nice-default-prompt-including-git-integration">5. nice default prompt (including git integration)</h3>
<p>Fish&rsquo;s default prompt includes everything I want:</p>
<ul>
<li>username</li>
<li>hostname</li>
<li>current folder</li>
<li>git integration</li>
<li>status of last command exit (if the last command failed)</li>
</ul>
<p>Here&rsquo;s a screenshot with a few different variations on the default prompt,
including if the last command was interrupted (the <code>SIGINT</code>) or failed.</p>
<img src="https://jvns.ca/images/fish-prompt-2024.png">
<h3 id="6-nice-history-defaults">6. nice history defaults</h3>
<p>In bash, the maximum history size is 500 by default, presumably because
computers used to be slow and not have a lot of disk space. Also, by default,
commands don&rsquo;t get added to your history until you end your session. So if your
computer crashes, you lose some history.</p>
<p>In fish:</p>
<ol>
<li>the default history size is 256,000 commands. I don&rsquo;t see any reason I&rsquo;d ever need more.</li>
<li>if you open a new tab, everything you&rsquo;ve ever run (including commands in
open sessions) is immediately available to you</li>
<li>in an existing session, the history search will only include commands from
the current session, plus everything that was in history at the time that
you started the shell</li>
</ol>
<p>I&rsquo;m not sure how clearly I&rsquo;m explaining how fish&rsquo;s history system works here,
but it feels really good to me in practice. My impression is that the way it&rsquo;s
implemented is the commands are continually added to the history file, but fish
only loads the history file once, on startup.</p>
<p>I&rsquo;ll mention here that if you want to have a fancier history system in another
shell it might be worth checking out <a href="https://github.com/atuinsh/atuin">atuin</a> or <a href="https://github.com/junegunn/fzf">fzf</a>.</p>
<h3 id="7-press-up-arrow-to-search-history">7. press up arrow to search history</h3>
<p>I also like fish&rsquo;s interface for searching history: for example if I want to
edit my fish config file, I can just type:</p>
<pre><code>$ config.fish
</code></pre>
<p>and then press the up arrow to go back the last command that included <code>config.fish</code>. That&rsquo;ll complete to:</p>
<pre><code>$ vim ~/.config/fish/config.fish
</code></pre>
<p>and I&rsquo;m done. This isn&rsquo;t <em>so</em> different from using <code>Ctrl+R</code> in bash to search
your history but I think I like it a little better over all, maybe because
<code>Ctrl+R</code> has some behaviours that I find confusing (for example you can
end up accidentally editing your history which I don&rsquo;t like).</p>
<h3 id="8-the-terminal-doesn-t-break">8. the terminal doesn&rsquo;t break</h3>
<p>I used to run into issues with bash where I&rsquo;d accidentally <code>cat</code> a binary to
the terminal, and it would break the terminal.</p>
<p>Every time fish displays a prompt, it&rsquo;ll try to fix up your terminal so that
you don&rsquo;t end up in weird situations like this. I think <a href="https://github.com/fish-shell/fish-shell/blob/a979b6341d7fc4c466b3992f25da3209e0808aaa/src/reader.rs#L3601-L3623">this is some of the
code in fish to prevent broken terminals</a>.</p>
<p>Some things that it does are:</p>
<ul>
<li>turn on <code>echo</code> so that you can see the characters you type</li>
<li>make sure that newlines work properly so that you don&rsquo;t get that weird staircase effect</li>
<li>reset your terminal background colour, etc</li>
</ul>
<p>I don&rsquo;t think I&rsquo;ve run into any of these &ldquo;my terminal is broken&rdquo; issues in a
very long time, and I actually didn&rsquo;t even realize that this was because of
fish &ndash; I thought that things somehow magically just got better, or maybe I
wasn&rsquo;t making as many mistakes. But I think it was mostly fish saving me from
myself, and I really appreciate that.</p>
<h3 id="9-ctrl-s-is-disabled">9. Ctrl+S is disabled</h3>
<p>Also related to terminals breaking: fish disables Ctrl+S (which freezes your
terminal and then you need to remember to press Ctrl+Q to unfreeze it). It&rsquo;s a
feature that I&rsquo;ve never wanted and I&rsquo;m happy to not have it.</p>
<p>Apparently you can disable <code>Ctrl+S</code> in other shells with <code>stty -ixon</code>.</p>
<h3 id="10-nice-syntax-highlighting">10. nice syntax highlighting</h3>
<p>By default commands that don&rsquo;t exist are highlighted in red, like this.</p>
<img src="https://jvns.ca/images/fish-syntax-2024.png">
<h3 id="11-easier-loops">11. easier loops</h3>
<p>I find the loop syntax in fish a lot easier to type than the bash syntax. It looks like this:</p>
<pre><code>for i in *.yaml
  echo $i
end
</code></pre>
<p>Also it&rsquo;ll add indentation in your loops which is nice.</p>
<h3 id="12-easier-multiline-editing">12. easier multiline editing</h3>
<p>Related to loops: you can edit multiline commands much more easily than in bash
(just use the arrow keys to navigate the multiline command!). Also when you use
the up arrow to get a multiline command from your history, it&rsquo;ll show you the
whole command the exact same way you typed it instead of squishing it all onto
one line like bash does:</p>
<pre><code>$ bash
$ for i in *.png
&gt; do
&gt; echo $i
&gt; done
$ # press up arrow
$ for i in *.png; do echo $i; done ink
</code></pre>
<h3 id="13-ctrl-left-arrow">13. Ctrl+left arrow</h3>
<p>This might just be me, but I really appreciate that fish has the <code>Ctrl+left arrow</code> / <code>Ctrl+right arrow</code> keyboard shortcut for moving between
words when writing a command.</p>
<p>I&rsquo;m honestly a bit confused about where this keyboard shortcut is coming from
(the only documented keyboard shortcut for this I can find in fish is <code>Alt+left arrow</code> / <code>Alt + right arrow</code> which seems to do the same thing), but I&rsquo;m pretty
sure this is a fish shortcut.</p>
<p>A couple of notes about getting this shortcut to work / where it comes from:</p>
<ul>
<li>one person said they needed to switch their terminal emulator from the &ldquo;Linux
console&rdquo; keybindings to &ldquo;Default (XFree 4)&rdquo; to get it to work in fish</li>
<li>on Mac OS, <code>Ctrl+left arrow</code> switches workspaces by default, so I had to turn
that off.</li>
<li>Also apparently Ubuntu configures libreadline in <code>/etc/inputrc</code> to make
<code>Ctrl+left/right arrow</code> go back/forward a word, so it&rsquo;ll work in bash on
Ubuntu and maybe other Linux distros too. Here&rsquo;s a <a href="https://stackoverflow.com/questions/5029118/bash-ctrl-to-move-cursor-between-words-strings">stack overflow question talking about that</a></li>
</ul>
<h3 id="a-downside-not-everything-has-a-fish-integration">a downside: not everything has a fish integration</h3>
<p>Sometimes tools don&rsquo;t have instructions for integrating them with fish. That&rsquo;s annoying, but:</p>
<ul>
<li>I&rsquo;ve found this has gotten better over the last 10 years as fish has gotten
more popular. For example Python&rsquo;s virtualenv has had a fish integration for
a long time now.</li>
<li>If I need to run a POSIX shell command real quick, I can always just run <code>bash</code> or <code>zsh</code></li>
<li>I&rsquo;ve gotten much better over the years at translating simple commands to fish syntax when I need to</li>
</ul>
<p>My biggest day-to-day to annoyance is probably that for whatever reason I&rsquo;m
still not  used to fish&rsquo;s syntax for setting environment variables, I get confused
about <code>set</code> vs <code>set -x</code>.</p>
<h3 id="another-downside-fish-add-path">another downside: <code>fish_add_path</code></h3>
<p>fish has a function called <code>fish_add_path</code> that you can run to add a directory
to your <code>PATH</code> like this:</p>
<pre><code>fish_add_path /some/directory
</code></pre>
<p>I love the idea of it and I used to use it all the time, but I&rsquo;ve stopped using
it for two reasons:</p>
<ol>
<li>Sometimes <code>fish_add_path</code> will update the <code>PATH</code> for every session in the
future (with a &ldquo;universal variable&rdquo;) and sometimes it will update the <code>PATH</code>
just for the current session. It&rsquo;s hard for me to tell which one it will
do: in theory the docs explain this but I could not understand them.</li>
<li>If you ever need to <em>remove</em> the directory from your <code>PATH</code> a few weeks or
months later because maybe you made a mistake, that&rsquo;s also kind of hard to do
(there are <a href="https://github.com/fish-shell/fish-shell/issues/8604">instructions in this comments of this github issue though</a>).</li>
</ol>
<p>Instead I just update my PATH like this, similarly to how I&rsquo;d do it in bash:</p>
<pre><code>set PATH $PATH /some/directory/bin
</code></pre>
<h3 id="on-posix-compatibility">on POSIX compatibility</h3>
<p>When I started using fish, you couldn&rsquo;t do things like <code>cmd1 &amp;&amp; cmd2</code> &ndash; it
would complain &ldquo;no, you need to run <code>cmd1; and cmd2</code>&rdquo; instead.</p>
<p>It seems like over the years fish has started accepting a little more POSIX-style syntax than it used to, like:</p>
<ul>
<li><code>cmd1 &amp;&amp; cmd2</code></li>
<li><code>export a=b</code> to set an environment variable (though this seems a bit limited, you can&rsquo;t do <code>export PATH=$PATH:/whatever</code> so I think it&rsquo;s probably better to learn <code>set</code> instead)</li>
</ul>
<h3 id="on-fish-as-a-default-shell">on fish as a default shell</h3>
<p>Changing my default shell to fish is always a little annoying, I occasionally get myself into a situation where</p>
<ol>
<li>I install fish somewhere like maybe <code>/home/bork/.nix-stuff/bin/fish</code></li>
<li>I add the new fish location to <code>/etc/shells</code> as an allowed shell</li>
<li>I change my shell with <code>chsh</code></li>
<li>at some point months/years later I reinstall fish in a different location for some reason and remove the old one</li>
<li>oh no!!! I have no valid shell! I can&rsquo;t open a new terminal tab anymore!</li>
</ol>
<p>This has never been a major issue because I always have a terminal open
somewhere where I can fix the problem and rescue myself, but it&rsquo;s a bit
alarming.</p>
<p>If you don&rsquo;t want to use <code>chsh</code> to change your shell to fish (which is very reasonable,
maybe I shouldn&rsquo;t be doing that), the <a href="https://wiki.archlinux.org/title/Fish">Arch wiki page</a> has a couple of good suggestions &ndash;
either configure your terminal emulator to run fish or add an <code>exec fish</code> to
your <code>.bashrc</code>.</p>
<h3 id="i-ve-never-really-learned-the-scripting-language">I&rsquo;ve never really learned the scripting language</h3>
<p>Other than occasionally writing a for loop interactively on the command line,
I&rsquo;ve never really learned the fish scripting language. I still do all of my
shell scripting in bash.</p>
<p>I don&rsquo;t think I&rsquo;ve ever written a fish function or <code>if</code> statement.</p>
<h3 id="it-seems-like-fish-is-getting-pretty-popular">it seems like fish is getting pretty popular</h3>
<p>I ran a highly unscientific poll on Mastodon asking people what shell they <a href="https://social.jvns.ca/@b0rk/112722850642874842">use interactively</a>. The results were (of 2600 responses):</p>
<ul>
<li>46% bash</li>
<li>49% zsh</li>
<li>16% fish</li>
<li>5% other</li>
</ul>
<p>I think 16% for fish is pretty remarkable, since (as far as I know) there isn&rsquo;t
any system where fish is the default shell, and my sense is that it&rsquo;s very
common to just stick to whatever your system&rsquo;s default shell is.</p>
<p>It feels like a big achievement for the fish project, even if maybe my Mastodon
followers are more likely than the average shell user to use fish for some
reason.</p>
<h3 id="who-might-fish-be-right-for">who might fish be right for?</h3>
<p>Fish definitely isn&rsquo;t for everyone. I think I like it because:</p>
<ol>
<li>I really dislike configuring my shell (and honestly my dev environment in general), I want things to &ldquo;just work&rdquo; with the default settings</li>
<li>fish&rsquo;s defaults feel good to me</li>
<li>I don&rsquo;t spend that much time logged into random servers using other shells
so there&rsquo;s not too much context switching</li>
<li>I liked its features so much that I was willing to relearn how to do a few
&ldquo;basic&rdquo; shell things, like using parentheses <code>(seq 1 10)</code> to run a command
instead of backticks or using <code>set</code> instead of <code>export</code></li>
</ol>
<p>Maybe you&rsquo;re also a person who would like fish! I hope a few more of the people
who fish is for can find it, because I spend so much of my time in the terminal
and it&rsquo;s made that time much more pleasant.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migrating Mess With DNS to use PowerDNS]]></title>
    <link href="https://jvns.ca/blog/2024/08/19/migrating-mess-with-dns-to-use-powerdns/"/>
    <updated>2024-08-19T08:15:28+00:00</updated>
    <id>https://jvns.ca/blog/2024/08/19/migrating-mess-with-dns-to-use-powerdns/</id>
    <content type="html"><![CDATA[<p>About 3 years ago, I announced <a href="https://messwithdns.net/">Mess With DNS</a> in
<a href="https://jvns.ca/blog/2021/12/15/mess-with-dns/">this blog post</a>, a playground
where you can learn how DNS works by messing around and creating records.</p>
<p>I wasn&rsquo;t very careful with the DNS implementation though (to quote the release blog
post: &ldquo;following the DNS RFCs? not exactly&rdquo;), and people started reporting
problems that eventually I decided that I wanted to fix.</p>
<h3 id="the-problems">the problems</h3>
<p>Some of the problems people have reported were:</p>
<ul>
<li>domain names with underscores weren&rsquo;t allowed, even though they should be</li>
<li>If there was a CNAME record for a domain name, it allowed you to create other records for that domain name, even if it shouldn&rsquo;t</li>
<li>you could create 2 different CNAME records for the same domain name, which shouldn&rsquo;t be allowed</li>
<li>no support for the SVCB or HTTPS record types, which seemed a little complex to implement</li>
<li>no support for upgrading from UDP to TCP for big responses</li>
</ul>
<p>And there are certainly more issues that nobody got around to reporting, for
example that if you added an NS record for a subdomain to delegate it, Mess
With DNS wouldn&rsquo;t handle the delegation properly.</p>
<h3 id="the-solution-powerdns">the solution: PowerDNS</h3>
<p>I wasn&rsquo;t sure how to fix these problems for a long time &ndash; technically I
<em>could</em> have started addressing them individually, but it felt like there were
a million edge cases and I&rsquo;d never get there.</p>
<p>But then one day I was chatting with someone else who was working on a DNS
server and they said they were using <a href="https://github.com/PowerDNS/pdns/">PowerDNS</a>: an open
source DNS server with an HTTP API!</p>
<p>This seemed like an obvious solution to my problems &ndash; I could just swap out my
own crappy DNS implementation for PowerDNS.</p>
<p>There were a couple of challenges I ran into when setting up PowerDNS that I&rsquo;ll
talk about here. I really don&rsquo;t do a lot of web development and I think I&rsquo;ve never
built a website that depends on a relatively complex API before, so it was a
bit of a learning experience.</p>
<h3 id="challenge-1-getting-every-query-made-to-the-dns-server">challenge 1: getting every query made to the DNS server</h3>
<p>One of the main things Mess With DNS does is give you a live view of every DNS
query it receives for your subdomain, using a websocket. To make this work, it
needs to intercept every DNS query before they it gets sent to the PowerDNS DNS
server:</p>
<p>There were 2 options I could think of for how to intercept the DNS queries:</p>
<ol>
<li>dnstap: <code>dnsdist</code> (a DNS load balancer from the PowerDNS project) has
support for logging all DNS queries it receives using
<a href="https://dnstap.info/">dnstap</a>, so I could put dnsdist in front of PowerDNS
and then log queries that way</li>
<li>Have my Go server listen on port 53 and proxy the queries myself</li>
</ol>
<p>I originally implemented option #1, but for some reason there was a 1 second
delay before every query got logged. I couldn&rsquo;t figure out why, so I
implemented my own <a href="https://github.com/jvns/mess-with-dns/blob/3423c9496dd772f7157a56f9e068fd926e89c331/api/main.go#L265-L310">very simple proxy</a> instead.</p>
<h3 id="challenge-2-should-the-frontend-have-direct-access-to-the-powerdns-api">challenge 2: should the frontend have direct access to the PowerDNS API?</h3>
<p>The frontend used to have a lot of DNS logic in it &ndash; it converted emoji domain
names to ASCII using punycode, had a lookup table to convert numeric DNS query
types (like <code>1</code>) to their human-readable names (like <code>A</code>), did a little bit of
validation, and more.</p>
<p>Originally I considered keeping this pattern and just giving the frontend (more
or less) direct access to the PowerDNS API to create and delete, but writing
even more complex code in Javascript didn&rsquo;t feel that appealing to me &ndash; I
don&rsquo;t really know how to write tests in Javascript and it seemed like it
wouldn&rsquo;t end well.</p>
<p>So I decided to take all of the DNS logic out of the frontend and write a new
DNS API for managing records, shaped something like this:</p>
<ul>
<li><code>GET /records</code></li>
<li><code>DELETE /records/&lt;ID&gt;</code></li>
<li><code>DELETE /records/</code> (delete all records for a user)</li>
<li><code>POST /records/</code> (create record)</li>
<li><code>POST /records/&lt;ID&gt;</code> (update record)</li>
</ul>
<p>This meant that I could actually write tests for my code, since the backend is
in Go and I do know how to write tests in Go.</p>
<h3 id="what-i-learned-it-s-okay-for-an-api-to-duplicate-information">what I learned: it&rsquo;s okay for an API to duplicate information</h3>
<p>I had this idea that APIs shouldn&rsquo;t return duplicate information &ndash; for example
if I get a DNS record, it should only include a given piece of information
once.</p>
<p>But I ran into a problem with that idea when displaying MX records: an MX
record has 2 fields, &ldquo;preference&rdquo;, and &ldquo;mail server&rdquo;. And I needed to display
that information in 2 different ways on the frontend:</p>
<ol>
<li>In a form, where &ldquo;Preference&rdquo; and &ldquo;Mail Server&rdquo; are 2 different form fields (like <code>10</code> and <code>mail.example.com</code>)</li>
<li>In a summary view, where I wanted to just show the record (<code>10 mail.example.com</code>)</li>
</ol>
<p>This is kind of a small problem, but it came up in a few different places.</p>
<p>I talked to my friend Marco Rogers about this, and based on some advice from
him I realized that I could return the same information in the API in 2
different ways! Then the frontend just has to display it. So I started just
returning duplicate information in the API, something like this:</p>
<pre><code>{
  values: {'Preference': 10, 'Server': 'mail.example.com'},
  content: '10 mail.example.com',
  ...
}
</code></pre>
<p>I ended up using this pattern in a couple of other places where I needed to
display the same information in 2 different ways and it was SO much easier.</p>
<p>I think what I learned from this is that if I&rsquo;m making an API that isn&rsquo;t
intended for external use (there are no users of this API other than the
frontend!), I can tailor it very specifically to the frontend&rsquo;s needs and
that&rsquo;s okay.</p>
<h3 id="challenge-3-what-s-a-record-s-id">challenge 3: what&rsquo;s a record&rsquo;s ID?</h3>
<p>In Mess With DNS (and I think in most DNS user interfaces!), you create, add, and delete <strong>records</strong>.</p>
<p>But that&rsquo;s not how the PowerDNS API works. In PowerDNS, you create a <strong>zone</strong>,
which is made of <strong>record sets</strong>. Records don&rsquo;t have any ID in the API at all.</p>
<p>I ended up solving this by generate a fake ID for each records which is made of:</p>
<ul>
<li>its <strong>name</strong></li>
<li>its <strong>type</strong></li>
<li>and its <strong>content</strong> (base64-encoded)</li>
</ul>
<p>For example one record&rsquo;s ID is <code>brooch225.messwithdns.com.|NS|bnMxLm1lc3N3aXRoZG5zLmNvbS4=</code></p>
<p>Then I can search through the zone and find the appropriate record to update
it.</p>
<p>This means that if you update a record then its ID will change which isn&rsquo;t
usually what I want in an ID, but that seems fine.</p>
<h3 id="challenge-4-making-clear-error-messages">challenge 4: making clear error messages</h3>
<p>I think the error messages that the PowerDNS API returns aren&rsquo;t really intended to be shown to end users, for example:</p>
<ul>
<li><code>Name 'new\032site.island358.messwithdns.com.' contains unsupported characters</code> (this error encodes the space as <code>\032</code>, which is a bit disorienting if you don&rsquo;t know that the space character is 32 in ASCII)</li>
<li><code>RRset test.pear5.messwithdns.com. IN CNAME: Conflicts with pre-existing RRset</code> (this talks about RRsets, which aren&rsquo;t a concept that the Mess With DNS UI has at all)</li>
<li><code>Record orange.beryl5.messwithdns.com./A '1.2.3.4$': Parsing record content (try 'pdnsutil check-zone'): unable to parse IP address, strange character: $</code> (mentions &ldquo;pdnsutil&rdquo;, a utility which Mess With DNS&rsquo;s users don&rsquo;t have
access to in this context)</li>
</ul>
<p>I ended up handling this in two ways:</p>
<ol>
<li>Do some initial basic validation of values that users enter (like IP addresses), so I can just return errors like <code>Invalid IPv4 address: &quot;1.2.3.4$</code></li>
<li>If that goes well, send the request to PowerDNS and if we get an error back, then do some <a href="https://github.com/jvns/mess-with-dns/blob/c02579190e103218b2c8dfc6dceb19f863752f15/api/records/pdns_errors.go">hacky translation</a> of those messages to make them clearer.</li>
</ol>
<p>Sometimes users will still get errors from PowerDNS directly, but I added some
logging of all the errors that users see, so hopefully I can review them and
add extra translations if there are other common errors that come up.</p>
<p>I think what I learned from this is that if I&rsquo;m building a user-facing
application on top of an API, I need to be pretty thoughtful about how I
resurface those errors to users.</p>
<h3 id="challenge-5-setting-up-sqlite">challenge 5: setting up SQLite</h3>
<p>Previously Mess With DNS was using a Postgres database. This was problematic
because I only gave the Postgres machine 256MB of RAM, which meant that the
database got OOM killed almost every single day. I never really worked out
exactly why it got OOM killed every day, but that&rsquo;s how it was. I spent some
time trying to tune Postgres&rsquo; memory usage by setting the max connections /
<code>work-mem</code> / <code>maintenance-work-mem</code> and it helped a bit but didn&rsquo;t solve the
problem.</p>
<p>So for this refactor I decided to use SQLite instead, because the website
doesn&rsquo;t really get that much traffic. There are some choices involved with
using SQLite, and I decided to:</p>
<ol>
<li>Run <code>db.SetMaxOpenConns(1)</code> to make sure that we only open 1 connection to
the database at a time, to prevent <code>SQLITE_BUSY</code> errors from two threads
trying to access the database at the same time (just setting WAL mode didn&rsquo;t
work)</li>
<li>Use separate databases for each of the 3 tables (users, records, and
requests) to reduce contention. This maybe isn&rsquo;t really necessary, but there
was no reason I needed the tables to be in the same database so I figured I&rsquo;d set
up separate databases to be safe.</li>
<li>Use the cgo-free <a href="https://pkg.go.dev/modernc.org/sqlite?utm_source=godoc">modernc.org/sqlite</a>, which <a href="https://datastation.multiprocess.io/blog/2022-05-12-sqlite-in-go-with-and-without-cgo.html">translates SQLite&rsquo;s source code to Go</a>.
I might switch to a more &ldquo;normal&rdquo; sqlite implementation instead at some point and use cgo though.
I think the main reason I prefer to avoid cgo is that cgo has landed me with <a href="https://jvns.ca/blog/2021/11/17/debugging-a-weird--file-not-found--error/">difficult-to-debug errors in the past</a>.</li>
<li>use WAL mode</li>
</ol>
<p>I still haven&rsquo;t set up backups, though I don&rsquo;t think my Postgres database had
backups either. I think I&rsquo;m unlikely to use
<a href="https://litestream.io/">litestream</a> for backups &ndash; Mess With DNS is very far
from a critical application, and I think daily backups that I could recover
from in case of a disaster are more than good enough.</p>
<h3 id="challenge-6-upgrading-vue-managing-forms">challenge 6: upgrading Vue &amp; managing forms</h3>
<p>This has nothing to do with PowerDNS but I decided to upgrade Vue.js from
version 2 to 3 as part of this refresh. The main problem with that is that the
form validation library I was using (FormKit) completely changed its API
between Vue 2 and Vue 3, so I decided to just stop using it instead of learning
the new API.</p>
<p>I ended up switching to some form validation tools that are built into the
browser like <code>required</code> and <code>oninvalid</code> (<a href="https://github.com/jvns/mess-with-dns/blob/90f7a2d2982c8151a3ddcab532bc1db07a043f84/frontend/components/NewRecord.html#L5-L8">here&rsquo;s the code</a>).
I think it could use some of improvement, I still don&rsquo;t understand forms very well.</p>
<h3 id="challenge-7-managing-state-in-the-frontend">challenge 7: managing state in the frontend</h3>
<p>This also has nothing to do with PowerDNS, but when modifying the frontend I
realized that my state management in the frontend was a mess &ndash; in every place
where I made an API request to the backend, I had to try to remember to add a
&ldquo;refresh records&rdquo; call after that in every place that I&rsquo;d modified the state
and I wasn&rsquo;t always consistent about it.</p>
<p>With some more advice from Marco, I ended up implementing a single global
<a href="https://github.com/jvns/mess-with-dns/blob/90f7a2d2982c8151a3ddcab532bc1db07a043f84/frontend/store.ts#L32-L44">state management store</a>
which stores all the state for the application, and which lets me
create/update/delete records.</p>
<p>Then my components can just call <code>store.createRecord(record)</code>, and the store
will automatically resynchronize all of the state as needed.</p>
<h3 id="challenge-8-sequencing-the-project">challenge 8: sequencing the project</h3>
<p>This project ended up having several steps because I reworked the whole
integration between the frontend and the backend. I ended up splitting it into
a few different phases:</p>
<ol>
<li>Upgrade Vue from v2 to v3</li>
<li>Make the state management store</li>
<li>Implement a different backend API, move a lot of DNS logic out of the frontend, and add tests for the backend</li>
<li>Integrate PowerDNS</li>
</ol>
<p>I made sure that the website was (more or less) 100% working and then deployed
it in between phases, so that the amount of changes I was managing at a time
stayed somewhat under control.</p>
<h3 id="the-new-website-is-up-now">the new website is up now!</h3>
<p>I released the upgraded website a few days ago and it seems to work!
The PowerDNS API has been great to work on top of, and I&rsquo;m relieved that
there&rsquo;s a whole class of problems that I now don&rsquo;t have to think about at all,
other than potentially trying to make the error messages from PowerDNS a little
clearer. Using PowerDNS has fixed a lot of the DNS issues that folks have
reported in the last few years and it feels great.</p>
<p>If you run into problems with the new Mess With DNS I&rsquo;d love to <a href="https://github.com/jvns/mess-with-dns/issues/">hear about them here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go structs are copied on assignment (and other things about Go I'd missed)]]></title>
    <link href="https://jvns.ca/blog/2024/08/06/go-structs-copied-on-assignment/"/>
    <updated>2024-08-06T08:38:35+00:00</updated>
    <id>https://jvns.ca/blog/2024/08/06/go-structs-copied-on-assignment/</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been writing Go pretty casually for years &ndash; the backends for all of my
playgrounds (<a href="https://nginx-playground.wizardzines.com/">nginx</a>, <a href="https://messwithdns.net/">dns</a>, <a href="https://memory-spy.wizardzines.com/">memory</a>, <a href="https://dns-lookup.jvns.ca/">more DNS</a>) are written in Go, but many of those projects are just a few hundred lines and I don&rsquo;t come back to those codebases much.</p>
<p>I thought I more or less understood the basics of the language, but this week
I&rsquo;ve been writing a lot more Go than usual while working on some upgrades to
<a href="https://messwithdns.net">Mess with DNS</a>, and ran into a bug that revealed I
was missing a very basic concept!</p>
<p>Then I posted about this on Mastodon and someone linked me to this very cool
site (and book) called <a href="https://100go.co">100 Go Mistakes and How To Avoid Them</a> by <a href="https://teivah.dev/">Teiva Harsanyi</a>. It just came out in 2022 so it&rsquo;s relatively new.</p>
<p>I decided to read through the site to see what <em>else</em> I was missing, and found
a couple of other misconceptions I had about Go. I&rsquo;ll talk about some of the
mistakes that jumped out to me the most, but really the whole
<a href="https://100go.co/">100 Go Mistakes</a> site is great and I&rsquo;d recommend reading it.</p>
<p>Here&rsquo;s the initial mistake that started me on this journey:</p>
<h3 id="mistake-1-not-understanding-that-structs-are-copied-on-assignment">mistake 1: not understanding that structs are copied on assignment</h3>
<p>Let&rsquo;s say we have a struct:</p>
<pre><code>type Thing struct {
    Name string
}
</code></pre>
<p>and this code:</p>
<pre><code>thing := Thing{&quot;record&quot;}
other_thing := thing
other_thing.Name = &quot;banana&quot;
fmt.Println(thing)
</code></pre>
<p>This prints &ldquo;record&rdquo; and not &ldquo;banana&rdquo; (<a href="https://go.dev/play/p/kUeP2ocFtXw">play.go.dev link</a>), because <code>thing</code> is copied when you
assign it to <code>other_thing</code>.</p>
<h3 id="the-problem-this-caused-me-ranges">the problem this caused me: ranges</h3>
<p>The bug I spent 2 hours of my life debugging last week was effectively this code (<a href="https://go.dev/play/p/85FnGG86UBP">play.go.dev link</a>):</p>
<pre><code>type Thing struct {
  Name string
}
func findThing(things []Thing, name string) *Thing {
  for _, thing := range things {
    if thing.Name == name {
      return &amp;thing
    }
  }
  return nil
}

func main() {
  things := []Thing{Thing{&quot;record&quot;}, Thing{&quot;banana&quot;}}
  thing := findThing(things, &quot;record&quot;)
  thing.Name = &quot;gramaphone&quot;
  fmt.Println(things)
}
</code></pre>
<p>This prints out <code>[{record} {banana}]</code> &ndash; because <code>findThing</code> returned a copy, we didn&rsquo;t change the name in the original array.</p>
<p>This mistake is <a href="https://100go.co/#ignoring-that-elements-are-copied-in-range-loops-30">#30 in 100 Go Mistakes</a>.</p>
<p>I fixed the bug by changing it to something like this (<a href="https://go.dev/play/p/CKZCRUwv_nG">play.go.dev link</a>), which returns a
reference to the item in the array we&rsquo;re looking for instead of a copy.</p>
<pre><code>func findThing(things []Thing, name string) *Thing {
  for i := range things {
    if things[i].Name == name {
      return &amp;things[i]
    }
  }
  return nil
}
</code></pre>
<h3 id="why-didn-t-i-realize-this">why didn&rsquo;t I realize this?</h3>
<p>When I learned that I was mistaken about how assignment worked in Go I was
really taken aback, like &ndash; it&rsquo;s such a basic fact about the language works!
If I was wrong about that then what ELSE am I wrong about in Go????</p>
<p>My best guess for what happened is:</p>
<ol>
<li>I&rsquo;ve heard for my whole life that when you define a function,
you need to think about whether its arguments are passed by <strong>reference</strong> or
by <strong>value</strong></li>
<li>So I&rsquo;d thought about this in Go, and I knew that if you pass a struct as a
value to a function, it gets copied &ndash; if you want to pass a reference then
you have to pass a pointer</li>
<li>But somehow it never occurred to me that you need to think about the same
thing for <strong>assignments</strong>, perhaps because in most of the other languages I
use (Python, JS, Java) I think everything is a reference anyway. Except for
in Rust, where you do have values that you make copies of but I think most of the time I had to run <code>.clone()</code> explicitly.
(though apparently structs will be automatically copied on assignment if the struct implements the <code>Copy</code> trait)</li>
<li>Also obviously I just don&rsquo;t write that much Go so I guess it&rsquo;s never come
up.</li>
</ol>
<h3 id="mistake-2-side-effects-appending-slices-25-https-100go-co-unexpected-side-effects-using-slice-append-25">mistake 2: side effects appending slices (<a href="https://100go.co/#unexpected-side-effects-using-slice-append-25">#25</a>)</h3>
<p>When you subset a slice with <code>x[2:3]</code>, the original slice and the sub-slice
share the same backing array, so if you append to the new slice, it can
unintentionally change the old slice:</p>
<p>For example, this code prints <code>[1 2 3 555 5]</code> (<a href="https://go.dev/play/p/qssfM_NSXJD">code on play.go.dev</a>)</p>
<pre><code>x := []int{1, 2, 3, 4, 5}
y := x[2:3]
y = append(y, 555)
fmt.Println(x)
</code></pre>
<p>I don&rsquo;t think this has ever actually happened to me, but it&rsquo;s alarming and I&rsquo;m
very happy to know about it.</p>
<p>Apparently you can avoid this problem by changing <code>y := x[2:3]</code> to <code>y := x[2:3:3]</code>, which restricts the new slice&rsquo;s capacity so that appending to it
will re-allocate a new slice. Here&rsquo;s some <a href="https://go.dev/play/p/aE78JUL4-Iv">code on play.go.dev</a> that does that.</p>
<h3 id="mistake-3-not-understanding-the-different-types-of-method-receivers-42">mistake 3: not understanding the different types of method receivers (#42)</h3>
<p>This one isn&rsquo;t a &ldquo;mistake&rdquo; exactly, but it&rsquo;s been a source of confusion for me
and it&rsquo;s pretty simple so I&rsquo;m glad to have it cleared up.</p>
<p>In Go you can declare methods in 2 different ways:</p>
<ol>
<li><code>func (t Thing) Function()</code> (a &ldquo;value receiver&rdquo;)</li>
<li><code>func (t *Thing) Function()</code> (a &ldquo;pointer receiver&rdquo;)</li>
</ol>
<p>My understanding now is that basically:</p>
<ul>
<li>If you want the method to mutate the struct <code>t</code>, you need a pointer receiver.</li>
<li>If you want to make sure the method <strong>doesn&rsquo;t</strong> mutate the struct <code>t</code>, use a value receiver.</li>
</ul>
<p><a href="https://100go.co/#not-knowing-which-type-of-receiver-to-use-42">Explanation #42</a> has a
bunch of other interesting details though. There&rsquo;s definitely still something
I&rsquo;m missing about value vs pointer receivers (I got a compile error related to
them a couple of times in the last week that I still don&rsquo;t understand), but
hopefully I&rsquo;ll run into that error again soon and I can figure it out.</p>
<h3 id="more-interesting-things-i-noticed">more interesting things I noticed</h3>
<p>Some more notes from 100 Go Mistakes:</p>
<ul>
<li>apparently you can <a href="https://100go.co/#never-using-named-result-parameters-43">name the outputs of your function (#43)</a>, though that can have <a href="https://100go.co/#unintended-side-effects-with-named-result-parameters-44">issues (#44)</a> and I&rsquo;m not sure I want to</li>
<li><a href="https://100go.co/#not-exploring-all-the-go-testing-features-90">apparently you can put tests in a different package (#90)</a> to
ensure that you only use the package&rsquo;s public interfaces, which seems really
useful</li>
<li>there are a lots of notes about how to use contexts, channels, goroutines,
mutexes, sync.WaitGroup, etc. I&rsquo;m sure I have something to learn about all of
those but today is not the day I&rsquo;m going to learn them.</li>
</ul>
<p>Also there are some things that have tripped me up in the past, like:</p>
<ul>
<li><a href="https://100go.co/#forgetting-the-return-statement-after-replying-to-an-http-request-80">forgetting the return statement after replying to an HTTP request (#80)</a></li>
<li><a href="https://100go.co/#not-using-testing-utility-packages-httptest-and-iotest-88">not realizing the httptest package exists (#88)</a></li>
</ul>
<h3 id="this-100-common-mistakes-format-is-great">this &ldquo;100 common mistakes&rdquo; format is great</h3>
<p>I really appreciated this &ldquo;100 common mistakes&rdquo; format &ndash; it made it really
easy for me to skim through the mistakes and very quickly mentally classify
them into:</p>
<ol>
<li>yep, I know that</li>
<li>not interested in that one right now</li>
<li>WOW WAIT I DID NOT KNOW THAT, THAT IS VERY USEFUL!!!!</li>
</ol>
<p>It looks like &ldquo;100 Common Mistakes&rdquo; is a series of books from Manning and they
also have &ldquo;100 Java Mistakes&rdquo; and an upcoming &ldquo;100 SQL Server Mistakes&rdquo;.</p>
<p>Also I enjoyed what I&rsquo;ve read of <a href="https://effectivepython.com/">Effective Python</a> by Brett Slatkin, which has a similar &ldquo;here are a bunch of
short Python style tips&rdquo; structure where you can quickly skim it and take
what&rsquo;s useful to you. There&rsquo;s also Effective C++, Effective Java, and probably
more.</p>
<h3 id="some-other-go-resources">some other Go resources</h3>
<p>other resources I&rsquo;ve appreciated:</p>
<ul>
<li><a href="https://gobyexample.com/">Go by example</a> for basic syntax</li>
<li><a href="https://go.dev/play/">go.dev/play</a></li>
<li>obviously <a href="https://pkg.go.dev">https://pkg.go.dev</a> for documentation about literally everything</li>
<li><a href="https://staticcheck.dev/">staticcheck</a> seems like a useful linter &ndash; for
example I just started using it to tell me when I&rsquo;ve forgotten to handle an
error</li>
<li>apparently <a href="https://golangci-lint.run/">golangci-lint</a> includes a bunch of different linters</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Entering text in the terminal is complicated]]></title>
    <link href="https://jvns.ca/blog/2024/07/08/readline/"/>
    <updated>2024-07-08T13:00:15+00:00</updated>
    <id>https://jvns.ca/blog/2024/07/08/readline/</id>
    <content type="html"><![CDATA[<p>The other day I asked what folks on Mastodon find confusing about working in
the terminal, and one thing that stood out to me was &ldquo;editing a command you
already typed in&rdquo;.</p>
<p>This really resonated with me: even though entering some text and editing it is
a very &ldquo;basic&rdquo; task, it took me maybe 15 years of using the terminal every
single day to get used to using <code>Ctrl+A</code> to go to the beginning of the line (or
<code>Ctrl+E</code> for the end &ndash; I think I used <code>Home</code>/<code>End</code> instead).</p>
<p>So let&rsquo;s talk about why entering text might be hard! I&rsquo;ll also share a few tips
that I wish I&rsquo;d learned earlier.</p>
<h3 id="it-s-very-inconsistent-between-programs">it&rsquo;s very inconsistent between programs</h3>
<p>A big part of what makes entering text in the terminal hard is the
inconsistency between how different programs handle entering text. For example:</p>
<ol>
<li>some programs (<code>cat</code>, <code>nc</code>, <code>git commit --interactive</code>, etc) don&rsquo;t support using arrow keys at all: if you press arrow keys, you&rsquo;ll just see <code>^[[D^[[D^[[C^[[C^</code></li>
<li>many programs (like <code>irb</code>, <code>python3</code> on a Linux machine and many many more) use the <code>readline</code> library, which gives you a lot of basic functionality (history, arrow keys, etc)</li>
<li>some programs (like <code>/usr/bin/python3</code> on my Mac) do support very basic features like arrow keys, but not other features like <code>Ctrl+left</code> or reverse searching with <code>Ctrl+R</code></li>
<li>some programs (like the <code>fish</code> shell or <code>ipython3</code> or <code>micro</code> or <code>vim</code>) have their own fancy system for accepting input which is totally custom</li>
</ol>
<p>So there&rsquo;s a lot of variation! Let&rsquo;s talk about each of those a little more.</p>
<h3 id="mode-1-the-baseline">mode 1: the baseline</h3>
<p>First, there&rsquo;s &ldquo;the baseline&rdquo; &ndash; what happens if a program just accepts text by
calling <code>fgets()</code> or whatever and doing absolutely nothing else to provide a
nicer experience. Here&rsquo;s what using these tools typically looks for me &ndash; If I
start the version of <a href="https://wiki.archlinux.org/title/Dash">dash</a> installed on
my machine (a pretty minimal shell) press the left arrow keys, it just prints
<code>^[[D</code> to the terminal.</p>
<pre><code>$ ls l-^[[D^[[D^[[D
</code></pre>
<p>At first it doesn&rsquo;t seem like all of these &ldquo;baseline&rdquo; tools have much in
common, but there are actually a few features that you get for free just from
your terminal, without the program needing to do anything special at all.</p>
<p>The things you get for free are:</p>
<ol>
<li>typing in text, obviously</li>
<li>backspace</li>
<li><code>Ctrl+W</code>, to delete the previous word</li>
<li><code>Ctrl+U</code>, to delete the whole line</li>
<li>a few other things unrelated to text editing (like <code>Ctrl+C</code> to interrupt the process, <code>Ctrl+Z</code> to suspend, etc)</li>
</ol>
<p>This is not <em>great</em>, but it means that if you want to delete a word you
generally can do it with <code>Ctrl+W</code> instead of pressing backspace 15 times, even
if you&rsquo;re in an environment which is offering you absolutely zero features.</p>
<p>You can get a list of all the ctrl codes that your terminal supports with <code>stty -a</code>.</p>
<h3 id="mode-2-tools-that-use-readline">mode 2: tools that use <code>readline</code></h3>
<p>The next group is tools that use readline! Readline is a GNU library to make
entering text more pleasant, and it&rsquo;s very widely used.</p>
<p>My favourite readline keyboard shortcuts are:</p>
<ol>
<li><code>Ctrl+E</code> (or <code>End</code>) to go to the end of the line</li>
<li><code>Ctrl+A</code> (or <code>Home</code>) to go to the beginning of the line</li>
<li><code>Ctrl+left/right arrow</code> to go back/forward 1 word</li>
<li>up arrow to go back to the previous command</li>
<li><code>Ctrl+R</code> to search your history</li>
</ol>
<p>And you can use <code>Ctrl+W</code> / <code>Ctrl+U</code> from the &ldquo;baseline&rdquo; list, though <code>Ctrl+U</code>
deletes from the cursor to the beginning of the line instead of deleting the
whole line. I think <code>Ctrl+W</code> might also have a slightly different definition of
what a &ldquo;word&rdquo; is.</p>
<p>There are a lot more (<a href="https://www.man7.org/linux/man-pages/man3/readline.3.html#EDITING_COMMANDS">here&rsquo;s a full list</a>), but those are the only ones that I personally use.</p>
<p>The <code>bash</code> shell is probably the most famous readline user (when you use
<code>Ctrl+R</code> to search your history in bash, that feature actually comes from
readline), but there are TONS of programs that use it &ndash; for example <code>psql</code>,
<code>irb</code>, <code>python3</code>, etc.</p>
<h3 id="tip-you-can-make-anything-use-readline-with-rlwrap">tip: you can make ANYTHING use readline with <code>rlwrap</code></h3>
<p>One of my absolute favourite things is that if you have a program like <code>nc</code>
without readline support, you can just run <code>rlwrap nc</code> to turn it into a
program with readline support!</p>
<p>This is incredible and makes a lot of tools that are borderline unusable MUCH
more pleasant to use. You can even apparently set up <a href="https://github.com/hanslub42/rlwrap">rlwrap</a> to include your own
custom autocompletions, though I&rsquo;ve never tried that.</p>
<h3 id="some-reasons-tools-might-not-use-readline">some reasons tools might not use readline</h3>
<p>I think reasons tools might not use readline might include:</p>
<ul>
<li>the program is very simple (like <code>cat</code> or <code>nc</code>) and maybe the maintainers don&rsquo;t want to bring in a relatively large dependency</li>
<li>license reasons, if the program&rsquo;s license is not GPL-compatible &ndash; readline is GPL-licensed, not LGPL</li>
<li>only a very small part of the program is interactive, and maybe readline
support isn&rsquo;t seen as important. For example <code>git</code> has a few interactive
features (like <code>git add -p</code>), but not very many, and usually you&rsquo;re just
typing a single character like <code>y</code> or <code>n</code> &ndash; most of the time you need to really
type something significant in git, it&rsquo;ll drop you into a text editor instead.</li>
</ul>
<p>For example idris2 says <a href="https://idris2.readthedocs.io/en/latest/tutorial/interactive.html#editing-at-the-repl">they don&rsquo;t use readline</a>
to keep dependencies minimal and suggest using <code>rlwrap</code> to get better
interactive features.</p>
<h3 id="how-to-know-if-you-re-using-readline">how to know if you&rsquo;re using readline</h3>
<p>The simplest test I can think of is to press <code>Ctrl+R</code>, and if you see:</p>
<pre><code>(reverse-i-search)`':
</code></pre>
<p>then you&rsquo;re probably using readline. This obviously isn&rsquo;t a guarantee (some
other library could use the term <code>reverse-i-search</code> too!), but I don&rsquo;t know of
another system that uses that specific term to refer to searching history.</p>
<h3 id="the-readline-keybindings-come-from-emacs">the readline keybindings come from Emacs</h3>
<p>Because I&rsquo;m a vim user, It took me a very long time to understand where these
keybindings come from (why <code>Ctrl+A</code> to go to the beginning of a line??? so
weird!)</p>
<p>My understanding is these keybindings actually come from Emacs &ndash; <code>Ctrl+A</code> and
<code>Ctrl+E</code> do the same thing in Emacs as they do in Readline and I assume the
other keyboard shortcuts mostly do as well, though I tried out <code>Ctrl+W</code> and
<code>Ctrl+U</code> in Emacs and they don&rsquo;t do the same thing as they do in the terminal
so I guess there are some differences.</p>
<p>There&rsquo;s some more <a href="https://twobithistory.org/2019/08/22/readline.html">history of the Readline project here</a>.</p>
<h3 id="mode-3-another-input-library-like-libedit">mode 3: another input library (like <code>libedit</code>)</h3>
<p>On my Mac laptop, <code>/usr/bin/python3</code> is in a weird middle ground where it
supports <em>some</em> readline features (for example the arrow keys), but not the
other ones. For example when I press <code>Ctrl+left arrow</code>, it prints out <code>;5D</code>,
like this:</p>
<pre><code>$ python3
&gt;&gt;&gt; importt subprocess;5D
</code></pre>
<p>Folks on Mastodon helped me figure out that this is because in the default
Python install on Mac OS, the Python <code>readline</code> module is actually backed by
<code>libedit</code>, which is a similar library which has fewer features, presumably
because Readline is <a href="https://en.wikipedia.org/wiki/GNU_Readline#Choice_of_the_GPL_as_GNU_Readline's_license">GPL licensed</a>.</p>
<p>Here&rsquo;s how I was eventually able to figure out that Python was using libedit on
my system:</p>
<pre><code>$ python3 -c &quot;import readline; print(readline.__doc__)&quot;
Importing this module enables command line editing using libedit readline.
</code></pre>
<p>Generally Python uses readline though if you install it on Linux or through
Homebrew. It&rsquo;s just that the specific version that Apple includes on their
systems doesn&rsquo;t have readline. Also <a href="https://docs.python.org/3.13/whatsnew/3.13.html#a-better-interactive-interpreter">Python 3.13 is going to remove the readline dependency</a>
in favour of a custom library, so &ldquo;Python uses readline&rdquo; won&rsquo;t be true in the
future.</p>
<p>I assume that there are more programs on my Mac that use libedit but I haven&rsquo;t
looked into it.</p>
<h3 id="mode-4-something-custom">mode 4: something custom</h3>
<p>The last group of programs is programs that have their own custom (and sometimes
much fancier!) system for editing text. This includes:</p>
<ul>
<li>most terminal text editors (nano, micro, vim, emacs, etc)</li>
<li>some shells (like fish), for example it seems like fish supports <code>Ctrl+Z</code> for undo when typing in a command. Zsh&rsquo;s line editor is called <a href="https://zsh.sourceforge.io/Guide/zshguide04.html">zle</a>.</li>
<li>some REPLs (like <code>ipython</code>), for example IPython uses the <a href="https://python-prompt-toolkit.readthedocs.io/">prompt_toolkit</a> library instead of readline</li>
<li>lots of other programs (like <code>atuin</code>)</li>
</ul>
<p>Some features you might see are:</p>
<ul>
<li>better autocomplete which is more customized to the tool</li>
<li>nicer history management (for example with syntax highlighting) than the default you get from readline</li>
<li>more keyboard shortcuts</li>
</ul>
<h3 id="custom-input-systems-are-often-readline-inspired">custom input systems are often readline-inspired</h3>
<p>I went looking at how <a href="https://atuin.sh/">Atuin</a> (a wonderful tool for
searching your shell history that I started using recently) handles text input.
Looking at <a href="https://github.com/atuinsh/atuin/blob/a67cfc82fe0dc907a01f07a0fd625701e062a33b/crates/atuin/src/command/client/search/interactive.rs#L382-L430">the code</a>
and some of the discussion around it, their implementation is custom but it&rsquo;s
inspired by readline, which makes sense to me &ndash; a lot of users are used to
those keybindings, and it&rsquo;s convenient for them to work even though atuin
doesn&rsquo;t use readline.</p>
<p><a href="https://python-prompt-toolkit.readthedocs.io/">prompt_toolkit</a> (the library
IPython uses) is similar &ndash; it actually supports a lot of options (including
vi-like keybindings), but the default is to support the readline-style
keybindings.</p>
<p>This is like how you see a lot of programs which support very basic vim
keybindings (like <code>j</code> for down and <code>k</code> for up). For example Fastmail supports
<code>j</code> and <code>k</code> even though most of its other keybindings don&rsquo;t have much
relationship to vim.</p>
<p>I assume that most &ldquo;readline-inspired&rdquo; custom input systems have various subtle
incompatibilities with readline, but this doesn&rsquo;t really bother me at all
personally because I&rsquo;m extremely ignorant of most of readline&rsquo;s features. I only use
maybe 5 keyboard shortcuts, so as long as they support the 5 basic commands I
know (which they always do!) I feel pretty comfortable. And usually these
custom systems have much better autocomplete than you&rsquo;d get from just using
readline, so generally I prefer them over readline.</p>
<h3 id="lots-of-shells-support-vi-keybindings">lots of shells support vi keybindings</h3>
<p>Bash, zsh, and fish all have a &ldquo;vi mode&rdquo; for entering text. In a
<a href="https://social.jvns.ca/@b0rk/112723846172173621">very unscientific poll</a> I ran on
Mastodon, 12% of people said they use it, so it seems pretty popular.</p>
<p>Readline also has a &ldquo;vi mode&rdquo; (which is how Bash&rsquo;s support for it works), so by
extension lots of other programs have it too.</p>
<p>I&rsquo;ve always thought that vi mode seems really cool, but for some reason even
though I&rsquo;m a vim user it&rsquo;s never stuck for me.</p>
<h3 id="understanding-what-situation-you-re-in-really-helps">understanding what situation you&rsquo;re in really helps</h3>
<p>I&rsquo;ve spent a lot of my life being confused about why a command line application
I was using wasn&rsquo;t behaving the way I wanted, and it feels good to be able to
more or less understand what&rsquo;s going on.</p>
<p>I think this is roughly my mental flowchart when I&rsquo;m entering text at a command
line prompt:</p>
<ol>
<li>Do the arrow keys not work? Probably there&rsquo;s no input system at all, but at
least I can use <code>Ctrl+W</code> and <code>Ctrl+U</code>, and I can <code>rlwrap</code> the tool if I
want more features.</li>
<li>Does <code>Ctrl+R</code> print <code>reverse-i-search</code>? Probably it&rsquo;s readline, so I can use
all of the readline shortcuts I&rsquo;m used to, and I know I can get some basic
history and press up arrow to get the previous command.</li>
<li>Does <code>Ctrl+R</code> do something else? This is probably some custom input library:
it&rsquo;ll probably act more or less like readline, and I can check the
documentation if I really want to know how it works.</li>
</ol>
<p>Being able to diagnose what&rsquo;s going on like this makes the command line feel a
more predictable and less chaotic.</p>
<h3 id="some-things-this-post-left-out">some things this post left out</h3>
<p>There are lots more complications related to entering text that we didn&rsquo;t talk
about at all here, like:</p>
<ul>
<li>issues related to ssh / tmux / etc</li>
<li>the <code>TERM</code> environment variable</li>
<li>how different terminals (gnome terminal, iTerm, xterm, etc) have different kinds of support for copying/pasting text</li>
<li>unicode</li>
<li>probably a lot more</li>
</ul>
]]></content>
  </entry>
  
</feed>
